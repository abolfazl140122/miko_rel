<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡Ù…ÛŒØ§Ø± - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --danger-color: #dc3545; --body-bg: #f0f2f5; --header-bg: #ffffff; --border-color: #dee2e6; }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; background-color: var(--body-bg); color: #333; -webkit-user-select: none; user-select: none; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .app-container { width: 100%; height: 100%; max-width: 450px; background-color: white; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .app-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--header-bg); flex-shrink: 0; }
        .app-header h1 { font-size: 1.4em; margin: 0; font-weight: 700; color: var(--primary-color); }
        .app-header button { background: var(--danger-color); border: none; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-family: 'Vazirmatn'; transition: background-color 0.2s; }
        .app-header button:hover { background-color: #c82333; }
        main { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .view { display: none; height: 100%; width: 100%; flex-direction: column; }
        .view.active { display: flex; }
        #card-view { justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .status-message { font-size: 1.1em; color: #6c757d; }
        #conversation-list { padding-top: 8px; }
        .conversation-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .conversation-item:hover { background-color: #f8f9fa; }
        .conversation-item img { width: 50px; height: 50px; border-radius: 50%; margin-left: 15px; }
        .conversation-item h3 { margin: 0; font-size: 1.1em; font-weight: 500; }
        .main-footer { padding: 5px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; background-color: var(--header-bg); }
        .nav-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: #adb5bd; transition: color 0.2s; padding: 10px 20px; }
        .nav-btn.active { color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Ù‡Ù…ÛŒØ§Ø±</h1>
            <button id="logout-btn">Ø®Ø±ÙˆØ¬</button>
        </header>

        <main>
            <div id="card-view" class="view active">
                <div id="status-message" class="status-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</div>
            </div>
            <div id="chat-view" class="view">
                <div id="conversation-list"></div>
            </div>
        </main>

        <footer class="main-footer">
            <button class="nav-btn" id="nav-chat-btn">ğŸ’¬</button>
            <button class="nav-btn active" id="nav-cards-btn">ğŸƒ</button>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234'; // <-- !!! Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø³Ø±ÙˆØ± ÛŒÚ©ÛŒ Ø¨Ø§Ø´Ø¯

        // --- DOM Elements ---
        const cardView = document.getElementById('card-view');
        const chatView = document.getElementById('chat-view');
        const statusMessage = document.getElementById('status-message');
        const logoutBtn = document.getElementById('logout-btn');
        const navCardsBtn = document.getElementById('nav-cards-btn');
        const navChatBtn = document.getElementById('nav-chat-btn');
        const conversationList = document.getElementById('conversation-list');

        // --- App State ---
        let currentUser = null;
        let clientToken = null;
        let allUsersData = {}; 

        // --- AUTH & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(storedUser);

            setupEventListeners();
            await initializeApp();
        });

        async function initializeApp() {
            try {
                // 1. Ø§ÙˆÙ„ÛŒÙ† Ùˆ Ù…Ù‡Ù…â€ŒØªØ±ÛŒÙ† Ú©Ø§Ø±: Ú¯Ø±ÙØªÙ† ØªÙˆÚ©Ù† Ø§Ø² Ù¾Ø±Ø§Ú©Ø³ÛŒ
                await refreshClientToken();
                console.log("Client token received successfully.");

                // 2. ÙˆØ§Ú©Ø´ÛŒ ØªÙ…Ø§Ù… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ù„ÛŒØ³Øª ØªØ·Ø§Ø¨Ù‚â€ŒÙ‡Ø§ (Matches)
                const [allUsers, matches] = await Promise.all([
                    fetchAllUsers(),
                    fetchMatches()
                ]);

                allUsers.forEach(user => { allUsersData[user.username] = user; });
                
                // 3. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ù…Ø§Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                initializeCardsView(allUsers);
                renderConversationList(matches);
            } catch (error) {
                console.error("Initialization Error:", error);
                statusMessage.textContent = `Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡: ${error.message}`;
                alert(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ${error.message}`);
            }
        }

        function setupEventListeners() {
            navCardsBtn.addEventListener('click', () => showView('cards'));
            navChatBtn.addEventListener('click', () => showView('chat'));
            logoutBtn.addEventListener('click', logout);
        }

        // --- VIEW LOGIC ---
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (viewName === 'cards') {
                cardView.classList.add('active');
                navCardsBtn.classList.add('active');
            } else {
                chatView.classList.add('active');
                navChatBtn.classList.add('active');
            }
        }

        function initializeCardsView(allUsers) {
            // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ ÙÙ‚Ø· ÛŒÚ© Ù¾ÛŒØ§Ù… Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ….
            const otherUsersCount = allUsers.filter(u => u.uid !== currentUser.uid).length;
            if (otherUsersCount > 0) {
                statusMessage.textContent = `${otherUsersCount} Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÛŒØ§ÙØª Ø´Ø¯.`;
            } else {
                statusMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            }
        }

        function renderConversationList(matches) {
            conversationList.innerHTML = '';
            if (matches.length === 0) {
                conversationList.innerHTML = '<div class="status-message" style="padding: 20px;">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ØªØ·Ø§Ø¨Ù‚ÛŒ Ù†Ø¯Ø§Ø±ÛŒ!</div>';
                return;
            }
            matches.forEach(user => {
                if (!user) return;
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.innerHTML = `
                    <img src="https://i.pravatar.cc/100?u=${user.username}" alt="${user.displayName}">
                    <h3>${user.displayName}</h3>`;
                
                item.addEventListener('click', () => {
                    // Ù…Ù‡Ù…: Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„
                    window.location.href = `pivi.html?with=${user.username}`;
                });
                conversationList.appendChild(item);
            });
        }

        // --- DATA FETCHING ---
        async function refreshClientToken() {
            // Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† ØªÙˆÚ©Ù†ØŒ Ø¨Ø§ÛŒØ¯ Ù‡Ø¯Ø± Ø§Ù…Ù† Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒÙ…
            clientToken = await apiRequest('?auth=token', 'GET', null, { 'X-Proxy-Secret': SHARED_SECRET });
            if (!clientToken || !clientToken.token) throw new Error("Could not retrieve a valid client token.");
            localStorage.setItem('clientToken', clientToken.token); // Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù† Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± ØµÙØ­Ø§Øª Ø¯ÛŒÚ¯Ø±
        }

        async function fetchAllUsers() {
            const data = await apiRequest('?path=users', 'GET');
            return data ? Object.values(data) : [];
        }

        async function fetchMatches() {
            // Ù…Ù†Ø·Ù‚ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Match: Ú©Ø³Ø§Ù†ÛŒ Ú©Ù‡ Ù…Ù† Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù‡â€ŒØ§Ù… Ùˆ Ø¢Ù†â€ŒÙ‡Ø§ Ù‡Ù… Ù…Ù† Ø±Ø§ Ù„Ø§ÛŒÚ© Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯
            const myInteractions = await apiRequest(`?path=interactions/${currentUser.uid}`, 'GET') || {};
            const myLikedUids = Object.keys(myInteractions).filter(uid => myInteractions[uid] === 'liked');

            if (myLikedUids.length === 0) return [];
            
            const matchPromises = myLikedUids.map(async likedUid => {
                const theirInteraction = await apiRequest(`?path=interactions/${likedUid}/${currentUser.uid}`, 'GET');
                if (theirInteraction === 'liked') {
                    // Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒØ¯Ø§ Ø´Ø¯! Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø§Ùˆ Ø±Ø§ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†ÛŒÙ…
                    return await apiRequest(`?path=users/${likedUid}`, 'GET');
                }
                return null;
            });
            return (await Promise.all(matchPromises)).filter(Boolean); // Ø­Ø°Ù Ù…Ù‚Ø§Ø¯ÛŒØ± null
        }

        // --- API HELPER ---
        async function apiRequest(url, method, body = null, extraHeaders = {}) {
            const token = localStorage.getItem('clientToken');
            const headers = {
                'Content-Type': 'application/json',
                ...extraHeaders
            };
            if (token && !url.includes('auth=token')) {
                 headers['Authorization'] = `Bearer ${token}`;
            }

            const options = { method, headers };
            
            // **Ù…Ù‡Ù…**: UID Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ù¾Ø±Ø§Ú©Ø³ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (body) {
                body.auth_override_uid = currentUser.uid;
                options.body = JSON.stringify(body);
            } else if (method !== 'GET') {
                options.body = JSON.stringify({ auth_override_uid: currentUser.uid });
            }

            // Ø¨Ø±Ø§ÛŒ GETØŒ Ø¨Ø§ÛŒØ¯ UID Ø±Ø§ Ø¯Ø± URL Ø¨ÙØ±Ø³ØªÛŒÙ…ØŒ Ø§Ù…Ø§ Ù¾Ø±Ø§Ú©Ø³ÛŒ Ù…Ø§ Ø¢Ù† Ø±Ø§ Ø§Ø² body Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯.
            // Ù¾Ø³ Ù…Ø§ Ù‡Ù…ÙˆØ§Ø±Ù‡ ÛŒÚ© body Ø­Ø¯Ø§Ù‚Ù„ÛŒ Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒÙ… (Ù¾Ø±Ø§Ú©Ø³ÛŒ Ù…Ø§ Ù‡ÙˆØ´Ù…Ù†Ø¯Ø§Ù†Ù‡ Ø¹Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯).
            // Ø§ÛŒÙ† Ø±ÙˆÛŒÚ©Ø±Ø¯ Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø§Ø³Øª.

            const response = await fetch(`${PROXY_URL}${url}`, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'An unknown error occurred' }));
                console.error(`API Error on ${url}:`, response.status, errorData);
                throw new Error(errorData.error || `HTTP Error: ${response.status}`);
            }
            return response.status === 204 ? null : response.json();
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
