<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‡Ù…ÛŒØ§Ø± - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --danger-color: #e74c3c; --light-gray-color: #f8f9fa; --border-color: #dee2e6; --sent-bg: #e1f5fe; --received-bg: #f1f3f5; }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; background-color: var(--light-gray-color); color: #333; -webkit-user-select: none; user-select: none; }

        .app-container { width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background-color: white; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        /* Header */
        .app-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { font-size: 1.5em; margin: 0; color: var(--primary-color); }
        .app-header button { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-family: 'Vazirmatn'; transition: background-color 0.2s, color 0.2s; }
        .app-header button:hover { background-color: var(--danger-color); color: white; }

        /* Main Content Area */
        main { flex-grow: 1; position: relative; overflow-y: auto; }

        /* Card Swiping View */
        .card-view { height: 100%; padding: 20px; display: flex; justify-content: center; align-items: center; position: relative; }
        .profile-card { /* ... styles from original file ... */ }
        .status-message { font-size: 1.2em; color: #aaa; text-align: center; padding: 20px; }
        
        /* Chat Views */
        .chat-view { height: 100%; display: none; /* Hidden by default */ flex-direction: column; }
        
        /* --- NEW: Search Container --- */
        #search-container {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #search-user-input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            font-family: 'Vazirmatn';
            font-size: 1em;
        }
        #search-results {
            padding: 0 10px;
        }
        /* --- END NEW --- */


        /* Conversation List */
        #conversation-list { padding: 10px 0; }
        .conversation-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .conversation-item:hover { background-color: var(--light-gray-color); }
        .conversation-item img { width: 50px; height: 50px; border-radius: 50%; margin-left: 15px; }
        .conversation-item h3 { margin: 0; font-size: 1.1em; }

        /* Main Footer Navigation */
        .main-footer { padding: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; }
        .nav-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #ccc; transition: color 0.2s; }
        .nav-btn.active { color: var(--primary-color); }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header"><h1>Ù‡Ù…ÛŒØ§Ø±</h1><button id="logout-btn">Ø®Ø±ÙˆØ¬</button></header>

        <main>
            <!-- View 1: Card Swiping -->
            <div id="card-view" class="card-view">
                <div id="status-message" class="status-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>

            <!-- View 2: Chat -->
            <div id="chat-view" class="chat-view">
                <!-- NEW: Search area added here -->
                <div id="search-container">
                    <input type="text" id="search-user-input" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ...">
                </div>
                <div id="search-results"></div>
                
                <!-- Sub-view 2a: Conversation List (for matches) -->
                <div id="conversation-list"></div>
            </div>
        </main>

        <footer class="main-footer">
            <button class="nav-btn" id="nav-chat-btn">ğŸ’¬</button>
            <button class="nav-btn active" id="nav-cards-btn">ğŸƒ</button>
        </footer>
    </div>

    <script>
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        
        // --- DOM Elements ---
        const cardView = document.getElementById('card-view');
        const chatView = document.getElementById('chat-view');
        const statusMessage = document.getElementById('status-message');
        const logoutBtn = document.getElementById('logout-btn');
        const navCardsBtn = document.getElementById('nav-cards-btn');
        const navChatBtn = document.getElementById('nav-chat-btn');
        const conversationList = document.getElementById('conversation-list');
        
        // --- NEW: Search Elements ---
        const searchUserInput = document.getElementById('search-user-input');
        const searchResults = document.getElementById('search-results');

        // --- App State ---
        let currentUser = null;
        let clientToken = null;
        let allUsersData = {}; // Store all users by username for quick lookup
        let matches = []; // List of users we've matched with

        // --- AUTH & INIT ---
        (async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(storedUser);
            
            navCardsBtn.addEventListener('click', () => showView('cards'));
            navChatBtn.addEventListener('click', () => showView('chat'));
            logoutBtn.addEventListener('click', logout);
            
            // --- NEW: Event Listener for Search Input ---
            searchUserInput.addEventListener('input', handleUserSearch);
            
            await initializeApp();
        })();

        async function initializeApp() {
            try {
                await refreshClientToken();
                // We already fetch all users, which is perfect for our search feature
                const allUsers = await fetchAllUsers();
                allUsers.forEach(user => { allUsersData[user.username] = user; });
                
                await initializeCardsView();
                await initializeChatView();
            } catch (error) {
                console.error("Initialization Error:", error);
                statusMessage.textContent = `Ø®Ø·Ø§: ${error.message}`;
            }
        }

        // --- VIEW INITIALIZATION ---
        async function initializeCardsView() {
            // ... (No changes here)
             statusMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ÙˆØ§Ú©Ø´ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...';
            const seenUsers = await fetchSeenUsers();
            const usersToDisplay = Object.values(allUsersData).filter(user =>
                user.username !== currentUser.username && !seenUsers.includes(user.username)
            );
            if (usersToDisplay.length > 0) {
                 statusMessage.textContent = `${usersToDisplay.length} Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ÛŒØ§ÙØª Ø´Ø¯!`;
            } else {
                 statusMessage.textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
            }
        }

        async function initializeChatView() {
            await fetchMatches();
            renderConversationList();
        }

        // --- DATA FETCHING ---
        async function refreshClientToken() {
             const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
            if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ.');
            clientToken = (await response.json()).token;
        }
        async function fetchAllUsers() {
            const response = await fetch(`${PROXY_URL}?path=users`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.');
            const data = await response.json();
            return data ? Object.values(data) : [];
        }
        async function fetchSeenUsers() {
             const response = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) return [];
            const data = await response.json();
            return data ? Object.keys(data) : [];
        }

        async function fetchMatches() {
            // ... (No changes here)
            const myLikesResponse = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!myLikesResponse.ok) return;
            const myLikesData = await myLikesResponse.json();
            if (!myLikesData) return;

            const myLikedUsers = Object.keys(myLikesData).filter(key => myLikesData[key] === 'liked');
            
            const matchPromises = myLikedUsers.map(async (likedUsername) => {
                const theirLikesResponse = await fetch(`${PROXY_URL}?path=interactions/${likedUsername}/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
                const theirAction = await theirLikesResponse.json();
                if (theirAction === 'liked') {
                    return allUsersData[likedUsername];
                }
                return null;
            });
            matches = (await Promise.all(matchPromises)).filter(Boolean);
        }
        
        // --- UI & INTERACTIONS ---
        function showView(viewName) {
            if (viewName === 'cards') {
                cardView.style.display = 'flex';
                chatView.style.display = 'none';
                navCardsBtn.classList.add('active');
                navChatBtn.classList.remove('active');
            } else {
                cardView.style.display = 'none';
                chatView.style.display = 'flex';
                navCardsBtn.classList.remove('active');
                navChatBtn.classList.add('active');
                // --- NEW: Reset search when switching to chat view ---
                searchUserInput.value = '';
                searchResults.innerHTML = '';
                conversationList.style.display = 'block'; // Show match list by default
            }
        }

        function renderConversationList() {
            conversationList.innerHTML = '';
            const listTitle = document.createElement('h3');
            listTitle.textContent = 'Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø´Ù…Ø§';
            listTitle.style.padding = '10px 15px 0';
            listTitle.style.color = '#777';
            conversationList.appendChild(listTitle);

            if (matches.length === 0) {
                conversationList.insertAdjacentHTML('beforeend', '<div class="status-message">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ØªØ·Ø§Ø¨Ù‚ÛŒ Ù†Ø¯Ø§Ø±ÛŒ!</div>');
                return;
            }
            matches.forEach(user => {
                const item = document.createElement('a'); // Using <a> tag for direct navigation
                item.href = `pivi.html?with=${user.username}`;
                item.className = 'conversation-item';
                item.style.textDecoration = 'none';
                item.style.color = 'inherit';
                item.dataset.username = user.username;
                item.innerHTML = `<img src="https://i.pravatar.cc/100?u=${user.username}" alt="${user.displayName}"><h3>${user.displayName}</h3>`;
                conversationList.appendChild(item);
            });
        }

        // --- NEW: Search Handling Functions ---
        function handleUserSearch(e) {
            const query = e.target.value.trim().toLowerCase();
            searchResults.innerHTML = '';

            if (query.length < 2) {
                conversationList.style.display = 'block'; // If search is empty, show matches
                return;
            }

            conversationList.style.display = 'none'; // Hide matches while searching

            const results = Object.values(allUsersData).filter(user => 
                user.username.toLowerCase().includes(query) && user.username !== currentUser.username
            );

            if (results.length > 0) {
                renderSearchResults(results);
            } else {
                searchResults.innerHTML = '<div class="status-message">Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
            }
        }

        function renderSearchResults(users) {
            users.forEach(user => {
                // We use an <a> tag to make it a clickable link to the pivi.html page
                const item = document.createElement('a');
                item.href = `pivi.html?with=${user.username}`;
                // Re-using the same class for consistent styling
                item.className = 'conversation-item'; 
                item.style.textDecoration = 'none';
                item.style.color = 'inherit';
                
                item.innerHTML = `
                    <img src="https://i.pravatar.cc/100?u=${user.username}" alt="${user.displayName}">
                    <div>
                        <h3>${user.displayName}</h3>
                        <p style="font-size: 0.9em; color: #888; margin:0;">@${user.username}</p>
                    </div>
                `;
                searchResults.appendChild(item);
            });
        }
        // --- END NEW FUNCTIONS ---


        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html'; // Assuming you have an index/login page
        }

    </script>
</body>
</html>
