<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>همیار - صفحه اصلی</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --error-color: #dc3545; --danger-color: #e74c3c; --light-gray-color: #f8f9fa; --border-color: #dee2e6; }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background-color: var(--light-gray-color);
            color: #333;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            margin: 0 auto;
            background-color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        .app-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-header h1 {
            font-size: 1.5em;
            margin: 0;
            color: var(--primary-color);
        }
        .app-header button {
            background: none;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Vazirmatn';
            transition: background-color 0.2s, color 0.2s;
        }
        .app-header button:hover {
            background-color: var(--danger-color);
            color: white;
        }

        .card-container {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .profile-card {
            width: 100%;
            height: 100%;
            max-height: 500px;
            border-radius: 15px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            color: white;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        
        .profile-card.card--out-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
        .profile-card.card--out-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }

        .profile-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            border-radius: 0 0 15px 15px;
        }

        .card-info {
            padding: 20px;
            z-index: 2;
        }
        .card-info h2 { margin: 0 0 5px; }
        .card-info p { margin: 0; opacity: 0.9; }

        .status-message {
            font-size: 1.2em;
            color: #aaa;
            text-align: center;
        }

        .action-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: white;
            font-size: 2em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn--dislike { color: var(--danger-color); border-color: var(--danger-color); }
        .btn--like { color: var(--success-color); border-color: var(--success-color); }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <h1>همیار</h1>
            <button id="logout-btn">خروج</button>
        </header>

        <main class="card-container" id="card-stack">
            <div id="status-message" class="status-message">در حال بارگذاری...</div>
        </main>

        <footer class="action-footer">
            <button class="action-btn btn--dislike" id="dislike-btn">✖</button>
            <button class="action-btn btn--like" id="like-btn">✔</button>
        </footer>
    </div>

    <script>
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';

        const cardStack = document.getElementById('card-stack');
        const statusMessage = document.getElementById('status-message');
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');
        const logoutBtn = document.getElementById('logout-btn');

        let currentUser = null;
        let usersToDisplay = [];
        let clientToken = null;
        let isInteracting = false;

        (async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(storedUser);

            likeBtn.addEventListener('click', () => handleInteraction(true));
            dislikeBtn.addEventListener('click', () => handleInteraction(false));
            logoutBtn.addEventListener('click', logout);
            
            await initializeApp();
        })();

        async function initializeApp() {
            try {
                statusMessage.textContent = 'در حال دریافت توکن...';
                await refreshClientToken();

                statusMessage.textContent = 'در حال واکشی کاربران...';
                const allUsers = await fetchAllUsers();
                const seenUsers = await fetchSeenUsers();
                
                usersToDisplay = allUsers.filter(user => 
                    user.username !== currentUser.username && !seenUsers.includes(user.username)
                );
                
                renderNextCard();

            } catch (error) {
                console.error("Initialization Error:", error);
                statusMessage.textContent = `خطا: ${error.message}`;
            }
        }

        async function refreshClientToken() {
            const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
            if (!response.ok) throw new Error('خطا در دریافت توکن امنیتی.');
            clientToken = (await response.json()).token;
        }

        async function fetchAllUsers() {
            const response = await fetch(`${PROXY_URL}?path=users`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) throw new Error('خطا در واکشی لیست کاربران.');
            const data = await response.json();
            return data ? Object.values(data) : [];
        }

        async function fetchSeenUsers() {
            const response = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) return []; // If no interactions, it might fail, so return empty array
            const data = await response.json();
            return data ? Object.keys(data) : [];
        }

        function renderNextCard() {
            statusMessage.style.display = 'none';
            // Clear only the card, not the status message if it's the only thing there
            const existingCard = cardStack.querySelector('.profile-card');
            if (existingCard) existingCard.remove();

            if (usersToDisplay.length === 0) {
                statusMessage.textContent = 'کاربر دیگری برای نمایش وجود ندارد!';
                statusMessage.style.display = 'block';
                return;
            }

            const nextUser = usersToDisplay[0];
            const card = document.createElement('div');
            card.className = 'profile-card';
            card.style.backgroundImage = `url(https://i.pravatar.cc/500?u=${nextUser.username})`;
            card.dataset.username = nextUser.username;
            card.innerHTML = `<div class="card-info"><h2>${nextUser.displayName}, ${nextUser.age}</h2><p>${nextUser.bio || 'بیوگرافی ثبت نشده است.'}</p></div>`;
            cardStack.appendChild(card);
        }

        function handleInteraction(liked) {
            if (isInteracting || usersToDisplay.length === 0) return;
            isInteracting = true;

            const card = document.querySelector('.profile-card');
            const targetUsername = card.dataset.username;

            card.classList.add(liked ? 'card--out-right' : 'card--out-left');
            saveInteraction(targetUsername, liked ? 'liked' : 'disliked');
            
            setTimeout(() => {
                usersToDisplay.shift();
                renderNextCard();
                isInteracting = false;
            }, 400);
        }
        
        async function saveInteraction(targetUsername, action) {
            try {
                const response = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}/${targetUsername}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` },
                    body: JSON.stringify(action)
                });
                if (!response.ok) console.error('Failed to save interaction for', targetUsername);
                else console.log(`Interaction (${action}) saved for ${targetUsername}`);
            } catch (error) {
                console.error("Save Interaction Error:", error);
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html'; // Go to loading screen which will redirect to register
        }
    </script>
</body>
</html>
