<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù‡Ù…ÛŒØ§Ø± - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --danger-color: #e74c3c; --light-gray-color: #f8f9fa; --border-color: #e9ecef; --sent-bg: #e0f7fa; --received-bg: #f1f3f5; }
        
        /* --- Base & Reset --- */
        *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; background-color: var(--light-gray-color); color: #333; -webkit-user-select: none; user-select: none; overflow: hidden; }

        /* --- Main App Structure --- */
        .app-container { width: 100%; max-width: 420px; height: 100vh; margin: 0 auto; background-color: white; display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.1); }
        .app-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .app-header h1 { font-size: 1.5em; margin: 0; color: var(--primary-color); }
        .app-header button { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-family: 'Vazirmatn'; transition: all 0.2s; }
        .app-header button:hover { background-color: var(--danger-color); color: white; }
        main { flex-grow: 1; position: relative; overflow: hidden; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 0.2s ease-in-out; display: flex; flex-direction: column; }
        .view.active { opacity: 1; visibility: visible; }

        /* --- Card Swiping View --- */
        #card-view { padding: 15px; align-items: center; justify-content: center; }
        .card-stack { flex-grow: 1; width: 100%; position: relative; }
        .profile-card { width: 100%; height: 100%; border-radius: 15px; background-size: cover; background-position: center; box-shadow: 0 5px 20px rgba(0,0,0,0.15); position: absolute; display: flex; flex-direction: column; justify-content: flex-end; color: white; cursor: grab; }
        .profile-card:active { cursor: grabbing; }
        .profile-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.85), transparent); border-radius: 0 0 15px 15px; }
        .card-info { padding: 25px; z-index: 2; }
        .card-info h2 { margin: 0 0 5px; font-size: 1.8em; } .card-info p { margin: 0; opacity: 0.9; font-size: 1.1em; }
        .card-action-buttons { flex-shrink: 0; padding: 15px 0 0; display: flex; justify-content: space-around; align-items: center; }
        .action-btn { width: 60px; height: 60px; border-radius: 50%; border: 1px solid #ddd; background-color: white; font-size: 2em; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .action-btn:hover { transform: scale(1.1); }
        .btn--dislike { color: var(--danger-color); } .btn--like { color: var(--success-color); }
        .card-stamp { position: absolute; top: 40px; font-size: 2.5em; font-weight: 700; padding: 5px 15px; border-radius: 10px; border: 4px solid; opacity: 0; }
        #like-stamp { right: 20px; color: var(--success-color); transform: rotate(15deg); }
        #nope-stamp { left: 20px; color: var(--danger-color); transform: rotate(-15deg); }

        /* --- Chat Views --- */
        #chat-view { overflow-y: auto; }
        .conversation-item { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .conversation-item:hover { background-color: #fcfcfc; }
        .conversation-item img { width: 55px; height: 55px; border-radius: 50%; margin-left: 15px; }
        .convo-details { flex-grow: 1; }
        .convo-details h3 { margin: 0; font-size: 1.1em; }
        .convo-details p { margin: 5px 0 0; color: #888; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #single-chat-view { display: none; flex-direction: column; }
        .chat-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .chat-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; margin-left: 10px; }
        .chat-header h2 { margin: 0; font-size: 1.2em; }
        #messages-area { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 20px; margin-bottom: 5px; word-wrap: break-word; line-height: 1.4; }
        .message .time { display: block; font-size: 0.75em; color: #999; margin-top: 5px; text-align: left; }
        .message.sent { background-color: var(--sent-bg); align-self: flex-end; border-bottom-right-radius: 5px; }
        .message.received { background-color: var(--received-bg); align-self: flex-start; border-bottom-left-radius: 5px; }
        #message-form { display: flex; padding: 10px; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        #message-form input { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 20px; font-family: 'Vazirmatn'; }
        #message-form button { background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-right: 10px; font-size: 1.5em; cursor: pointer; }

        /* --- Profile View --- */
        #profile-view { padding: 25px; justify-content: flex-start; overflow-y: auto; }
        .profile-header { text-align: center; margin-bottom: 25px; }
        .profile-header img { width: 120px; height: 120px; border-radius: 50%; border: 4px solid var(--primary-color); box-shadow: 0 0 15px rgba(0,123,255,0.3); }
        .profile-header h2 { margin: 15px 0 5px; font-size: 1.6em; }
        .profile-header p { margin: 0; color: #777; font-size: 1.1em; }
        .profile-section { margin-bottom: 20px; }
        .profile-section h3 { margin: 0 0 10px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }
        .profile-bio { color: #555; line-height: 1.6; }
        .interests-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .interest-tag { background-color: var(--border-color); padding: 5px 12px; border-radius: 15px; font-size: 0.9em; }
        .profile-actions button { display: block; width: 100%; text-align: right; background: #fff; border: 1px solid var(--border-color); padding: 15px; border-radius: 10px; margin-bottom: 10px; font-size: 1em; font-family: 'Vazirmatn'; cursor: pointer; }

        /* --- Main Footer Navigation --- */
        .main-footer { padding: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; }
        .nav-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #ccc; transition: color 0.2s; }
        .nav-btn.active { color: var(--primary-color); }
        .status-message { font-size: 1.2em; color: #aaa; text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header"><h1>Ù‡Ù…ÛŒØ§Ø±</h1><button id="logout-btn">Ø®Ø±ÙˆØ¬</button></header>

        <main>
            <!-- View 1: My Profile -->
            <div id="profile-view" class="view">
                <div class="profile-header">
                    <img id="profile-pic" src="https://i.pravatar.cc/150" alt="Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„">
                    <h2 id="profile-display-name">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</h2>
                    <p id="profile-username">@username</p>
                </div>
                <div class="profile-section">
                    <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù†</h3>
                    <p id="profile-bio" class="profile-bio">Ú©Ù…ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù†...</p>
                </div>
                <div class="profile-section">
                    <h3>Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h3>
                    <div id="profile-interests" class="interests-container"></div>
                </div>
                <div class="profile-section profile-actions">
                    <button>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                    <button>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
                </div>
            </div>

            <!-- View 2: Chat -->
            <div id="chat-view" class="view">
                <div id="conversation-list"></div>
                <div id="single-chat-view">
                    <div class="chat-header"><button id="back-to-list-btn">â¡ï¸</button><h2 id="chat-partner-name"></h2></div>
                    <div id="messages-area"></div>
                    <form id="message-form"><input type="text" id="message-input" placeholder="Ù¾ÛŒØ§Ù…..." autocomplete="off"><button type="submit">â¬†ï¸</button></form>
                </div>
            </div>
            
            <!-- View 3: Card Swiping -->
            <div id="card-view" class="view active">
                 <div class="card-stack" id="card-stack">
                     <div id="like-stamp" class="card-stamp">Ù„Ø§ÛŒÚ©</div>
                     <div id="nope-stamp" class="card-stamp">Ø±Ø¯</div>
                     <div id="status-message" class="status-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                 </div>
                 <div class="card-action-buttons">
                     <button class="action-btn btn--dislike" id="dislike-btn">âœ–</button>
                     <button class="action-btn btn--like" id="like-btn">âœ”</button>
                 </div>
            </div>
        </main>

        <footer class="main-footer">
            <button class="nav-btn" id="nav-profile-btn">ğŸ‘¤</button>
            <button class="nav-btn" id="nav-chat-btn">ğŸ’¬</button>
            <button class="nav-btn active" id="nav-cards-btn">ğŸƒ</button>
        </footer>
    </div>

    <script>
        // --- CONFIG & DOM ---
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        const DOM = {
            views: { profile: document.getElementById('profile-view'), chat: document.getElementById('chat-view'), cards: document.getElementById('card-view') },
            navBtns: { profile: document.getElementById('nav-profile-btn'), chat: document.getElementById('nav-chat-btn'), cards: document.getElementById('nav-cards-btn') },
            cardStack: document.getElementById('card-stack'),
            statusMessage: document.getElementById('status-message'),
            likeBtn: document.getElementById('like-btn'),
            dislikeBtn: document.getElementById('dislike-btn'),
            likeStamp: document.getElementById('like-stamp'),
            nopeStamp: document.getElementById('nope-stamp'),
            logoutBtn: document.getElementById('logout-btn'),
            conversationList: document.getElementById('conversation-list'),
            singleChatView: document.getElementById('single-chat-view'),
            backToListBtn: document.getElementById('back-to-list-btn'),
            chatPartnerName: document.getElementById('chat-partner-name'),
            messagesArea: document.getElementById('messages-area'),
            messageForm: document.getElementById('message-form'),
            messageInput: document.getElementById('message-input'),
            profile: {
                pic: document.getElementById('profile-pic'),
                displayName: document.getElementById('profile-display-name'),
                username: document.getElementById('profile-username'),
                bio: document.getElementById('profile-bio'),
                interests: document.getElementById('profile-interests'),
            }
        };

        // --- APP STATE ---
        let currentUser = null, clientToken = null, allUsersData = {}, usersToDisplay = [], activeChatPartner = null, messagePollingInterval = null, isInteracting = false;

        // --- AUTH & INIT ---
        (async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(storedUser);

            Object.keys(DOM.navBtns).forEach(key => DOM.navBtns[key].addEventListener('click', () => showView(key)));
            DOM.logoutBtn.addEventListener('click', logout);
            DOM.likeBtn.addEventListener('click', () => handleInteraction('liked'));
            DOM.dislikeBtn.addEventListener('click', () => handleInteraction('disliked'));
            DOM.backToListBtn.addEventListener('click', showConversationList);
            DOM.messageForm.addEventListener('submit', handleSendMessage);
            
            await initializeApp();
        })();

        async function initializeApp() {
            try {
                await refreshClientToken();
                const [allUsers, seenUsers] = await Promise.all([fetchAllUsers(), fetchSeenUsers()]);
                allUsers.forEach(user => { allUsersData[user.username] = user; });
                usersToDisplay = allUsers.filter(u => u.username !== currentUser.username && !seenUsers.includes(u.username));
                
                initializeProfileView();
                initializeCardsView();
                initializeChatView(); // Must be after users are fetched
            } catch (error) { console.error("Initialization Error:", error); DOM.statusMessage.textContent = `Ø®Ø·Ø§: ${error.message}`; }
        }

        // --- VIEW MANAGEMENT ---
        function showView(viewName) {
            Object.keys(DOM.views).forEach(key => {
                DOM.views[key].classList.toggle('active', key === viewName);
                DOM.navBtns[key].classList.toggle('active', key === viewName);
            });
            if (viewName === 'chat') { showConversationList(); }
        }

        // --- INITIALIZE VIEWS ---
        function initializeProfileView() {
            DOM.profile.pic.src = `https://i.pravatar.cc/150?u=${currentUser.username}`;
            DOM.profile.displayName.textContent = currentUser.displayName;
            DOM.profile.username.textContent = `@${currentUser.username}`;
            DOM.profile.bio.textContent = currentUser.bio || 'Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ Ù‡Ù†ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
            DOM.profile.interests.innerHTML = '';
            if (currentUser.interests && currentUser.interests.length > 0 && currentUser.interests[0]) {
                currentUser.interests.forEach(interest => {
                    const tag = document.createElement('span');
                    tag.className = 'interest-tag';
                    tag.textContent = interest;
                    DOM.profile.interests.appendChild(tag);
                });
            }
        }
        function initializeCardsView() { renderNextCard(); }
        async function initializeChatView() {
            const matches = await fetchMatches();
            renderConversationList(matches);
        }

        // --- DATA FETCHING ---
        async function refreshClientToken() { /* ... */ }
        async function fetchAllUsers() { /* ... */ }
        async function fetchSeenUsers() { /* ... */ }
        async function fetchLastMessage(chatId) {
            const queryParams = new URLSearchParams({ orderBy: '"timestamp"', limitToLast: '1' });
            const response = await fetch(`${PROXY_URL}?path=messages/${chatId}&${queryParams}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) return null;
            const data = await response.json();
            return data ? Object.values(data)[0] : null;
        }

        // --- CARD SWIPING LOGIC ---
        function renderNextCard() {
             DOM.statusMessage.style.display = 'none';
             const existingCard = DOM.cardStack.querySelector('.profile-card');
             if (existingCard) existingCard.remove();
             if (usersToDisplay.length === 0) {
                 DOM.statusMessage.textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!';
                 DOM.statusMessage.style.display = 'block';
                 return;
             }
             const nextUser = usersToDisplay[0];
             const card = document.createElement('div');
             card.className = 'profile-card';
             card.style.backgroundImage = `url(https://i.pravatar.cc/500?u=${nextUser.username})`;
             card.innerHTML = `<div class="card-info"><h2>${nextUser.displayName}, ${nextUser.age}</h2><p>${nextUser.bio || ''}</p></div>`;
             DOM.cardStack.prepend(card); // Prepend to be under the stamps
        }
        function handleInteraction(action) {
            if (isInteracting || usersToDisplay.length === 0) return;
            isInteracting = true;
            const card = DOM.cardStack.querySelector('.profile-card');
            const targetUsername = usersToDisplay[0].username;
            const flyOutAngle = (Math.random() - 0.5) * 40; // Random angle
            card.style.transition = 'transform 0.5s ease-out';
            card.style.transform = `translateX(${action === 'liked' ? 150 : -150}%) rotate(${flyOutAngle}deg)`;
            saveInteraction(targetUsername, action);
            setTimeout(() => {
                usersToDisplay.shift();
                renderNextCard();
                isInteracting = false;
            }, 500);
        }

        // --- CHAT LOGIC ---
        async function fetchMatches() { /* ... */ }
        async function renderConversationList(matches) {
            DOM.conversationList.innerHTML = '';
            if (matches.length === 0) { DOM.conversationList.innerHTML = '<div class="status-message">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ØªØ·Ø§Ø¨Ù‚ÛŒ Ù†Ø¯Ø§Ø±ÛŒ!</div>'; return; }
            
            const lastMessagePromises = matches.map(user => {
                const chatId = [currentUser.username, user.username].sort().join('_');
                return fetchLastMessage(chatId);
            });
            const lastMessages = await Promise.all(lastMessagePromises);

            matches.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                const lastMsg = lastMessages[index];
                item.innerHTML = `<img src="https://i.pravatar.cc/100?u=${user.username}"><div class="convo-details"><h3>${user.displayName}</h3><p>${lastMsg ? lastMsg.text : 'Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡.'}</p></div>`;
                item.addEventListener('click', () => openChat(user));
                DOM.conversationList.appendChild(item);
            });
        }
        function openChat(partner) { /* ... */ }
        function showConversationList() {
            DOM.singleChatView.style.display = 'none';
            DOM.conversationList.style.display = 'block';
            if (messagePollingInterval) clearInterval(messagePollingInterval);
            initializeChatView(); // Refresh match list
        }
        async function loadMessages() { /* ... */ }
        async function handleSendMessage(e) { /* ... */ }

        // --- UTILITY ---
        function logout() { localStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
        
        // Dummy function implementations to avoid repetition
        async function refreshClientToken() {
            const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
            if (!response.ok) throw new Error('Token Error.');
            clientToken = (await response.json()).token;
        }
        async function fetchAllUsers() {
            const response = await fetch(`${PROXY_URL}?path=users`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) throw new Error('User Fetch Error.');
            const data = await response.json();
            return data ? Object.values(data) : [];
        }
        async function fetchSeenUsers() {
            const response = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) return [];
            const data = await response.json();
            return data ? Object.keys(data) : [];
        }
        async function fetchMatches() {
            const myLikesResponse = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!myLikesResponse.ok) return [];
            const myLikesData = await myLikesResponse.json();
            if (!myLikesData) return [];
            const myLikedUsers = Object.keys(myLikesData).filter(key => myLikesData[key] === 'liked');
            const matchPromises = myLikedUsers.map(async (uname) => {
                const theirLikesResponse = await fetch(`${PROXY_URL}?path=interactions/${uname}/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
                if (await theirLikesResponse.json() === 'liked') return allUsersData[uname];
                return null;
            });
            return (await Promise.all(matchPromises)).filter(Boolean);
        }
        function openChat(partner) {
            activeChatPartner = partner;
            DOM.conversationList.style.display = 'none';
            DOM.singleChatView.style.display = 'flex';
            DOM.chatPartnerName.textContent = partner.displayName;
            loadMessages();
            if (messagePollingInterval) clearInterval(messagePollingInterval);
            messagePollingInterval = setInterval(loadMessages, 5000);
        }
        async function loadMessages() {
            if (!activeChatPartner) return;
            const chatId = [currentUser.username, activeChatPartner.username].sort().join('_');
            const response = await fetch(`${PROXY_URL}?path=messages/${chatId}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            const messagesData = await response.json();
            DOM.messagesArea.innerHTML = '';
            if (messagesData) {
                Object.values(messagesData).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)).forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message ' + (msg.senderId === currentUser.username ? 'sent' : 'received');
                    const time = new Date(msg.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
                    msgDiv.innerHTML = `${msg.text}<span class="time">${time}</span>`;
                    DOM.messagesArea.prepend(msgDiv);
                });
            }
        }
        async function handleSendMessage(e) {
            e.preventDefault();
            const text = DOM.messageInput.value.trim();
            if (!text || !activeChatPartner) return;
            const chatId = [currentUser.username, activeChatPartner.username].sort().join('_');
            const message = { senderId: currentUser.username, text: text, timestamp: new Date().toISOString() };
            DOM.messageInput.value = '';
            await fetch(`${PROXY_URL}?path=messages/${chatId}`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` }, body: JSON.stringify(message) });
            await loadMessages();
        }
        async function saveInteraction(targetUsername, action) {
             try {
                await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}/${targetUsername}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` },
                    body: JSON.stringify(action)
                });
             } catch(e){ console.error("Interaction save failed", e); }
        }
    </script>
</body>
</html>