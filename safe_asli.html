<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‡Ù…ÛŒØ§Ø± - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --danger-color: #e74c3c; --light-gray-color: #f8f9fa; --border-color: #dee2e6; --sent-bg: #e1f5fe; --received-bg: #f1f3f5; }
        *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; background-color: var(--light-gray-color); color: #333; -webkit-user-select: none; user-select: none; }

        .app-container { width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background-color: white; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        .app-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { font-size: 1.5em; margin: 0; color: var(--primary-color); }
        .app-header button#logout-btn { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-family: 'Vazirmatn'; transition: background-color 0.2s, color 0.2s; }
        .app-header button#logout-btn:hover { background-color: var(--danger-color); color: white; }

        main { flex-grow: 1; position: relative; overflow: hidden; }
        .view { width: 100%; height: 100%; display: none; flex-direction: column; }
        .view.active { display: flex; }

        /* Card Swiping View */
        .card-view { padding: 20px; justify-content: center; align-items: center; position: relative; }
        .profile-card { width: 100%; height: 100%; max-height: 500px; border-radius: 15px; background-size: cover; background-position: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: absolute; display: flex; flex-direction: column; justify-content: flex-end; color: white; transition: transform 0.4s ease, opacity 0.4s ease; }
        .profile-card.card--out-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
        .profile-card.card--out-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
        .profile-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); border-radius: 0 0 15px 15px; }
        .card-info { padding: 20px; z-index: 2; }
        .card-info h2 { margin: 0 0 5px; } .card-info p { margin: 0 0 10px; opacity: 0.9; }
        .interests-container { display: flex; flex-wrap: wrap; gap: 5px; }
        .interest-tag { background-color: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 12px; font-size: 0.8em; }

        /* Profile View */
        .profile-view { padding: 20px; overflow-y: auto; }
        .profile-field { margin-bottom: 20px; }
        .profile-field label { font-weight: 700; color: #333; display: block; margin-bottom: 5px; }
        .profile-field p, .profile-field input, .profile-field textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--light-gray-color); margin: 0; }
        .profile-field textarea { min-height: 80px; resize: vertical; }
        .profile-view button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em; font-weight: 700; cursor: pointer; }
        #edit-profile-btn { background-color: var(--primary-color); color: white; }
        #save-profile-btn { background-color: var(--success-color); color: white; }
        .edit-mode { display: none; } /* Hide edit fields by default */
        .profile-view.is-editing .view-mode { display: none; }
        .profile-view.is-editing .edit-mode { display: block; }
        
        /* Chat Views */
        #conversation-list, #single-chat-view { height: 100%; }
        /* ... Other chat styles remain the same ... */

        .main-footer { padding: 10px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; }
        .nav-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #ccc; transition: color 0.2s; }
        .nav-btn.active { color: var(--primary-color); }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header"><h1>Ù‡Ù…ÛŒØ§Ø±</h1><button id="logout-btn">Ø®Ø±ÙˆØ¬</button></header>

        <main>
            <!-- View 1: Card Swiping -->
            <div id="card-view" class="view active card-view">
                <div id="status-message" class="status-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>

            <!-- View 2: Chat -->
            <div id="chat-view" class="view chat-view">
                <!-- ... Chat HTML structure remains the same ... -->
            </div>
            
            <!-- View 3: Profile -->
            <div id="profile-view" class="view profile-view">
                <div class="profile-field">
                    <label>Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</label>
                    <p class="view-mode" id="profile-displayName"></p>
                    <input class="edit-mode" type="text" id="edit-displayName">
                </div>
                <div class="profile-field">
                    <label>Ø³Ù†</label>
                    <p class="view-mode" id="profile-age"></p>
                    <input class="edit-mode" type="number" id="edit-age" min="18" max="99">
                </div>
                <div class="profile-field">
                    <label>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù†</label>
                    <p class="view-mode" id="profile-bio"></p>
                    <textarea class="edit-mode" id="edit-bio"></textarea>
                </div>
                <div class="profile-field">
                    <label>Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ (Ø¨Ø§ ÙˆÛŒØ±Ú¯ÙˆÙ„ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label>
                    <p class="view-mode" id="profile-interests"></p>
                    <input class="edit-mode" type="text" id="edit-interests">
                </div>
                <button class="view-mode" id="edit-profile-btn">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                <button class="edit-mode" id="save-profile-btn">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        </main>

        <footer class="main-footer">
            <button class="nav-btn" id="nav-profile-btn">ğŸ‘¤</button>
            <button class="nav-btn" id="nav-chat-btn">ğŸ’¬</button>
            <button class="nav-btn active" id="nav-cards-btn">ğŸƒ</button>
        </footer>
    </div>

    <script>
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        
        // --- DOM Elements ---
        const views = {
            cards: document.getElementById('card-view'),
            chat: document.getElementById('chat-view'),
            profile: document.getElementById('profile-view')
        };
        const navButtons = {
            cards: document.getElementById('nav-cards-btn'),
            chat: document.getElementById('nav-chat-btn'),
            profile: document.getElementById('nav-profile-btn')
        };
        const profileFields = {
            displayName: document.getElementById('profile-displayName'),
            age: document.getElementById('profile-age'),
            bio: document.getElementById('profile-bio'),
            interests: document.getElementById('profile-interests'),
        };
        const editProfileFields = {
            displayName: document.getElementById('edit-displayName'),
            age: document.getElementById('edit-age'),
            bio: document.getElementById('edit-bio'),
            interests: document.getElementById('edit-interests'),
        };
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        // --- App State ---
        let currentUser = null;
        let clientToken = null;

        // --- AUTH & INIT ---
        (async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(storedUser);
            
            Object.keys(navButtons).forEach(key => {
                navButtons[key].addEventListener('click', () => showView(key));
            });
            logoutBtn.addEventListener('click', logout);
            editProfileBtn.addEventListener('click', toggleEditMode);
            saveProfileBtn.addEventListener('click', handleSaveProfile);
            
            await initializeApp();
        })();

        async function initializeApp() {
            await refreshClientToken();
            renderProfile();
            // Other initializations like fetching cards and chats...
        }

        // --- VIEW MANAGEMENT ---
        function showView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.toggle('active', key === viewName);
                navButtons[key].classList.toggle('active', key === viewName);
            });
        }
        
        // --- PROFILE LOGIC ---
        function renderProfile() {
            profileFields.displayName.textContent = currentUser.displayName;
            profileFields.age.textContent = currentUser.age;
            profileFields.bio.textContent = currentUser.bio || 'Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
            profileFields.interests.textContent = Array.isArray(currentUser.interests) ? currentUser.interests.join('ØŒ ') : '';
        }

        function toggleEditMode() {
            editProfileFields.displayName.value = currentUser.displayName;
            editProfileFields.age.value = currentUser.age;
            editProfileFields.bio.value = currentUser.bio || '';
            editProfileFields.interests.value = Array.isArray(currentUser.interests) ? currentUser.interests.join('ØŒ ') : '';
            views.profile.classList.add('is-editing');
        }

        async function handleSaveProfile() {
            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

            const updatedData = {
                displayName: editProfileFields.displayName.value.trim(),
                age: parseInt(editProfileFields.age.value),
                bio: editProfileFields.bio.value.trim(),
                interests: editProfileFields.interests.value.split('ØŒ').map(i => i.trim()).filter(Boolean)
            };

            try {
                const response = await fetch(`${PROXY_URL}?path=users/${currentUser.username}`, {
                    method: 'PATCH', // PATCH only updates specified fields
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` },
                    body: JSON.stringify(updatedData)
                });
                if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.');
                
                // Update local state and localStorage
                currentUser = { ...currentUser, ...updatedData };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                renderProfile(); // Re-render with new data
                views.profile.classList.remove('is-editing');

            } catch (error) {
                alert(error.message);
            } finally {
                saveProfileBtn.disabled = false;
                saveProfileBtn.textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
            }
        }

        // --- DATA FETCHING & OTHER LOGIC ---
        async function refreshClientToken() {
            const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
            if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ.');
            clientToken = (await response.json()).token;
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        
        // NOTE: The complete chat and card swiping logic from the previous response
        // should be integrated here. For brevity in this example, only the new
        // profile logic is shown in full detail, but the structure is complete.

    </script>
</body>
</html>