<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ÿæ€åÿßŸÖ‚Äåÿ±ÿ≥ÿßŸÜ ŸáŸÖ€åÿßÿ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

        /* --- Variables and Basic Setup --- */
        :root {
            --background-color: #0D1117;
            --primary-color: #1E90FF;
            --secondary-color: #161B22;
            --secondary-hover: #2C2F33;
            --border-color: #30363d;
            --text-primary: #E4E6EB;
            --text-secondary: #8b949e;
            --online-indicator: #28a745;
            --notification-badge: #28a745;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--secondary-color);
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--secondary-color);
            z-index: 10;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--border-color);
            transition: border-color 0.2s;
        }

        .profile-btn:hover {
            border-color: var(--primary-color);
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* --- Search Bar --- */
        .search-container {
            padding: 10px 15px;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
        }

        .search-container input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-container input:focus {
            border-color: var(--primary-color);
        }


        /* --- Tab Bar --- */
        .tab-bar {
            display: flex;
            justify-content: space-around;
            background-color: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            padding: 5px 0;
        }

        .tab-btn {
            flex-grow: 1;
            padding: 10px 0;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 700;
        }

        /* --- List Container --- */
        .list-container {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom Scrollbar for Webkit */
        .list-container::-webkit-scrollbar {
            width: 6px;
        }
        .list-container::-webkit-scrollbar-track {
            background: var(--secondary-color);
        }
        .list-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .list-item:hover {
            background-color: var(--secondary-hover);
        }
        
        .list-item:last-child {
             border-bottom: none;
        }

        .avatar {
            width: 50px;
            height: 50px;
            min-width: 50px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
            margin-left: 15px;
        }

        .item-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .verified-tick {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
            display: inline-block;
        }

        .item-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .item-last-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }
        
        .online-dot {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 12px;
            height: 12px;
            background-color: var(--online-indicator);
            border-radius: 50%;
            border: 2px solid var(--secondary-color);
        }
        
        /* --- Floating Action Button (FAB) --- */
        .fab-container {
            position: absolute;
            bottom: 25px;
            right: 25px;
            z-index: 20;
            display: flex;
            flex-direction: column-reverse;
            align-items: flex-end;
        }

        .fab-container.active .fab-action-btn {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .fab-container.active .fab-main-btn {
            transform: rotate(45deg);
            background-color: #e74c3c; /* Change color when active */
        }
        
        .fab-main-btn {
            background-color: var(--primary-color);
            color: var(--text-primary);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s, background-color 0.3s;
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .fab-action-btn {
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.3s, transform 0.3s, background-color 0.2s;
            padding: 8px 15px;
            background-color: var(--secondary-hover);
            color: var(--text-primary);
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .fab-action-btn:hover {
            background-color: var(--border-color);
        }
        
        .fab-action-btn svg {
            width: 18px;
            height: 18px;
            margin-left: 8px;
        }

        /* --- Profile Overlay --- */
        .profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            padding-top: 10vh; /* Adjust position for better mobile view */
        }

        .profile-overlay.active {
            visibility: visible;
            opacity: 1;
        }

        .profile-card {
            background-color: var(--secondary-color);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .profile-overlay.active .profile-card {
            transform: scale(1);
        }

        .profile-image-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            margin-bottom: 15px;
        }

        .profile-display-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            text-align: center;
        }

        .profile-username-text {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* --- Modal for Confirmation (replacing alert/confirm) --- */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 200;
            display: none; /* Default hidden */
            justify-content: center;
            align-items: center;
        }
        
        .custom-modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--secondary-color);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 300px;
            text-align: center;
        }
        
        .modal-message {
            font-size: 1rem;
            margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: space-around;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .modal-btn.confirm {
            background-color: #e74c3c;
            color: white;
        }
        .modal-btn.confirm:hover {
            background-color: #c0392b;
        }
        
        .modal-btn.cancel {
            background-color: var(--border-color);
            color: var(--text-primary);
        }
        .modal-btn.cancel:hover {
            background-color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Ÿæ€åÿßŸÖ‚Äåÿ±ÿ≥ÿßŸÜ ŸáŸÖ€åÿßÿ±</h1>
            <button class="profile-btn" id="profileBtn">
                <img id="headerProfileImage" src="https://ui-avatars.com/api/?name=User&background=0D1117&color=fff&size=50" alt="Profile">
            </button>
        </header>
        
        <!-- Search -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà ÿØÿ± ⁄Üÿ™‚ÄåŸáÿß Ÿà ⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß...">
        </div>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab-btn active" data-tab="chats" id="chatsTab">⁄Üÿ™‚ÄåŸáÿß</button>
            <button class="tab-btn" data-tab="channels" id="channelsTab">⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß</button>
        </div>

        <!-- Main List Container -->
        <div class="list-container">
            <div id="chatsList" class="tab-content active">
                <!-- Chat list items will be injected here -->
                <p style="text-align: center; color: var(--text-secondary); padding: 20px;" id="chatsPlaceholder">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄Üÿ™‚ÄåŸáÿß...</p>
            </div>
            <div id="channelsList" class="tab-content" style="display: none;">
                <!-- Channel list items will be injected here -->
                <p style="text-align: center; color: var(--text-secondary); padding: 20px;" id="channelsPlaceholder">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß...</p>
            </div>
        </div>
        
        <!-- FAB Container -->
        <div class="fab-container" id="fabContainer">
            <button class="fab-main-btn" id="fabMainBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            </button>
            <button class="fab-action-btn" id="newChatBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                ÿ¥ÿ±Ÿàÿπ ⁄Üÿ™ ÿ¨ÿØ€åÿØ
            </button>
            <button class="fab-action-btn" id="newChannelBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-megaphone"><path d="m3 11 18-5v12l-18 5V11z"/><path d="M7 11v7"/></svg>
                ⁄©ÿßŸÜÿßŸÑ ÿ¨ÿØ€åÿØ
            </button>
        </div>
        
        <!-- Profile Overlay -->
        <div class="profile-overlay" id="profileOverlay">
            <div class="profile-card">
                <button class="close-btn" onclick="hideProfile()" style="position: absolute; top: 10px; left: 10px; background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer;">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <img id="profileImage" class="profile-image-large" alt="Profile Image">
                <h2 id="profileDisplayName" class="profile-display-name"></h2>
                <p id="profileUsername" class="profile-username-text"></p>
                <!-- User ID for debugging (Optional but useful) -->
                <p style="font-size: 0.8rem; color: #5a626a;">ID: <span id="profileUserId"></span></p>
                <button id="logoutBtn" class="logout-btn">ÿÆÿ±Ÿàÿ¨ ÿßÿ≤ ÿ≠ÿ≥ÿßÿ® ⁄©ÿßÿ±ÿ®ÿ±€å</button>
            </div>
        </div>
        
        <!-- Custom Modal for Confirmation -->
        <div class="custom-modal" id="customModal">
            <div class="modal-content">
                <p class="modal-message" id="modalMessage">ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿÆÿßÿ±ÿ¨ ÿ¥Ÿà€åÿØÿü</p>
                <div class="modal-actions">
                    <button class="modal-btn confirm" id="modalConfirmBtn">ÿ®ŸÑŸá</button>
                    <button class="modal-btn cancel" id="modalCancelBtn">ÿÆ€åÿ±</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ===================================================================
        // üõ†Ô∏è ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ÿßŸÖŸÜ€åÿ™€å Ÿæÿ±ÿß⁄©ÿ≥€å
        // ===================================================================
        // ÿ¢ÿØÿ±ÿ≥ ŸÅÿß€åŸÑ PHP Ÿæÿ±ÿß⁄©ÿ≥€å (ŸÑÿ∑ŸÅÿßŸã ÿß€åŸÜ ÿ¢ÿØÿ±ÿ≥ ÿ±ÿß ÿ®ÿß ÿ¢ÿØÿ±ÿ≥ ŸàÿßŸÇÿπ€å ÿÆŸàÿØ ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ⁄©ŸÜ€åÿØ!)
        // üö® ÿßÿµŸÑÿßÿ≠ ÿ¥ÿØŸá: ÿßÿ≤ ŸÖÿ≥€åÿ± ŸÜÿ≥ÿ®€å ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿ¥ÿØ ÿ™ÿß 404 ÿ®ÿ±ÿ∑ÿ±ŸÅ ÿ¥ŸàÿØ.
        const PROXY_URL_BASE = './firebase_proxy.php'; 
        // ⁄©ŸÑ€åÿØ ÿßŸÖŸÜ€åÿ™€å ÿ™ÿπÿ±€åŸÅ ÿ¥ÿØŸá ÿØÿ± ŸÅÿß€åŸÑ PHP (SHARED_SECRET)
        const PROXY_SECRET = 'miko1234'; 
        // ÿ¢ÿØÿ±ÿ≥ ÿØÿ±€åÿßŸÅÿ™ ÿ™Ÿà⁄©ŸÜ ⁄©ŸÑÿß€åŸÜÿ™
        const PROXY_TOKEN_URL = `${PROXY_URL_BASE}?auth=token`;
        
        // ===================================================================
        // ‚öôÔ∏è ŸÖÿ™ÿ∫€åÿ±Ÿáÿß€å ⁄ØŸÑŸàÿ®ÿßŸÑ Ÿà ÿßŸÑŸÖÿßŸÜ‚ÄåŸáÿß
        // ===================================================================
        let currentUser = null;
        let clientToken = localStorage.getItem('clientToken');
        let pollingIntervalId = null;
        
        const CHAT_POLLING_INTERVAL = 5000; // 5 seconds interval for data refresh
        const VERIFIED_TICK_URL = 'https://placehold.co/16x16/007bff/ffffff?text=%E2%9C%93';

        // DOM Elements
        const profileBtn = document.getElementById('profileBtn');
        const profileOverlay = document.getElementById('profileOverlay');
        const profileImage = document.getElementById('profileImage');
        const headerProfileImage = document.getElementById('headerProfileImage');
        const profileDisplayName = document.getElementById('profileDisplayName');
        const profileUsername = document.getElementById('profileUsername');
        const profileUserId = document.getElementById('profileUserId');
        const logoutBtn = document.getElementById('logoutBtn');
        const chatsList = document.getElementById('chatsList');
        const channelsList = document.getElementById('channelsList');
        const chatsPlaceholder = document.getElementById('chatsPlaceholder');
        const channelsPlaceholder = document.getElementById('channelsPlaceholder');
        const chatsTab = document.getElementById('chatsTab');
        const channelsTab = document.getElementById('channelsTab');
        const fabContainer = document.getElementById('fabContainer');
        const fabMainBtn = document.getElementById('fabMainBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const newChannelBtn = document.getElementById('newChannelBtn');
        
        // Modal Elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // ===================================================================
        // üîë ŸÖÿØ€åÿ±€åÿ™ ÿ™Ÿà⁄©ŸÜ ⁄©ŸÑÿß€åŸÜÿ™ Ÿà Auth
        // ===================================================================

        // ŸÜŸÖÿß€åÿ¥ Modal ÿ®Ÿá ÿ¨ÿß€å confirm/alert
        function showCustomModal(message, onConfirm, onCancel) {
            modalMessage.textContent = message;
            customModal.classList.add('active');

            const handleConfirm = () => {
                customModal.classList.remove('active');
                modalConfirmBtn.removeEventListener('click', handleConfirm);
                modalCancelBtn.removeEventListener('click', handleCancel);
                if (onConfirm) onConfirm();
            };

            const handleCancel = () => {
                customModal.classList.remove('active');
                modalConfirmBtn.removeEventListener('click', handleConfirm);
                modalCancelBtn.removeEventListener('click', handleCancel);
                if (onCancel) onCancel();
            };

            modalConfirmBtn.addEventListener('click', handleConfirm);
            modalCancelBtn.addEventListener('click', handleCancel);
        }

        /**
         * Checks for client token and fetches one if expired or missing.
         * @returns {Promise<boolean>} True if token is ready, false otherwise.
         */
        async function ensureClientToken() {
            if (clientToken) return true;

            try {
                console.log('Fetching new client token...');
                const response = await fetch(PROXY_TOKEN_URL, {
                    method: 'GET',
                    headers: {
                        'X-Proxy-Secret': PROXY_SECRET
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.token) {
                        clientToken = data.token;
                        localStorage.setItem('clientToken', clientToken);
                        console.log('‚úÖ Client token successfully fetched and stored.');
                        return true;
                    }
                }
                
                // Fallback for failed token request
                console.error('‚ùå Failed to fetch client token from proxy:', response.statusText);
                return false;
            } catch (error) {
                console.error('‚ùå Network error during token fetch:', error);
                return false;
            }
        }
        
        /**
         * Wrapper around fetch to securely access the database via the PHP proxy.
         * @param {string} path - The database path (e.g., 'users/alireza').
         * @param {string} method - HTTP method (GET, POST, PUT, DELETE).
         * @param {object} [data=null] - Data payload for POST/PUT/PATCH.
         * @returns {Promise<object|null>} The JSON response data from the database.
         */
        async function fetchWithProxy(path, method, data = null) {
            if (!currentUser || !clientToken) {
                console.error('Authorization required: User or Client Token is missing.');
                return null;
            }

            const isTokenReady = await ensureClientToken();
            if (!isTokenReady) {
                // If token refresh failed, force logout to re-auth
                console.error('Proxy Token is not ready. Forcing logout.');
                showCustomModal('ŸÖÿ¥⁄©ŸÑ ÿØÿ± ÿßÿ≠ÿ±ÿßÿ≤ ŸáŸà€åÿ™. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ.', handleLogout);
                return null;
            }
            
            const url = `${PROXY_URL_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
            const config = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    // ŸáÿØÿ± ÿßÿµŸÑ€å ÿßÿ≠ÿ±ÿßÿ≤ ŸáŸà€åÿ™
                    'Authorization': `Bearer ${clientToken}`,
                    // ŸÜÿßŸÖ ⁄©ÿßÿ±ÿ®ÿ±€å ÿ¨ÿßÿ±€å ÿ®ÿ±ÿß€å ÿ®ÿ±ÿ±ÿ≥€å ŸÖÿ¨Ÿàÿ≤Ÿáÿß€å ÿ≥ŸÖÿ™ ÿ≥ÿ±Ÿàÿ±
                    'X-User-Username': currentUser.username 
                }
            };

            if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, config);
                const responseData = await response.json();
                
                if (!response.ok) {
                    console.error(`‚ùå Proxy request failed for ${path} (${method}):`, responseData.error || response.statusText);
                    // Handle specific errors like token expiry (if proxy returns specific error)
                    if (responseData.error && responseData.error.includes('Token expired')) {
                         // Clear the expired token and try again (or force logout)
                         localStorage.removeItem('clientToken');
                         clientToken = null;
                         showCustomModal('ŸÜÿ¥ÿ≥ÿ™ ⁄©ÿßÿ±ÿ®ÿ±€å ÿ¥ŸÖÿß ŸÖŸÜŸÇÿ∂€å ÿ¥ÿØŸá ÿßÿ≥ÿ™. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ.', handleLogout);
                    }
                    return null;
                }

                return responseData;
            } catch (error) {
                console.error(`‚ùå Network error during proxy request to ${path}:`, error);
                return null;
            }
        }

        // ===================================================================
        // üîÑ ÿ™Ÿàÿßÿ®ÿπ ÿßÿµŸÑ€å ÿØÿßÿØŸá Ÿà ÿ±ŸÜÿØÿ±
        // ===================================================================

        async function fetchChats() {
            if (!currentUser) return;
            chatsPlaceholder.textContent = 'ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ⁄Üÿ™‚ÄåŸáÿß...';
            
            // üõë ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ fetchWithProxy ÿ®Ÿá ÿ¨ÿß€å ÿØÿ≥ÿ™ÿ±ÿ≥€å ŸÖÿ≥ÿ™ŸÇ€åŸÖ Firebase
            const chatsData = await fetchWithProxy('pivi_chats', 'GET'); 

            if (!chatsData) {
                chatsPlaceholder.textContent = 'ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄Üÿ™‚ÄåŸáÿß.';
                chatsList.innerHTML = '';
                return;
            }
            
            const chatsArray = Object.entries(chatsData)
                .map(([chatId, data]) => ({ chatId, ...data }))
                .filter(chat => chat.members && Object.keys(chat.members).includes(currentUser.username));

            renderChats(chatsArray);
            if (chatsArray.length === 0) {
                chatsPlaceholder.textContent = 'ŸáŸÜŸàÿ≤ ⁄Üÿ™€å ŸÜÿØÿßÿ±€åÿØ. ÿ®ÿ±ÿß€å ÿ¥ÿ±Ÿàÿπÿå €å⁄© ⁄Üÿ™ ÿ¨ÿØ€åÿØ ÿ®ÿ≥ÿßÿ≤€åÿØ.';
            } else {
                chatsPlaceholder.style.display = 'none';
            }
        }

        async function fetchChannels() {
            channelsPlaceholder.textContent = 'ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß...';
            
            // üõë ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ fetchWithProxy ÿ®Ÿá ÿ¨ÿß€å ÿØÿ≥ÿ™ÿ±ÿ≥€å ŸÖÿ≥ÿ™ŸÇ€åŸÖ Firebase
            const channelsData = await fetchWithProxy('channels', 'GET');

            if (!channelsData) {
                channelsPlaceholder.textContent = 'ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß.';
                channelsList.innerHTML = '';
                return;
            }

            const channelsArray = Object.entries(channelsData)
                .map(([id, data]) => ({ id, ...data }));
            
            renderChannels(channelsArray);
            if (channelsArray.length === 0) {
                channelsPlaceholder.textContent = 'ŸáŸÜŸàÿ≤ ⁄©ÿßŸÜÿßŸÑ€å ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ.';
            } else {
                channelsPlaceholder.style.display = 'none';
            }
        }

        function renderChats(chats) {
            chatsList.innerHTML = '';
            chats.forEach(chat => {
                const otherMemberUsername = Object.keys(chat.members).find(u => u !== currentUser.username);
                if (!otherMemberUsername) return; // Should not happen

                // Mock user data for the other member (in a real app, you would fetch this from 'users/otherMemberUsername' via proxy)
                const otherMemberDisplayName = otherMemberUsername; 

                const chatItem = document.createElement('div');
                chatItem.className = 'list-item';
                chatItem.dataset.chatId = chat.chatId;
                
                // Assuming lastMessage is available and is a string
                const lastMessage = chat.lastMessage || 'ÿ¥ÿ±Ÿàÿπ ⁄ØŸÅÿ™⁄ØŸà...';

                // Basic time formatting (can be improved)
                const time = chat.timestamp ? new Date(chat.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' }) : '';


                chatItem.innerHTML = `
                    <div class="avatar" style="background-color: var(--primary-color);">
                         <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(otherMemberDisplayName)}&background=1E90FF&color=fff&size=50" alt="${otherMemberDisplayName}" class="avatar">
                         <!-- Online status indicator would go here if fetched separately -->
                    </div>
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name">${otherMemberDisplayName}</span>
                            <span class="item-time">${time}</span>
                        </div>
                        <p class="item-last-message">${lastMessage}</p>
                    </div>
                `;
                chatsList.appendChild(chatItem);
            });
            attachChatEventListeners();
        }

        function renderChannels(channels) {
            channelsList.innerHTML = '';
            channels.forEach(channel => {
                const channelItem = document.createElement('div');
                channelItem.className = 'list-item';
                channelItem.dataset.channelId = channel.channel_id;
                
                const time = channel.created_at ? new Date(channel.created_at).toLocaleDateString('fa-IR') : '';
                
                channelItem.innerHTML = `
                    <div class="avatar" style="background-color: #f39c12;">
                         <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(channel.channel_name)}&background=f39c12&color=fff&size=50" alt="${channel.channel_name}" class="avatar">
                    </div>
                    <div class="item-content">
                        <div class="item-header">
                            <span class="item-name">${channel.channel_name}</span>
                            <span class="item-time">${time}</span>
                        </div>
                        <p class="item-last-message">ÿ≥ÿßÿ≤ŸÜÿØŸá: @${channel.creator_username} - ${channel.description}</p>
                    </div>
                `;
                channelsList.appendChild(channelItem);
            });
            attachChannelEventListeners();
        }

        function attachChatEventListeners() {
            document.querySelectorAll('#chatsList .list-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Assuming you have a page like chat.html
                    window.location.href = `chat.html?id=${item.dataset.chatId}`;
                });
            });
        }
        
        function attachChannelEventListeners() {
            document.querySelectorAll('#channelsList .list-item').forEach(item => {
                item.addEventListener('click', () => {
                     // Assuming you have a page like channel.html
                    window.location.href = `channel.html?id=${item.dataset.channelId}`;
                });
            });
        }
        
        // --- Functions for Profile Page ---
        function showProfile() {
            if (!currentUser) return;
            // Assuming currentUser object is correctly loaded from localStorage and has 'verified' property
            const verifiedTickHtml = currentUser.verified === true ? `<img class="verified-tick" src="${VERIFIED_TICK_URL}" alt="ÿ™ÿß€å€åÿØ ÿ¥ÿØŸá">` : '';
            
            // Assuming currentUserId is available in currentUser object (e.g., from auth system)
            profileUserId.textContent = currentUser.uid || 'N/A'; // Assuming 'uid' is the actual unique ID
            
            // Update profile image sources
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName || currentUser.username)}&background=0D1117&color=fff&size=150`;
            profileImage.src = avatarUrl;
            headerProfileImage.src = avatarUrl;

            profileDisplayName.innerHTML = `${currentUser.displayName || currentUser.username} ${verifiedTickHtml}`;
            profileUsername.textContent = `@${currentUser.username}`;
            
            profileOverlay.classList.add('active');
        }
        function hideProfile() { profileOverlay.classList.remove('active'); }
        
        function handleLogout() {
            showCustomModal('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿÆÿßÿ±ÿ¨ ÿ¥Ÿà€åÿØÿü', () => {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('clientToken'); // ‚ö†Ô∏è ÿ™Ÿà⁄©ŸÜ Ÿæÿ±ÿß⁄©ÿ≥€å ÿ±ÿß ŸáŸÖ ÿ≠ÿ∞ŸÅ ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ
                clientToken = null;
                if (pollingIntervalId) clearInterval(pollingIntervalId);
                window.location.href = 'login.html'; 
            });
        }
        
        function toggleFabMenu() { fabContainer.classList.toggle('active'); }
        
        function setActiveTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

            document.getElementById(`${tabId}Tab`).classList.add('active');
            document.getElementById(`${tabId}List`).style.display = 'block';

            if (tabId === 'chats') {
                fetchChats();
            } else if (tabId === 'channels') {
                fetchChannels();
            }
        }


        // ===================================================================
        // üöÄ ÿßÿ¨ÿ±ÿß€å ÿßŸàŸÑ€åŸá (Initializer)
        // ===================================================================
        
        async function initialize() {
            const storedUser = localStorage.getItem('currentUser');
            currentUser = storedUser ? JSON.parse(storedUser) : null;

            if (!currentUser || !currentUser.username) {
                // Redirect if not logged in
                window.location.href = 'login.html';
                return;
            }
            
            // 1. Ensure proxy token is available
            const tokenReady = await ensureClientToken();
            if (!tokenReady) {
                 // The ensureClientToken already handles forced logout on failure, but we guard here too.
                 return;
            }

            // 2. Set up UI
            showProfile(); // to display initial header image
            profileBtn.addEventListener('click', showProfile);
            logoutBtn.addEventListener('click', handleLogout);
            fabMainBtn.addEventListener('click', toggleFabMenu);
            
            chatsTab.addEventListener('click', () => setActiveTab('chats'));
            channelsTab.addEventListener('click', () => setActiveTab('channels'));
            
            // 3. Initial Data Load (default to chats)
            setActiveTab('chats');
            
            // 4. Start polling for new data (adjust logic for real-time where possible)
            // Note: Since this is an HTML app without Firebase SDK, polling is the simplest method.
            pollingIntervalId = setInterval(() => {
                const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                if (activeTab === 'chats') {
                    fetchChats();
                } else {
                    fetchChannels();
                }
            }, CHAT_POLLING_INTERVAL);
        }

        window.onload = initialize;

    </script>
</body>
</html>
