<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù‡Ù…ÛŒØ§Ø± - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #007bff;
            --danger-color: #dc3545;
            --body-bg: #f0f2f5;
            --header-bg: #ffffff;
            --border-color: #dee2e6;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background-color: var(--body-bg);
            color: #333;
            -webkit-user-select: none;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background-color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .app-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--header-bg);
            flex-shrink: 0;
        }

        .app-header h1 {
            font-size: 1.4em;
            margin: 0;
            font-weight: 700;
            color: var(--primary-color);
        }

        .app-header button {
            background: var(--danger-color);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Vazirmatn';
            font-size: 0.9em;
            transition: background-color 0.2s;
        }

        .app-header button:hover {
            background-color: #c82333;
        }

        main {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .view {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: column;
            animation: viewFadeIn 0.4s ease;
        }
        
        @keyframes viewFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .view.active {
            display: flex;
        }

        #card-view {
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }

        .status-message {
            font-size: 1.1em;
            color: #6c757d;
        }

        #conversation-list {
            padding-top: 8px;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .conversation-item:last-child {
            border-bottom: none;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
        }

        .conversation-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 15px;
            object-fit: cover;
        }

        .conversation-item h3 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 500;
        }

        .main-footer {
            padding: 5px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: var(--header-bg);
            flex-shrink: 0;
        }

        .nav-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #adb5bd;
            transition: color 0.2s;
            padding: 10px 20px;
        }

        .nav-btn.active {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Ù‡Ù…ÛŒØ§Ø±</h1>
            <button id="logout-btn">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
        </header>

        <main>
            <!-- View 1: Card Swiping (Placeholder) -->
            <div id="card-view" class="view active">
                <div id="status-message" class="status-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>
            <!-- View 2: Chat List -->
            <div id="chat-view" class="view">
                <div id="conversation-list"></div>
            </div>
        </main>

        <footer class="main-footer">
            <button class="nav-btn" id="nav-chat-btn">ğŸ’¬</button>
            <button class="nav-btn active" id="nav-cards-btn">ğŸƒ</button>
        </footer>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234'; // This MUST match the secret in your PHP proxy

        // --- DOM Elements ---
        const cardView = document.getElementById('card-view');
        const chatView = document.getElementById('chat-view');
        const statusMessage = document.getElementById('status-message');
        const logoutBtn = document.getElementById('logout-btn');
        const navCardsBtn = document.getElementById('nav-cards-btn');
        const navChatBtn = document.getElementById('nav-chat-btn');
        const conversationList = document.getElementById('conversation-list');

        // --- App State ---
        let currentUser = null;
        let clientToken = null;

        // --- AUTH & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = JSON.parse(storedUser);

            setupEventListeners();
            await initializeApp();
        });

        async function initializeApp() {
            try {
                // Step 1: Get a secure client token from the proxy. This is mandatory for all other API calls.
                await refreshClientToken();
                console.log("Client token received successfully.");

                // Step 2: Fetch all necessary data in parallel for performance.
                const [allUsers, matches] = await Promise.all([
                    fetchAllUsers(),
                    fetchMatches()
                ]);

                // Step 3: Initialize the UI with the fetched data.
                initializeCardsView(allUsers);
                renderConversationList(matches);
            } catch (error) {
                console.error("Initialization Error:", error);
                const friendlyMessage = `Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡: ${error.message}`;
                statusMessage.textContent = friendlyMessage;
                alert(friendlyMessage);
            }
        }

        function setupEventListeners() {
            navCardsBtn.addEventListener('click', () => showView('cards'));
            navChatBtn.addEventListener('click', () => showView('chat'));
            logoutBtn.addEventListener('click', logout);
        }

        // --- VIEW LOGIC ---
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if (viewName === 'cards') {
                cardView.classList.add('active');
                navCardsBtn.classList.add('active');
            } else {
                chatView.classList.add('active');
                navChatBtn.classList.add('active');
            }
        }

        function initializeCardsView(allUsers) {
            // This is a placeholder for the card swiping functionality.
            const otherUsersCount = allUsers.filter(u => u.uid !== currentUser.uid).length;
            if (otherUsersCount > 0) {
                statusMessage.textContent = `Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ${otherUsersCount} Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯.`;
            } else {
                statusMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
            }
        }

        function renderConversationList(matches) {
            conversationList.innerHTML = '';
            if (!matches || matches.length === 0) {
                conversationList.innerHTML = '<div class="status-message" style="padding: 20px;">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒÛŒ Ù†Ø¯Ø§Ø±ÛŒ. Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø±Ø§ Ù„Ø§ÛŒÚ© Ú©Ù†!</div>';
                return;
            }
            matches.forEach(user => {
                if (!user) return; // Skip if a user object is null
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.innerHTML = `
                    <img src="https://i.pravatar.cc/100?u=${user.username}" alt="${user.displayName}">
                    <h3>${user.displayName}</h3>`;
                
                // CRITICAL: Navigate to pivi.html with the partner's username
                item.addEventListener('click', () => {
                    window.location.href = `pivi.html?with=${user.username}`;
                });
                conversationList.appendChild(item);
            });
        }

        // --- DATA FETCHING ---
        async function refreshClientToken() {
            // This special request requires the X-Proxy-Secret header for authentication.
            const tokenResponse = await apiRequest('?auth=token', 'GET', null, { 'X-Proxy-Secret': SHARED_SECRET });
            if (!tokenResponse || !tokenResponse.token) throw new Error("Could not retrieve a valid client token.");
            
            clientToken = tokenResponse.token;
            localStorage.setItem('clientToken', clientToken); // Save token for pivi.html
        }

        async function fetchAllUsers() {
            const data = await apiRequest('?path=users', 'GET');
            return data ? Object.values(data) : [];
        }

        async function fetchMatches() {
            // Logic to find matches: Users that I've liked AND have liked me back.
            const myInteractions = await apiRequest(`?path=interactions/${currentUser.uid}`, 'GET') || {};
            const myLikedUids = Object.keys(myInteractions).filter(uid => myInteractions[uid] === 'liked');

            if (myLikedUids.length === 0) return []; // No likes, no matches.
            
            const matchPromises = myLikedUids.map(async likedUid => {
                const theirInteraction = await apiRequest(`?path=interactions/${likedUid}/${currentUser.uid}`, 'GET');
                if (theirInteraction === 'liked') {
                    // It's a match! Fetch this user's full profile.
                    return await apiRequest(`?path=users/${likedUid}`, 'GET');
                }
                return null;
            });

            // Wait for all checks to complete and filter out any non-matches (null values).
            return (await Promise.all(matchPromises)).filter(Boolean);
        }

        // --- GENERIC API HELPER ---
        async function apiRequest(url, method, body = null, extraHeaders = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...extraHeaders
            };
            // For all requests other than getting the token, we use the Bearer token.
            if (clientToken && !url.includes('auth=token')) {
                 headers['Authorization'] = `Bearer ${clientToken}`;
            }

            const options = { method, headers };
            
            // CRITICAL: Embed the current user's UID in the request body for methods that write data.
            // The proxy will use this to tell Firebase who is making the request, enforcing security rules.
            if (method === 'POST' || method === 'PUT' || method === 'PATCH') {
                let requestBody = body || {};
                requestBody.auth_override_uid = currentUser.uid;
                options.body = JSON.stringify(requestBody);
            }

            try {
                const response = await fetch(`${PROXY_URL}${url}`, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡' }));
                    throw new Error(errorData.error || `Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±: ${response.status}`);
                }
                return response.status === 204 ? null : response.json();
            } catch (error) {
                console.error("API Request Failed:", error);
                throw error; // Re-throw the error to be handled by the calling function.
            }
        }

        function logout() {
            // Clear all stored data and redirect to the login page.
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
