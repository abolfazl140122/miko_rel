<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‡Ù…ÛŒØ§Ø± - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #e74c3c;
            --light-gray-color: #f8f9fa;
            --border-color: #dee2e6;
            --sent-bg: #e1f5fe;
            --received-bg: #f1f3f5;
            --text-color: #333;
            --secondary-text-color: #777;
        }
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Ø­Ø°Ù Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø¢Ø¨ÛŒ Ø²Ø´Øª Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background-color: var(--light-gray-color);
            color: var(--text-color);
            -webkit-user-select: none;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            margin: 0 auto;
            background-color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* Header */
        .app-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-header h1 { font-size: 1.5em; margin: 0; color: var(--primary-color); }
        .app-header button { background: none; border: 1px solid var(--danger-color); color: var(--danger-color); padding: 5px 10px; border-radius: 8px; cursor: pointer; font-family: 'Vazirmatn'; transition: background-color 0.2s, color 0.2s; }
        .app-header button:hover { background-color: var(--danger-color); color: white; }

        /* Main Content Area */
        main {
            flex-grow: 1;
            position: relative;
            overflow: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ùˆ ØµÙØ­Ù‡ */
        }
        
        /* Universal View Styles */
        .view {
            height: 100%;
            display: none; /* All views hidden by default */
            flex-direction: column;
            overflow-y: auto;
        }
        .view.active {
            display: flex; /* Show active view */
        }
        
        /* Card Swiping View */
        .card-view { justify-content: center; align-items: center; position: relative; padding: 20px; }
        .profile-card { width: 100%; height: 100%; max-height: 500px; border-radius: 15px; background-size: cover; background-position: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: absolute; display: flex; flex-direction: column; justify-content: flex-end; color: white; transition: transform 0.4s ease, opacity 0.4s ease; }
        .profile-card.card--out-right { transform: translateX(150%) rotate(20deg); opacity: 0; }
        .profile-card.card--out-left { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
        .profile-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); border-radius: 0 0 15px 15px; }
        .card-info { padding: 20px; z-index: 2; }
        .card-info h2 { margin: 0 0 5px; } .card-info p { margin: 0; opacity: 0.9; }
        .status-message { font-size: 1.2em; color: #aaa; text-align: center; padding: 20px; }
        
        /* Chat Views */
        #conversation-list { padding: 10px 0; width: 100%; }
        .conversation-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .conversation-item:hover { background-color: var(--light-gray-color); }
        .conversation-item img { width: 50px; height: 50px; border-radius: 50%; margin-left: 15px; }
        .conversation-item h3 { margin: 0; font-size: 1.1em; }
        #single-chat-view { height: 100%; display: none; flex-direction: column; width: 100%;}
        .chat-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .chat-header button { background: none; border: none; font-size: 1.5em; cursor: pointer; margin-left: 10px; }
        .chat-header h2 { margin: 0; font-size: 1.2em; }
        #messages-area { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; word-wrap: break-word; }
        .message.sent { background-color: var(--sent-bg); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message.received { background-color: var(--received-bg); align-self: flex-end; border-bottom-right-radius: 4px; }
        #message-form { display: flex; padding: 10px; border-top: 1px solid var(--border-color); }
        #message-form input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 20px; font-family: 'Vazirmatn'; }
        #message-form button { background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-right: 10px; font-size: 1.5em; cursor: pointer; }

        /* Profile View (New) */
        .profile-header { padding: 25px; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid var(--border-color); }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-color); object-fit: cover; margin-bottom: 15px; }
        .profile-name { font-size: 1.5em; font-weight: 700; margin: 0; }
        .profile-status { font-size: 1em; color: var(--secondary-text-color); margin-top: 5px; }
        .profile-body { padding: 15px; }
        .profile-section-title { font-weight: 500; color: var(--primary-color); margin: 20px 10px 10px; font-size: 1em; }
        .profile-item { display: flex; align-items: center; padding: 15px 10px; cursor: pointer; transition: background-color 0.2s; }
        .profile-item:hover { background-color: var(--light-gray-color); }
        .profile-item .icon { font-size: 1.5em; color: var(--secondary-text-color); margin-left: 20px; width: 30px; text-align: center; }
        .profile-item .text-content { flex-grow: 1; }
        .profile-item .title { font-size: 1.1em; }
        .profile-item .subtitle { font-size: 0.9em; color: var(--secondary-text-color); }

        /* Main Footer Navigation */
        .main-footer { padding: 10px 0; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; }
        .nav-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #ccc; transition: color 0.2s, transform 0.2s; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--primary-color); transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header"><h1>Ù‡Ù…ÛŒØ§Ø±</h1><button id="logout-btn">Ø®Ø±ÙˆØ¬</button></header>

        <main>
            <!-- View 1: Card Swiping -->
            <div id="card-view" class="view active">
                <div class="card-view-content">
                    <div id="status-message" class="status-message">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
            </div>

            <!-- View 2: Chat -->
            <div id="chat-view" class="view">
                <div id="conversation-list"></div>
                <div id="single-chat-view">
                    <div class="chat-header">
                        <button id="back-to-list-btn">â¡ï¸</button>
                        <h2 id="chat-partner-name"></h2>
                    </div>
                    <div id="messages-area"></div>
                    <form id="message-form">
                        <input type="text" id="message-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." autocomplete="off">
                        <button type="submit">â¬†ï¸</button>
                    </form>
                </div>
            </div>
            
            <!-- View 3: Profile (New) -->
            <div id="profile-view" class="view">
                <div class="profile-header">
                    <img id="profile-avatar" src="https://i.pravatar.cc/200" alt="Ø¢ÙˆØ§ØªØ§Ø±" class="profile-avatar">
                    <h2 id="profile-name" class="profile-name">Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ</h2>
                    <p id="profile-status" class="profile-status">Ø¢Ù†Ù„Ø§ÛŒÙ†</p>
                </div>
                <div class="profile-body">
                    <div class="profile-section-title">Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</div>
                    <div class="profile-item">
                        <span class="icon">ğŸ“</span>
                        <div class="text-content">
                            <div class="title" id="profile-phone">+Û¹Û¸ Û¹Û°Û° Û°Û°Û° Û°Û°Û°Û°</div>
                            <div class="subtitle">Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¶Ø±Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯</div>
                        </div>
                    </div>
                    <div class="profile-item">
                        <span class="icon">@</span>
                        <div class="text-content">
                            <div class="title" id="profile-username">username</div>
                            <div class="subtitle">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</div>
                        </div>
                    </div>
                     <div class="profile-item">
                        <span class="icon">ğŸ“</span>
                        <div class="text-content">
                            <div class="title">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ</div>
                            <div class="subtitle">Ú†Ù†Ø¯ Ú©Ù„Ù…Ù‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯</div>
                        </div>
                    </div>
                    
                    <div class="profile-section-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
                     <div class="profile-item">
                        <span class="icon">ğŸ””</span>
                        <div class="text-content"><div class="title">Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ Ùˆ ØµØ¯Ø§Ù‡Ø§</div></div>
                    </div>
                     <div class="profile-item">
                        <span class="icon">ğŸ”’</span>
                        <div class="text-content"><div class="title">Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ Ùˆ Ø§Ù…Ù†ÛŒØª</div></div>
                    </div>
                     <div class="profile-item">
                        <span class="icon">ğŸ’¾</span>
                        <div class="text-content"><div class="title">Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ</div></div>
                    </div>
                </div>
            </div>

        </main>

        <footer class="main-footer">
            <button class="nav-btn" id="nav-chat-btn">ğŸ’¬</button>
            <button class="nav-btn active" id="nav-cards-btn">ğŸƒ</button>
            <button class="nav-btn" id="nav-profile-btn">ğŸ‘¤</button> <!-- New Button -->
        </footer>
    </div>

    <script>
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        
        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const cardView = document.getElementById('card-view');
        const chatView = document.getElementById('chat-view');
        const profileView = document.getElementById('profile-view'); // New
        
        const navBtns = document.querySelectorAll('.nav-btn');
        const navCardsBtn = document.getElementById('nav-cards-btn');
        const navChatBtn = document.getElementById('nav-chat-btn');
        const navProfileBtn = document.getElementById('nav-profile-btn'); // New

        const statusMessage = document.getElementById('status-message');
        const logoutBtn = document.getElementById('logout-btn');
        const conversationList = document.getElementById('conversation-list');
        const singleChatView = document.getElementById('single-chat-view');
        const messagesArea = document.getElementById('messages-area');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatPartnerName = document.getElementById('chat-partner-name');
        const backToListBtn = document.getElementById('back-to-list-btn');

        // --- App State ---
        let currentUser = null;
        let clientToken = null;
        let allUsersData = {};
        let matches = [];
        let activeChatPartner = null;
        let messagePollingInterval = null;

        // --- AUTH & INIT ---
        (async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(storedUser);
            
            navCardsBtn.addEventListener('click', () => showView('card-view'));
            navChatBtn.addEventListener('click', () => showView('chat-view'));
            navProfileBtn.addEventListener('click', () => showView('profile-view')); // New
            logoutBtn.addEventListener('click', logout);
            backToListBtn.addEventListener('click', showConversationList);
            messageForm.addEventListener('submit', handleSendMessage);
            
            await initializeApp();
        })();

        async function initializeApp() {
            try {
                await refreshClientToken();
                const allUsers = await fetchAllUsers();
                allUsers.forEach(user => { allUsersData[user.username] = user; });
                
                await initializeCardsView();
                await initializeChatView();
                initializeProfileView(); // New
            } catch (error) {
                console.error("Initialization Error:", error);
                statusMessage.textContent = `Ø®Ø·Ø§: ${error.message}`;
            }
        }

        // --- VIEW INITIALIZATION & MANAGEMENT ---

        function showView(viewId) {
            // Hide all views
            views.forEach(view => view.classList.remove('active'));
            // Deactivate all nav buttons
            navBtns.forEach(btn => btn.classList.remove('active'));

            // Show the target view
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.classList.add('active');

            // Activate the corresponding nav button
            const targetBtn = document.getElementById(`nav-${viewId.split('-')[0]}-btn`);
            if (targetBtn) targetBtn.classList.add('active');
            
            // Special logic for chat view
            if (viewId === 'chat-view') {
                 showConversationList();
            }
        }

        async function initializeCardsView() {
            statusMessage.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ÙˆØ§Ú©Ø´ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...';
            const seenUsers = await fetchSeenUsers();
            const usersToDisplay = Object.values(allUsersData).filter(user =>
                user.username !== currentUser.username && !seenUsers.includes(user.username)
            );
            if (usersToDisplay.length > 0) {
                 statusMessage.textContent = `${usersToDisplay.length} Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ ÛŒØ§ÙØª Ø´Ø¯!`;
            } else {
                 statusMessage.textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
            }
        }

        async function initializeChatView() {
            await fetchMatches();
            renderConversationList();
        }
        
        function initializeProfileView() {
            document.getElementById('profile-avatar').src = `https://i.pravatar.cc/200?u=${currentUser.username}`;
            document.getElementById('profile-name').textContent = currentUser.displayName;
            document.getElementById('profile-username').textContent = currentUser.username;
            // Phone number is not in the user object, so we'll use a placeholder.
        }

        // --- DATA FETCHING ---
        async function refreshClientToken() {
             const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
            if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ.');
            clientToken = (await response.json()).token;
        }
        async function fetchAllUsers() {
            const response = await fetch(`${PROXY_URL}?path=users`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú©Ø´ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.');
            const data = await response.json();
            return data ? Object.values(data) : [];
        }
        async function fetchSeenUsers() {
             const response = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!response.ok) return [];
            const data = await response.json();
            return data ? Object.keys(data) : [];
        }
        async function fetchMatches() {
            const myLikesResponse = await fetch(`${PROXY_URL}?path=interactions/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            if (!myLikesResponse.ok) return;
            const myLikesData = await myLikesResponse.json();
            if (!myLikesData) return;

            const myLikedUsers = Object.keys(myLikesData).filter(key => myLikesData[key] === 'liked');
            
            const matchPromises = myLikedUsers.map(async (likedUsername) => {
                const theirLikesResponse = await fetch(`${PROXY_URL}?path=interactions/${likedUsername}/${currentUser.username}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
                const theirAction = await theirLikesResponse.json();
                if (theirAction === 'liked') {
                    return allUsersData[likedUsername];
                }
                return null;
            });
            matches = (await Promise.all(matchPromises)).filter(Boolean);
        }
        
        // --- UI & INTERACTIONS ---
        function renderConversationList() {
            conversationList.innerHTML = '';
            if (matches.length === 0) {
                conversationList.innerHTML = '<div class="status-message">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† ØªØ·Ø§Ø¨Ù‚ÛŒ Ù†Ø¯Ø§Ø±ÛŒ!</div>';
                return;
            }
            matches.forEach(user => {
                const item = document.createElement('div');
                item.className = 'conversation-item';
                item.dataset.username = user.username;
                item.innerHTML = `<img src="https://i.pravatar.cc/100?u=${user.username}" alt="${user.displayName}"><h3>${user.displayName}</h3>`;
                item.addEventListener('click', () => openChat(user));
                conversationList.appendChild(item);
            });
        }

        function openChat(partner) {
            activeChatPartner = partner;
            conversationList.style.display = 'none';
            singleChatView.style.display = 'flex';
            chatPartnerName.textContent = partner.displayName;
            loadMessages();

            if (messagePollingInterval) clearInterval(messagePollingInterval);
            messagePollingInterval = setInterval(loadMessages, 5000);
        }

        function showConversationList() {
            activeChatPartner = null;
            conversationList.style.display = 'block';
            singleChatView.style.display = 'none';
            if (messagePollingInterval) clearInterval(messagePollingInterval);
        }

        async function loadMessages() {
            if (!activeChatPartner) return;
            const chatId = [currentUser.username, activeChatPartner.username].sort().join('_');
            const response = await fetch(`${PROXY_URL}?path=messages/${chatId}`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            const messagesData = await response.json();
            
            messagesArea.innerHTML = '';
            if (messagesData) {
                Object.values(messagesData).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message ' + (msg.senderId === currentUser.username ? 'sent' : 'received');
                    msgDiv.textContent = msg.text;
                    messagesArea.appendChild(msgDiv);
                });
            }
        }
        
        async function handleSendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !activeChatPartner) return;
            
            const chatId = [currentUser.username, activeChatPartner.username].sort().join('_');
            const message = {
                senderId: currentUser.username,
                text: text,
                timestamp: new Date().toISOString()
            };

            messageInput.value = '';
            
            await fetch(`${PROXY_URL}?path=messages/${chatId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` },
                body: JSON.stringify(message)
            });
            await loadMessages();
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

    </script>
</body>
</html>