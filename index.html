<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>همیار - در حال بارگذاری...</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            direction: rtl;
        }

        #loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #f8f9fa;
            color: #343a40;
            text-align: center;
            transition: opacity 0.5s ease;
        }

        #logo {
            width: 140px;
            height: auto;
            margin-bottom: 30px;
            animation: pulse 2.5s infinite ease-in-out;
            border-radius: 50%;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            }
            50% {
                transform: scale(1);
                box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            }
        }

        #status-message {
            font-size: 1.2em;
            font-weight: 500;
            color: #495057;
        }
        
        .spinner {
            border: 4px solid #dee2e6;
            border-radius: 50%;
            border-top: 4px solid #007bff;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin-top: 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="loading-container">
        <img src="https://raw.githubusercontent.com/abolfazl140122/miko_rel/c767edd7cb23c2f1a0314b935c515aa6b43c1905/%D9%84%D9%88%DA%AF%D9%88%20%D8%A7%D8%B3%DA%A9%D9%88%D8%B1%D8%AA%20%DA%AF%DB%8C%D9%85%20%D8%A8%D8%AF%D9%88%D9%86%20%D9%BE%D8%B3%20%D8%B2%D9%85%DB%8C%D9%86%D9%87.png" alt="لوگو اپلیکیشن همیار" id="logo">
        <p id="status-message">در حال بررسی وضعیت ورود...</p>
        <div id="spinner" class="spinner"></div>
    </div>

    <script>
        // --- CONFIG ---
        // !!! مهم: آدرس کامل سرور PHP خود را در اینجا قرار دهید
        const PROXY_SERVER_URL = 'https://your-domain.com/path/to/your/proxy.php'; 
        const REDIRECT_DELAY = 1500; // 1.5 ثانیه تاخیر قبل از هدایت کاربر

        // --- DOM Elements ---
        const statusMessageElement = document.getElementById('status-message');
        const spinnerElement = document.getElementById('spinner');

        /**
         * این تابع وظیفه اصلی بررسی وضعیت ورود کاربر را بر عهده دارد
         * با ارسال یک درخواست به سرور، اعتبار توکن و وجود کاربر را بررسی می‌کند
         */
        async function checkLoginStatus() {
            // مرحله ۱: سعی می‌کنیم اطلاعات جلسه کاربر را از localStorage بخوانیم
            const sessionDataString = localStorage.getItem('mikoUserSession');

            if (!sessionDataString) {
                // اگر هیچ اطلاعاتی ذخیره نشده بود، کاربر وارد نشده است
                console.log("No session data found. Redirecting to register.");
                redirectToRegister('به همیار خوش آمدید!');
                return;
            }

            let sessionData;
            try {
                sessionData = JSON.parse(sessionDataString);
                // بررسی می‌کنیم که اطلاعات لازم (توکن و نام کاربری) وجود داشته باشد
                if (!sessionData.token || !sessionData.username) {
                    throw new Error("Invalid session data structure.");
                }
            } catch (e) {
                // اگر داده ذخیره شده معتبر نبود، آن را پاک کرده و به صفحه ثبت‌نام هدایت می‌کنیم
                console.error("Failed to parse session data:", e);
                localStorage.removeItem('mikoUserSession');
                redirectToRegister('اطلاعات ورود شما نامعتبر است.');
                return;
            }

            // مرحله ۲: یک درخواست به سرور برای اعتبارسنجی ارسال می‌کنیم
            // بهترین راه برای بررسی، درخواست اطلاعات خود کاربر است. اگر موفقیت‌آمیز بود یعنی همه چیز درست است.
            const validationPath = `users/${sessionData.username}`;
            statusMessageElement.textContent = 'در حال اعتبارسنجی جلسه...';

            try {
                const response = await fetch(`${PROXY_SERVER_URL}?path=${validationPath}`, {
                    method: 'GET',
                    headers: {
                        // این هدرها برای احراز هویت در سرور PHP شما ضروری هستند
                        'Authorization': `Bearer ${sessionData.token}`,
                        'X-User-Username': sessionData.username
                    }
                });

                if (response.ok) {
                    // پاسخ موفقیت آمیز (کد 200) یعنی توکن معتبر است و کاربر وجود دارد
                    const userData = await response.json();
                    if (userData !== null) {
                        // کاربر با موفقیت اعتبارسنجی شد
                        console.log("Session validated successfully for user:", sessionData.username);
                        statusMessageElement.textContent = `خوش آمدید مجدد، ${userData.displayName || sessionData.username}!`;
                        spinnerElement.style.display = 'none';
                        setTimeout(() => window.location.href = 'safe_asli.html', REDIRECT_DELAY);
                    } else {
                        // این حالت یعنی کاربر از دیتابیس حذف شده است
                        throw new Error('User not found in database.');
                    }
                } else {
                    // اگر پاسخ موفقیت‌آمیز نبود (مثلا 401 Unauthorized)
                    throw new Error(`Server responded with status: ${response.status}`);
                }

            } catch (error) {
                // در صورت بروز هرگونه خطا (خطای شبکه، توکن نامعتبر، کاربر حذف شده و...)
                console.error("Session validation failed:", error.message);
                localStorage.removeItem('mikoUserSession');
                redirectToRegister('جلسه شما منقضی شده. لطفا مجدد وارد شوید.');
            }
        }
        
        /**
         * کاربر را به صفحه ثبت‌نام هدایت می‌کند
         * @param {string} message - پیامی که قبل از هدایت نمایش داده می‌شود
         */
        function redirectToRegister(message) {
            statusMessageElement.textContent = message;
            spinnerElement.style.display = 'none'; // اسپینر را مخفی می‌کنیم

            setTimeout(() => {
                window.location.href = 'register.html'; 
            }, REDIRECT_DELAY + 500); // کمی تاخیر بیشتر برای خواندن پیام
        }

        // اجرای تابع اصلی پس از بارگذاری کامل صفحه
        window.onload = checkLoginStatus;
    </script>
</body>
</html>
