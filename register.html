<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایجاد حساب کاربری - همیار</title>
    <style>
        /* ... کدهای CSS بدون تغییر باقی می‌مانند ... */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --error-color: #dc3545; --light-gray-color: #f8f9fa; --dark-gray-color: #6c757d; --border-color: #ced4da; }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; background-color: var(--light-gray-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px 0; }
        .form-container { width: 100%; max-width: 500px; background-color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); }
        .form-header { text-align: center; margin-bottom: 30px; }
        .form-header h1 { margin: 0 0 10px; font-size: 1.8em; color: #333; }
        .form-header p { margin: 0; color: var(--dark-gray-color); }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: 'Vazirmatn', sans-serif; transition: border-color 0.3s, box-shadow 0.3s; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        textarea { resize: vertical; min-height: 80px; }
        .error-message { color: var(--error-color); font-size: 0.85em; margin-top: 5px; display: none; }
        .profile-pic-group { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .profile-pic-group img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color); }
        .profile-pic-group label { cursor: pointer; background-color: #f1f1f1; padding: 10px 15px; border-radius: 8px; font-weight: 500; transition: background-color 0.3s; }
        .profile-pic-group label:hover { background-color: #e2e2e2; }
        .profile-pic-group input[type="file"] { display: none; }
        .terms-group { display: flex; align-items: center; gap: 10px; }
        .terms-group label { font-weight: 400; color: var(--dark-gray-color); }
        #submit-btn { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; }
        #submit-btn:hover { background-color: #0056b3; }
        #submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        #form-status { text-align: center; margin-top: 20px; padding: 12px; border-radius: 8px; display: none; }
        #form-status.success { background-color: #d4edda; color: #155724; }
        #form-status.error { background-color: #f8d7da; color: #721c24; }
        /* ✅✅✅ استایل جدید برای فوتر */
        .form-footer { margin-top: 25px; text-align: center; font-size: 0.9em; color: var(--dark-gray-color); border-top: 1px solid #eee; padding-top: 20px; }
        .form-footer a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .form-footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="form-container">
        <div class="form-header"><h1>ایجاد حساب کاربری</h1><p>به همیار بپیوندید و دوستان جدیدی پیدا کنید!</p></div>
        <form id="register-form" novalidate>
            <!-- ... فیلدهای فرم بدون تغییر باقی می‌مانند ... -->
            <div class="profile-pic-group"><img id="profile-preview" src="data:image/svg+xml;base64,..."><label for="profilePic">انتخاب تصویر</label><input type="file" id="profilePic" accept="image/*"></div>
            <div class="input-group"><label for="displayName">نام نمایشی</label><input type="text" id="displayName" required><div class="error-message" id="displayName-error"></div></div>
            <div class="input-group"><label for="username">نام کاربری (انگلیسی)</label><input type="text" id="username" required><div class="error-message" id="username-error"></div></div>
            <div class="input-group"><label for="mobile">شماره موبایل</label><input type="tel" id="mobile" required><div class="error-message" id="mobile-error"></div></div>
            <div style="display: flex; gap: 20px;"><div class="input-group" style="width: 50%;"><label for="age">سن</label><input type="number" id="age" required><div class="error-message" id="age-error"></div></div><div class="input-group" style="width: 50%;"><label for="gender">جنسیت</label><select id="gender" required><option value="" disabled selected>انتخاب کنید...</option><option value="male">مرد</option><option value="female">زن</option></select><div class="error-message" id="gender-error"></div></div></div>
            <div class="input-group"><label for="password">رمز عبور</label><input type="password" id="password" required><div class="error-message" id="password-error"></div></div>
            <div class="input-group"><label for="passwordConfirm">تکرار رمز عبور</label><input type="password" id="passwordConfirm" required><div class="error-message" id="passwordConfirm-error"></div></div>
            <div class="input-group"><label for="bio">درباره من (اختیاری)</label><textarea id="bio"></textarea></div>
            <div class="input-group"><label for="interests">علاقه‌مندی‌ها (اختیاری)</label><input type="text" id="interests"></div>
            <div class="input-group terms-group"><input type="checkbox" id="terms" required><label for="terms">با <a href="#">قوانین و مقررات</a> موافقم.</label><div class="error-message" id="terms-error"></div></div>
            <button type="submit" id="submit-btn" disabled>ثبت‌نام</button>
            <div id="form-status"></div>
        </form>
        <!-- ✅✅✅ تغییر کلیدی: اضافه شدن فوتر با لینک به صفحه ورود -->
        <div class="form-footer">
            حساب کاربری دارید؟ <a href="login.html">وارد شوید</a>
        </div>
    </div>

    <script>
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        
        // ... تمام کدهای جاوا اسکریپت اعتبارسنجی بدون تغییر باقی می‌مانند ...
        // (کدهای مربوط به inputs, showError, hideError, validateField, checkFormValidity)

        async function submitForm() {
            submitBtn.disabled = true;
            submitBtn.textContent = 'در حال ارسال...';
            formStatus.style.display = 'none';

            try {
                const tokenResponse = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
                if (!tokenResponse.ok) throw new Error('خطا در دریافت توکن.');
                const tokenData = await tokenResponse.json();

                const userData = {
                    displayName: inputs.displayName.value.trim(),
                    username: inputs.username.value.trim(),
                    mobile: inputs.mobile.value.trim(),
                    age: parseInt(inputs.age.value),
                    gender: inputs.gender.value,
                    password: inputs.password.value,
                    bio: document.getElementById('bio').value.trim(),
                    interests: document.getElementById('interests').value.trim().split('،').map(i => i.trim()),
                    createdAt: new Date().toISOString()
                };

                const registerResponse = await fetch(`${PROXY_URL}?path=users/${userData.username}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${tokenData.token}` },
                    body: JSON.stringify(userData)
                });

                if (!registerResponse.ok) throw new Error((await registerResponse.json()).error || 'خطا در ثبت اطلاعات.');
                
                // --- ✅✅✅ تغییر کلیدی: ذخیره اطلاعات کاربر در حافظه مرورگر ---
                localStorage.setItem('currentUser', JSON.stringify(userData));

                formStatus.textContent = 'ثبت‌نام با موفقیت انجام شد! در حال انتقال به صفحه اصلی...';
                formStatus.className = 'success';
                formStatus.style.display = 'block';
                
                // --- ✅✅✅ تغییر کلیدی: هدایت خودکار به صفحه اصلی ---
                setTimeout(() => {
                    window.location.href = 'safe_asli.html';
                }, 2000);

            } catch (error) {
                formStatus.textContent = error.message;
                formStatus.className = 'error';
                formStatus.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'ثبت‌نام';
            }
        }
    </script>
</body>
</html>
