<!DOCTYPE html>
<!-- 
    =============================================================================
    USAGE & CONFIGURATION
    =============================================================================
    این فایل نسخه اصلاح شده فرم ثبت‌نام است که قابلیت آپلود پیشرفته آواتار را پیاده‌سازی می‌کند.

    **تنظیمات اصلی (در بخش <script>):**
    1.  `PROXY_BASE_URL`: آدرس پایه پراکسی PHP خود را در اینجا قرار دهید.
        -   مقدار فعلی: 'https://miko.freehost.io/firebase_proxy.php'
    2.  `SHARED_SECRET`: کلید مخفی مشترک بین کلاینت و سرور برای دریافت توکن.
        -   مقدار فعلی: 'miko1234'
    3.  `FALLBACK_UPLOAD_URL`: یک آدرس جایگزین برای آپلود در صورت بروز خطای CORS.
        -   مقدار فعلی: 'https://miko.freehost.io/api/upload_profile.php'

    **نحوه تست (Test Cases):**
    -   **تست A (آپلود موفق):**
        1. فرم را با اطلاعات معتبر پر کنید.
        2. یک تصویر کوچک (کمتر از 5MB) با فرمت JPG یا PNG انتخاب کنید.
        3. دکمه ثبت‌نام را بزنید.
        4. در کنسول و تب Network، ابتدا درخواست ثبت‌نام (PUT) و سپس درخواست آپلود (POST) را بررسی کنید که با موفقیت (status 200) انجام شوند.
        5. در نهایت، درخواست PATCH برای به‌روزرسانی پروفایل کاربر با URL آواتار را مشاهده کنید.
        6. پیام موفقیت نمایش داده شده و به صفحه اصلی منتقل شوید.

    -   **تست B (تغییر اندازه خودکار):**
        1. یک تصویر بزرگ (بیشتر از 5MB) انتخاب کنید.
        2. در کنسول باید لاگ "Resizing image..." را مشاهده کنید.
        3. ادامه مراحل تست A را دنبال کنید. آپلود باید موفقیت‌آمیز باشد.

    -   **تست C (دریافت خودکار توکن):**
        1. در پنل توسعه‌دهنده (DevTools)، به تب Application -> Local Storage بروید و `client_token` را پاک کنید.
        2. فرم را ارسال کنید.
        3. در تب Network باید اولین درخواست برای `?auth=token` را ببینید که توکن جدید را دریافت می‌کند. سپس مراحل ثبت‌نام و آپلود انجام می‌شوند.

    -   **تست D (خطای شبکه و Fallback):**
        1. با استفاده از DevTools، تب Network را روی حالت "Offline" قرار دهید.
        2. دکمه ثبت‌نام را بزنید.
        3. باید پیام خطای مربوط به شبکه را در UI (`#form-status`) مشاهده کنید.
        4. (برای تست Fallback) اگر سرور شما برای مسیر اصلی خطای CORS برمی‌گرداند، در کنسول باید لاگ "CORS/Network error, trying fallback URL..." را مشاهده کنید و درخواست به مسیر جایگزین ارسال شود.
    =============================================================================
-->
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایجاد حساب کاربری (نسخه اصلاح‌شده) - همیار</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #007BFF;
            --primary-hover: #0056b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --background-color: #f0f2f5;
            --form-bg-color: #ffffff;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --border-color: #ced4da;
            --input-bg: #f8f9fa;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 15px;
        }

        .form-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--form-bg-color);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .form-header { text-align: center; margin-bottom: 25px; }
        .form-header h1 { margin: 0 0 10px; font-size: 1.9rem; color: var(--text-primary); }
        .form-header p { margin: 0; color: var(--text-secondary); font-size: 1rem; }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.95rem; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper svg { position: absolute; right: 15px; width: 20px; height: 20px; color: var(--text-secondary); pointer-events: none; }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--input-bg);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .input-group textarea { padding: 12px 15px; resize: vertical; min-height: 80px; }
        .input-group select { padding-right: 15px; } /* No icon for select */
        
        .error-message { color: var(--error-color); font-size: 0.85em; margin-top: 5px; min-height: 1.2em; display: none; }
        
        .profile-uploader { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 25px; cursor: pointer; }
        .profile-uploader .profile-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); background-color: #e9ecef; transition: border-color 0.3s; }
        .profile-uploader:hover .profile-preview { border-color: var(--primary-color); }
        .profile-uploader input[type="file"] { display: none; }
        
        #uploadStatus {
            font-size: 0.9em;
            margin-top: -5px;
            font-weight: 500;
            min-height: 1.2em;
            width: 100%;
            text-align: center;
        }
        #uploadStatus.success { color: var(--success-color); }
        #uploadStatus.error { color: var(--error-color); }

        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            height: 8px;
            margin-top: 5px;
            display: none; /* Hidden by default */
        }
        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }
        
        .form-row { display: flex; gap: 15px; }
        .form-row .input-group { flex: 1; }
        
        .terms-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .terms-group label { font-weight: 400; margin: 0; color: var(--text-secondary); }
        .terms-group a { color: var(--primary-color); text-decoration: none; }
        .terms-group a:hover { text-decoration: underline; }
        
        #submit-btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--primary-color);
            color: white; font-size: 1.1em; font-weight: 700; cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s; display: flex; justify-content: center; align-items: center;
        }
        #submit-btn:hover:not(:disabled) { background-color: var(--primary-hover); }
        #submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .spinner {
            width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff;
            border-radius: 50%; animation: spin 1s linear infinite; display: none;
        }
        #submit-btn.loading .spinner { display: block; }
        #submit-btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #form-status { text-align: center; margin-top: 20px; padding: 12px; border-radius: 8px; display: none; font-weight: 500; }
        #form-status.success { background-color: #d4edda; color: #155724; }
        #form-status.error { background-color: #f8d7da; color: #721c24; }

        .form-footer { margin-top: 25px; text-align: center; font-size: 0.9em; color: var(--text-secondary); border-top: 1px solid #eee; padding-top: 20px; }
        .form-footer a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .form-footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="form-container">
        <div class="form-header">
            <h1>ایجاد حساب کاربری</h1>
            <p>به همیار بپیوندید و دوستان جدیدی پیدا کنید!</p>
        </div>
        <form id="register-form" novalidate>
            <label for="profilePic" class="profile-uploader">
                <img id="profile-preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjZWQ0ZGEiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xOCAyMHYtMS4zNzJhNC45OSA0Ljk5IDAgMCAwLTIuNDgtNC4yOE02IDIwdi0xLjM3MmE0Ljk5IDQuOTkgMCAwIDEgMi40OC00LjI4TTQgMnYxM2E4IDggMCAwIDAgMTYgMFYyTTIgMjJoMjAiLz48Y2lyY2xlIGN4PSIxMiIgY3k9Ijgigcj0iNCIvPjwvc3ZnPg==" alt="Profile Preview" class="profile-preview">
                <span>انتخاب تصویر پروفایل</span>
                <input type="file" id="profilePic" accept="image/jpeg, image/png, image/webp">
                <div id="uploadStatus"></div>
                <div class="progress-bar" id="progressBar"><div class="progress-bar-inner" id="progressBarInner"></div></div>
            </label>

            <!-- Input مخفی برای نگهداری URL آواتار آپلود شده -->
            <input type="hidden" id="avatarUrl" name="avatarUrl">
            
            <div class="input-group"><label for="displayName">نام نمایشی</label><div class="input-wrapper"><input type="text" id="displayName" placeholder="نامی که دیگران می‌بینند" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="10" r="3"></circle><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"></path></svg></div><div class="error-message" id="displayName-error"></div></div>
            <div class="input-group"><label for="username">نام کاربری (انگلیسی)</label><div class="input-wrapper"><input type="text" id="username" placeholder="فقط حروف انگلیسی، اعداد و _" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M12 18h.01"></path><path d="M16 12h-4"></path></svg></div><div class="error-message" id="username-error"></div></div>
            <div class="input-group"><label for="mobile">شماره موبایل</label><div class="input-wrapper"><input type="tel" id="mobile" placeholder="مثال: 09123456789" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div><div class="error-message" id="mobile-error"></div></div>
            <div class="form-row"><div class="input-group"><label for="age">سن</label><input type="number" id="age" required min="18" max="99"><div class="error-message" id="age-error"></div></div><div class="input-group"><label for="gender">جنسیت</label><select id="gender" required><option value="" disabled selected>انتخاب...</option><option value="male">مرد</option><option value="female">زن</option></select><div class="error-message" id="gender-error"></div></div></div>
            <div class="input-group"><label for="password">رمز عبور</label><div class="input-wrapper"><input type="password" id="password" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div><div class="error-message" id="password-error"></div></div>
            <div class="input-group"><label for="passwordConfirm">تکرار رمز عبور</label><div class="input-wrapper"><input type="password" id="passwordConfirm" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 5-5 4.9 4.9 0 0 1 3.3.8"></path></svg></div><div class="error-message" id="passwordConfirm-error"></div></div>
            <div class="input-group"><label for="bio">درباره من (اختیاری)</label><textarea id="bio" placeholder="کمی درباره خودتان بنویسید..."></textarea></div>
            <div class="input-group"><label for="interests">علاقه‌مندی‌ها (اختیاری)</label><div class="input-wrapper"><input type="text" id="interests" placeholder="با ویرگول (،) جدا کنید"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"></path></svg></div></div>
            <div class="input-group terms-group"><input type="checkbox" id="terms" required style="width: auto;"><label for="terms">با <a href="#">قوانین و مقررات</a> موافقم.</label></div><div class="error-message" id="terms-error"></div>
            
            <button type="submit" id="submit-btn" disabled>
                <span>ثبت‌نام</span>
                <div class="spinner"></div>
            </button>
            <div id="form-status"></div>
        </form>
        <div class="form-footer">
            حساب کاربری دارید؟ <a href="login.html">وارد شوید</a>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PROXY_BASE_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        const FALLBACK_UPLOAD_URL = 'https://miko.freehost.io/api/upload_profile.php';

        // --- API URLs ---
        const TOKEN_API_URL = `${PROXY_BASE_URL}?auth=token`;
        const UPLOAD_API_URL = `${PROXY_BASE_URL}?path=upload_profile`;
        
        // --- Image Validation & Resize Config ---
        const ALLOWED_MIMETYPES = ['image/jpeg', 'image/png', 'image/webp'];
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB
        const RESIZE_MAX_WIDTH = 1024;
        const RESIZE_QUALITY = 0.8;

        // --- DOM Elements ---
        const form = document.getElementById('register-form');
        const submitBtn = document.getElementById('submit-btn');
        const formStatus = document.getElementById('form-status');
        const uploadStatus = document.getElementById('uploadStatus');
        const progressBar = document.getElementById('progressBar');
        const progressBarInner = document.getElementById('progressBarInner');
        
        const allInputs = {
            displayName: document.getElementById('displayName'),
            username: document.getElementById('username'),
            mobile: document.getElementById('mobile'),
            age: document.getElementById('age'),
            gender: document.getElementById('gender'),
            password: document.getElementById('password'),
            passwordConfirm: document.getElementById('passwordConfirm'),
            terms: document.getElementById('terms'),
            bio: document.getElementById('bio'),
            interests: document.getElementById('interests'),
            profilePic: document.getElementById('profilePic'),
            avatarUrl: document.getElementById('avatarUrl'),
        };

        let selectedFile = null; // To hold the validated (and possibly resized) file

        // --- Utility Functions ---
        function showError(fieldId, message) {
            const el = document.getElementById(`${fieldId}-error`);
            if (el) { el.textContent = message; el.style.display = 'block'; }
        }
        function hideError(fieldId) {
            const el = document.getElementById(`${fieldId}-error`);
            if (el) el.style.display = 'none';
        }
        
        function setUploadStatus(message, type = '') {
            uploadStatus.textContent = message;
            uploadStatus.className = type;
            progressBar.style.display = message && type !== 'error' && type !== 'success' ? 'block' : 'none';
        }
        
        function updateUploadProgress(percentage) {
            progressBarInner.style.width = `${percentage}%`;
            setUploadStatus(`در حال آپلود... ${percentage}%`);
        }

        // --- Validation Logic (No Changes) ---
        function validateField(fieldId) {
            const input = allInputs[fieldId];
            if (!input) return true; 

            hideError(fieldId);

            if (input.required && (input.type === 'checkbox' ? !input.checked : input.value.trim() === '')) {
                showError(fieldId, input.type === 'checkbox' ? 'شما باید با قوانین موافقت کنید.' : 'این فیلد الزامی است.');
                return false;
            }

            switch(fieldId) {
                case 'username': if (input.value && !/^[a-zA-Z0-9_]{3,15}$/.test(input.value)) { showError(fieldId, 'نام کاربری باید 3 تا 15 کاراکتر انگلیسی، عدد یا _ باشد.'); return false; } break;
                case 'mobile': if (input.value && !/^09\d{9}$/.test(input.value)) { showError(fieldId, 'فرمت شماره موبایل صحیح نیست (مثال: 09123456789).'); return false; } break;
                case 'age': if (input.value && (+input.value < 18 || +input.value > 99)) { showError(fieldId, 'سن شما باید بین 18 تا 99 سال باشد.'); return false; } break;
                case 'password': if (input.value && input.value.length < 8) { showError(fieldId, 'رمز عبور باید حداقل 8 کاراکتر باشد.'); return false; } break;
                case 'passwordConfirm': if (input.value && input.value !== allInputs.password.value) { showError(fieldId, 'رمزهای عبور مطابقت ندارند.'); return false; } break;
            }
            return true;
        }

        function checkFormValidity() {
            const requiredFields = ['displayName', 'username', 'mobile', 'age', 'gender', 'password', 'passwordConfirm', 'terms'];
            const isFormValid = requiredFields.every(key => validateField(key));
            submitBtn.disabled = !isFormValid;
            return isFormValid;
        }

        // --- New Core Functions ---

        /**
         * Gets a client token from the proxy, using localStorage for caching.
         * @returns {Promise<string>} The client token.
         */
        async function getClientToken() {
            let token = localStorage.getItem('client_token');
            if (token) {
                console.log("Using cached client_token from localStorage.");
                return token;
            }

            console.log("No cached token. Fetching a new one...");
            try {
                const response = await fetch(TOKEN_API_URL, {
                    headers: { 'X-Proxy-Secret': SHARED_SECRET }
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                const data = await response.json();
                if (!data.token) {
                    throw new Error("Token not found in server response.");
                }
                
                localStorage.setItem('client_token', data.token);
                console.log("New token fetched and cached.");
                return data.token;
            } catch (error) {
                console.error('Failed to get client token:', error);
                throw new Error("خطا در دریافت توکن احراز هویت. لطفاً اتصال اینترنت خود را بررسی کنید.");
            }
        }

        /**
         * Resizes an image file if it's too large.
         * @param {File} file The image file to resize.
         * @returns {Promise<Blob>} A promise that resolves with the resized image as a Blob.
         */
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let { width, height } = img;
                        if (width <= RESIZE_MAX_WIDTH && height <= RESIZE_MAX_WIDTH) {
                            return resolve(file); // No resize needed
                        }

                        if (width > height) {
                            height = Math.round((height * RESIZE_MAX_WIDTH) / width);
                            width = RESIZE_MAX_WIDTH;
                        } else {
                            width = Math.round((width * RESIZE_MAX_WIDTH) / height);
                            height = RESIZE_MAX_WIDTH;
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            console.log(`Image resized from ${file.size} to ${blob.size} bytes.`);
                            resolve(blob);
                        }, 'image/jpeg', RESIZE_QUALITY);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        /**
         * Uploads the profile picture using XMLHttpRequest for progress tracking.
         * @param {Blob} fileBlob The file to upload (could be resized).
         * @param {string} username The user's username for the X-User-Username header.
         * @param {string} token The client token for authorization.
         * @param {boolean} isFallback Whether this is a retry attempt with the fallback URL.
         * @returns {Promise<object>} A promise that resolves with the server's JSON response.
         */
        function uploadProfilePicture(fileBlob, username, token, isFallback = false) {
            return new Promise((resolve, reject) => {
                const url = isFallback ? FALLBACK_UPLOAD_URL : UPLOAD_API_URL;
                console.log(`Attempting to upload to: ${url}`);
                if(isFallback) console.warn("Using fallback URL for upload.");

                const formData = new FormData();
                formData.append('file', fileBlob, 'profile.jpg'); // Filename is useful for server
                formData.append('type', 'avatar');

                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                
                // Set headers
                xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                xhr.setRequestHeader('X-User-Username', username);

                // Log headers for debugging (excluding the full token in production is better)
                console.log("Uploading with headers:", {
                    'Authorization': `Bearer ${token.substring(0, 10)}...`,
                    'X-User-Username': username
                });

                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percentage = Math.round((event.loaded * 100) / event.total);
                        updateUploadProgress(percentage);
                    }
                };

                xhr.onload = () => {
                    console.log(`Upload response status: ${xhr.status}`);
                    console.log(`Upload response text: ${xhr.responseText}`);
                    
                    try {
                        const result = JSON.parse(xhr.responseText);
                        if (xhr.status >= 200 && xhr.status < 300 && result.success) {
                            resolve(result);
                        } else {
                            reject(new Error(result.message || 'خطای ناشناخته از سرور هنگام آپلود.'));
                        }
                    } catch (e) {
                        reject(new Error('پاسخ سرور برای آپلود تصویر معتبر نبود.'));
                    }
                };

                xhr.onerror = () => {
                    console.error("XHR onerror triggered. This is likely a network or CORS error.");
                    // If it's the first attempt, try the fallback URL
                    if (!isFallback) {
                        console.log("CORS/Network error detected, trying fallback URL...");
                        uploadProfilePicture(fileBlob, username, token, true).then(resolve).catch(reject);
                    } else {
                        reject(new Error('خطای شبکه هنگام آپلود تصویر. اتصال اینترنت خود را بررسی کنید.'));
                    }
                };

                xhr.send(formData);
            });
        }
        
        // --- Event Listeners ---
        Object.values(allInputs).forEach(input => {
            if(!input) return;
            const eventType = ['checkbox', 'select-one', 'file'].includes(input.type) ? 'change' : 'input';
            input.addEventListener(eventType, checkFormValidity);
        });

        allInputs.profilePic.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) {
                selectedFile = null;
                return;
            }

            // Reset status
            setUploadStatus('', '');
            updateUploadProgress(0);

            // 1. Validate file type
            if (!ALLOWED_MIMETYPES.includes(file.type)) {
                setUploadStatus(`نوع فایل نامعتبر است. فقط ${ALLOWED_MIMETYPES.map(t => t.split('/')[1]).join(', ')} مجاز است.`, 'error');
                selectedFile = null;
                return;
            }

            // 2. Show preview immediately
            const reader = new FileReader();
            reader.onload = (event) => { document.getElementById('profile-preview').src = event.target.result; }
            reader.readAsDataURL(file);

            // 3. Check file size and resize if necessary
            setUploadStatus('در حال آماده‌سازی تصویر...', '');
            try {
                if (file.size > MAX_FILE_SIZE) {
                    console.log("File is too large, resizing...");
                    selectedFile = await resizeImage(file);
                } else {
                    selectedFile = file;
                }
                setUploadStatus('تصویر آماده آپلود است.', 'success');
            } catch (error) {
                console.error("Error processing image:", error);
                setUploadStatus('خطا در پردازش تصویر.', 'error');
                selectedFile = null;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (checkFormValidity()) {
                await submitForm();
            }
        });

        // --- Form Submission (Heavily Modified) ---
        async function submitForm() {
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            formStatus.style.display = 'none';

            try {
                // 1. Get client token (critical first step)
                const clientToken = await getClientToken();
                
                const userData = {
                    displayName: allInputs.displayName.value.trim(),
                    username: allInputs.username.value.trim().toLowerCase(),
                    mobile: allInputs.mobile.value.trim(),
                    age: parseInt(allInputs.age.value),
                    gender: allInputs.gender.value,
                    password: allInputs.password.value,
                    bio: allInputs.bio.value.trim(),
                    interests: allInputs.interests.value.trim().split('،').map(s => s.trim()).filter(Boolean),
                    createdAt: new Date().toISOString(),
                    isOnline: false,
                    lastSeen: new Date().toISOString()
                    // avatarUrl will be added later via PATCH
                };

                // 2. Register user data first
                console.log("Registering user data...");
                const registerResponse = await fetch(`${PROXY_BASE_URL}?path=users/${userData.username}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${clientToken}`
                    },
                    body: JSON.stringify(userData)
                });
                
                if (!registerResponse.ok) {
                    const errorData = await registerResponse.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || 'خطا در ثبت اطلاعات کاربر.');
                }
                console.log("User registration successful.");

                // 3. If registration is successful, upload profile picture (if selected)
                if (selectedFile) {
                    const uploadResult = await uploadProfilePicture(selectedFile, userData.username, clientToken);
                    console.log('Upload successful:', uploadResult);

                    setUploadStatus('آپلود موفق بود!', 'success');
                    
                    // Set hidden input and update preview with final thumb URL
                    allInputs.avatarUrl.value = uploadResult.data.url;
                    document.getElementById('profile-preview').src = uploadResult.data.thumb_url;

                    // 4. (Optional but recommended) Patch user data with avatar URLs
                    await fetch(`${PROXY_BASE_URL}?path=users/${userData.username}`, {
                        method: 'PATCH',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${clientToken}`
                        },
                        body: JSON.stringify({
                            avatarUrl: uploadResult.data.url,
                            thumbUrl: uploadResult.data.thumb_url
                        })
                    });
                    console.log("User profile patched with avatar URLs.");
                }
                
                // 5. Final success step
                localStorage.setItem('currentUser', JSON.stringify({
                    username: userData.username,
                    displayName: userData.displayName
                }));
                
                formStatus.textContent = 'ثبت‌نام موفق بود! در حال انتقال...';
                formStatus.className = 'success';
                formStatus.style.display = 'block';
                
                setTimeout(() => { window.location.href = 'safe_asli.html'; }, 2000);

            } catch (error) {
                console.error("Full registration error:", error);
                formStatus.textContent = error.message;
                formStatus.style.display = 'block';
                formStatus.className = 'error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        }
    </script>
</body>
</html>
