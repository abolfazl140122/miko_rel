<!DOCTYPE html>
<!-- 
====================================================================================================
    USAGE & CONFIGURATION GUIDE
====================================================================================================

    این فایل برای مدیریت ثبت‌نام و آپلود تصویر پروفایل اصلاح شده است.

    1.  تنظیمات اصلی (Constants):
        -   در تگ <script>، مقادیر زیر را در صورت نیاز تغییر دهید:
            -   `PROXY_BASE_URL`: آدرس پایه پراکسی شما (مثال: 'https://miko.freehost.io').
            -   `SHARED_SECRET`: کلید مخفی مشترک برای دریافت توکن (مثال: 'miko1234').
            -   `MAX_FILE_SIZE_BYTES`: حداکثر حجم مجاز فایل قبل از تغییر اندازه (پیش‌فرض: 5MB).
            -   `RESIZE_MAX_DIMENSION`: حداکثر طول یا عرض تصویر پس از تغییر اندازه (پیش‌فرض: 1024px).

    2.  نحوه تست (Testing Steps):
        -   تست A (آپلود موفق):
            1. فرم را با اطلاعات معتبر پر کنید (مخصوصاً نام کاربری).
            2. یک تصویر کوچک (کمتر از 5MB) با فرمت jpg یا png انتخاب کنید.
            3. وضعیت "در حال آپلود..." و سپس "آپلود موفق!" باید نمایش داده شود.
            4. در تب Network مرورگر، درخواست به `.../firebase_proxy.php?path=upload_profile` با status 200 را بررسی کنید.
            5. پس از ثبت‌نام، بررسی کنید که `avatarUrl` در دیتابیس شما ذخیره شده باشد.

        -   تست B (تغییر اندازه خودکار):
            1. یک تصویر بزرگ (بیشتر از 5MB) انتخاب کنید.
            2. در کنسول باید لاگ "Image is too large. Resizing..." را مشاهده کنید.
            3. فرآیند آپلود باید پس از تغییر اندازه با موفقیت انجام شود.

        -   تست C (دریافت توکن خودکار):
            1. در تب Application مرورگر، `localStorage` را پاک کنید تا `client_token` حذف شود.
            2. یک تصویر انتخاب کنید.
            3. در تب Network، باید ابتدا یک درخواست به `.../firebase_proxy.php?auth=token` و سپس درخواست آپلود را ببینید.

        -   تست D (خطای شبکه و Fallback):
            1. در تب Network، آدرس `.../firebase_proxy.php?path=upload_profile` را بلاک کنید.
            2. یک تصویر انتخاب کنید. آپلود اول با خطا مواجه می‌شود.
            3. در کنسول، باید لاگ "Primary upload failed... Trying fallback..." را مشاهده کنید.
            4. کد باید به صورت خودکار درخواست دوم را به `.../api/upload_profile.php` ارسال کند.

    3.  نکات امنیتی:
        -   لاگ‌های مربوط به توکن در کنسول (`console.log('Using token:', token.substring(0, 15))`) برای دیباگ است. 
            قبل از انتشار نسخه نهایی، این لاگ‌ها را حذف یا غیرفعال کنید.

====================================================================================================
-->
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ایجاد حساب کاربری - همیار (نسخه اصلاح‌شده)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        
        :root {
            --primary-color: #007BFF;
            --primary-hover: #0056b3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --background-color: #f0f2f5;
            --form-bg-color: #ffffff;
            --text-primary: #333;
            --text-secondary: #6c757d;
            --border-color: #ced4da;
            --input-bg: #f8f9fa;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px 15px;
        }

        .form-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--form-bg-color);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .form-header { text-align: center; margin-bottom: 25px; }
        .form-header h1 { margin: 0 0 10px; font-size: 1.9rem; color: var(--text-primary); }
        .form-header p { margin: 0; color: var(--text-secondary); font-size: 1rem; }

        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; font-size: 0.95rem; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-wrapper svg { position: absolute; right: 15px; width: 20px; height: 20px; color: var(--text-secondary); pointer-events: none; }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--input-bg);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .input-group textarea { padding: 12px 15px; resize: vertical; min-height: 80px; }
        .input-group select { padding-right: 15px; }
        
        .error-message { color: var(--error-color); font-size: 0.85em; margin-top: 5px; min-height: 1.2em; display: none; }
        
        .profile-uploader { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 25px; cursor: pointer; position: relative; }
        .profile-uploader .profile-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--border-color); background-color: #e9ecef; transition: all 0.3s; }
        .profile-uploader:hover .profile-preview { border-color: var(--primary-color); transform: scale(1.05); }
        .profile-uploader span { font-weight: 500; color: var(--primary-color); }
        .profile-uploader input[type="file"] { display: none; }
        
        #uploadStatus { font-size: 0.9em; font-weight: 500; min-height: 1.2em; text-align: center; }
        #uploadStatus.success { color: var(--success-color); }
        #uploadStatus.error { color: var(--error-color); }

        .progress-bar-container { width: 100%; max-width: 150px; height: 8px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; display: none; margin-top: 5px; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--primary-color); border-radius: 4px; transition: width 0.3s ease-in-out; }
        
        .form-row { display: flex; gap: 15px; }
        .form-row .input-group { flex: 1; }
        
        .terms-group { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .terms-group label { font-weight: 400; margin: 0; color: var(--text-secondary); }
        .terms-group a { color: var(--primary-color); text-decoration: none; }
        .terms-group a:hover { text-decoration: underline; }
        
        #submit-btn { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: var(--primary-color); color: white; font-size: 1.1em; font-weight: 700; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; display: flex; justify-content: center; align-items: center; }
        #submit-btn:hover:not(:disabled) { background-color: var(--primary-hover); }
        #submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        #submit-btn.loading .spinner { display: block; }
        #submit-btn.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #form-status { text-align: center; margin-top: 20px; padding: 12px; border-radius: 8px; display: none; font-weight: 500; }
        #form-status.success { background-color: #d4edda; color: #155724; }
        #form-status.error { background-color: #f8d7da; color: #721c24; }

        .form-footer { margin-top: 25px; text-align: center; font-size: 0.9em; color: var(--text-secondary); border-top: 1px solid #eee; padding-top: 20px; }
        .form-footer a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .form-footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <div class="form-container">
        <div class="form-header">
            <h1>ایجاد حساب کاربری</h1>
            <p>به همیار بپیوندید و دوستان جدیدی پیدا کنید!</p>
        </div>
        <form id="register-form" novalidate>
            
            <label for="profilePic" class="profile-uploader">
                <img id="profile-preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjZWQ0ZGEiIHN0cm9rZS13aWR0aD0iMS41IiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xOCAyMHYtMS4zNzJhNC45OSA0Ljk5IDAgMCAwLTIuNDgtNC4yOE02IDIwdi0xLjM3MmE0Ljk5IDQuOTkgMCAwIDEgMi40OC00LjI4TTQgMnYxM2E4IDggMCAwIDAgMTYgMFYyTTIgMjJoMjAiLz48Y2lyY2xlIGN4PSIxMiIgY3k9Ijgigcj0iNCIvPjwvc3ZnPg==" alt="Profile Preview" class="profile-preview">
                <span>انتخاب تصویر پروفایل</span>
                <input type="file" id="profilePic" accept="image/jpeg, image/png, image/webp">
                <div id="uploadStatus"></div>
                <div class="progress-bar-container" id="progress-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
            </label>
            
            <!-- فیلد مخفی برای نگهداری URL آواتار آپلود شده -->
            <input type="hidden" id="avatarUrl" name="avatarUrl" value="">

            <!-- سایر فیلدهای فرم (بدون هیچ تغییری) -->
            <div class="input-group"><label for="displayName">نام نمایشی</label><div class="input-wrapper"><input type="text" id="displayName" placeholder="نامی که دیگران می‌بینند" required><svg xmlns="http://www.w.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="10" r="3"></circle><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"></path></svg></div><div class="error-message" id="displayName-error"></div></div>
            <div class="input-group"><label for="username">نام کاربری (انگلیسی)</label><div class="input-wrapper"><input type="text" id="username" placeholder="فقط حروف انگلیسی، اعداد و _" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M12 18h.01"></path><path d="M16 12h-4"></path></svg></div><div class="error-message" id="username-error"></div></div>
            <div class="input-group"><label for="mobile">شماره موبایل</label><div class="input-wrapper"><input type="tel" id="mobile" placeholder="مثال: 09123456789" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div><div class="error-message" id="mobile-error"></div></div>
            <div class="form-row"><div class="input-group"><label for="age">سن</label><input type="number" id="age" required min="18" max="99"><div class="error-message" id="age-error"></div></div><div class="input-group"><label for="gender">جنسیت</label><select id="gender" required><option value="" disabled selected>انتخاب...</option><option value="male">مرد</option><option value="female">زن</option></select><div class="error-message" id="gender-error"></div></div></div>
            <div class="input-group"><label for="password">رمز عبور</label><div class="input-wrapper"><input type="password" id="password" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div><div class="error-message" id="password-error"></div></div>
            <div class="input-group"><label for="passwordConfirm">تکرار رمز عبور</label><div class="input-wrapper"><input type="password" id="passwordConfirm" required><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 5-5 4.9 4.9 0 0 1 3.3.8"></path></svg></div><div class="error-message" id="passwordConfirm-error"></div></div>
            <div class="input-group"><label for="bio">درباره من (اختیاری)</label><textarea id="bio" placeholder="کمی درباره خودتان بنویسید..."></textarea></div>
            <div class="input-group"><label for="interests">علاقه‌مندی‌ها (اختیاری)</label><div class="input-wrapper"><input type="text" id="interests" placeholder="با ویرگول (،) جدا کنید"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"></path></svg></div></div>
            <div class="input-group terms-group"><input type="checkbox" id="terms" required style="width: auto;"><label for="terms">با <a href="#">قوانین و مقررات</a> موافقم.</label></div><div class="error-message" id="terms-error"></div>
            
            <button type="submit" id="submit-btn" disabled>
                <span>ثبت‌نام</span>
                <div class="spinner"></div>
            </button>
            <div id="form-status"></div>
        </form>
        <div class="form-footer">
            حساب کاربری دارید؟ <a href="login.html">وارد شوید</a>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const form = document.getElementById('register-form');
        const submitBtn = document.getElementById('submit-btn');
        const formStatus = document.getElementById('form-status');
        const uploadStatusEl = document.getElementById('uploadStatus');
        const profilePreview = document.getElementById('profile-preview');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const allInputs = {
            displayName: document.getElementById('displayName'),
            username: document.getElementById('username'),
            mobile: document.getElementById('mobile'),
            age: document.getElementById('age'),
            gender: document.getElementById('gender'),
            password: document.getElementById('password'),
            passwordConfirm: document.getElementById('passwordConfirm'),
            terms: document.getElementById('terms'),
            bio: document.getElementById('bio'),
            interests: document.getElementById('interests'),
            profilePic: document.getElementById('profilePic'),
            avatarUrl: document.getElementById('avatarUrl')
        };

        // --- Configuration Constants ---
        const PROXY_BASE_URL = 'https://miko.freehost.io';
        const SHARED_SECRET = 'miko1234';
        const PRIMARY_UPLOAD_URL = `${PROXY_BASE_URL}/firebase_proxy.php?path=upload_profile`;
        const FALLBACK_UPLOAD_URL = `${PROXY_BASE_URL}/api/upload_profile.php`; // Fallback for CORS/Network issues
        const TOKEN_URL = `${PROXY_BASE_URL}/firebase_proxy.php?auth=token`;
        
        // --- File Upload Constants ---
        const ALLOWED_MIMETYPES = ['image/jpeg', 'image/png', 'image/webp'];
        const MAX_FILE_SIZE_BYTES = 5 * 1024 * 1024; // 5 MB
        const RESIZE_MAX_DIMENSION = 1024; // Resize largest dimension to 1024px
        const RESIZE_QUALITY = 0.8; // JPEG quality

        // --- Utility Functions ---
        function showError(fieldId, message) {
            const el = document.getElementById(`${fieldId}-error`);
            if (el) { el.textContent = message; el.style.display = 'block'; }
        }
        function hideError(fieldId) {
            const el = document.getElementById(`${fieldId}-error`);
            if (el) el.style.display = 'none';
        }
        function setUploadStatus(message, type = '') {
            uploadStatusEl.textContent = message;
            uploadStatusEl.className = type;
            progressContainer.style.display = (type === 'uploading') ? 'block' : 'none';
        }
        function updateUploadProgress(percentage) {
            progressBar.style.width = `${percentage}%`;
            setUploadStatus(`در حال آپلود (${Math.round(percentage)}%)...`, 'uploading');
        }

        // --- Validation Logic (Unchanged) ---
        function validateField(fieldId) {
            const input = allInputs[fieldId];
            if (!input) return true; 

            hideError(fieldId);

            if (input.required && (input.type === 'checkbox' ? !input.checked : input.value.trim() === '')) {
                showError(fieldId, input.type === 'checkbox' ? 'شما باید با قوانین موافقت کنید.' : 'این فیلد الزامی است.');
                return false;
            }

            switch(fieldId) {
                case 'username': if (input.value && !/^[a-zA-Z0-9_]{3,15}$/.test(input.value)) { showError(fieldId, 'نام کاربری باید 3 تا 15 کاراکتر انگلیسی، عدد یا _ باشد.'); return false; } break;
                case 'mobile': if (input.value && !/^09\d{9}$/.test(input.value)) { showError(fieldId, 'فرمت شماره موبایل صحیح نیست (مثال: 09123456789).'); return false; } break;
                case 'age': if (input.value && (+input.value < 18 || +input.value > 99)) { showError(fieldId, 'سن شما باید بین 18 تا 99 سال باشد.'); return false; } break;
                case 'password': if (input.value && input.value.length < 8) { showError(fieldId, 'رمز عبور باید حداقل 8 کاراکتر باشد.'); return false; } break;
                case 'passwordConfirm': if (input.value && input.value !== allInputs.password.value) { showError(fieldId, 'رمزهای عبور مطابقت ندارند.'); return false; } break;
            }
            return true;
        }

        function checkFormValidity() {
            const requiredFields = ['displayName', 'username', 'mobile', 'age', 'gender', 'password', 'passwordConfirm', 'terms'];
            const isFormValid = requiredFields.every(key => validateField(key));
            submitBtn.disabled = !isFormValid;
            return isFormValid;
        }

        // --- Event Listeners ---
        Object.values(allInputs).forEach(input => {
            if(!input || input.type === 'file' || input.type === 'hidden') return;
            const eventType = ['checkbox', 'select-one'].includes(input.type) ? 'change' : 'input';
            input.addEventListener(eventType, checkFormValidity);
        });

        allInputs.profilePic.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleProfilePictureSelection(file);
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (checkFormValidity()) {
                await submitForm();
            }
        });
        
        // --- NEW & REFACTORED LOGIC ---

        /**
         * Handles the entire process after a user selects a profile picture.
         * @param {File} file The selected file object.
         */
        async function handleProfilePictureSelection(file) {
            submitBtn.disabled = true; // Disable form submission during upload
            setUploadStatus('در حال آماده‌سازی...', '');

            // 1. Show immediate preview
            const reader = new FileReader();
            reader.onload = (event) => { profilePreview.src = event.target.result; };
            reader.readAsDataURL(file);

            // 2. Validate username
            if (!allInputs.username.value.trim()) {
                setUploadStatus('لطفاً ابتدا نام کاربری را وارد کنید.', 'error');
                showError('username', 'نام کاربری برای آپلود تصویر الزامی است.');
                submitBtn.disabled = !checkFormValidity();
                return;
            }

            // 3. Validate file type and size
            if (!ALLOWED_MIMETYPES.includes(file.type)) {
                setUploadStatus(`نوع فایل نامعتبر است. (${ALLOWED_MIMETYPES.join(', ')})`, 'error');
                submitBtn.disabled = !checkFormValidity();
                return;
            }

            let fileToUpload = file;
            if (file.size > MAX_FILE_SIZE_BYTES) {
                setUploadStatus('حجم عکس زیاد است، در حال بهینه‌سازی...', '');
                console.log(`Image is too large (${file.size} bytes). Resizing...`);
                try {
                    fileToUpload = await resizeImage(file, RESIZE_MAX_DIMENSION, RESIZE_QUALITY);
                } catch (err) {
                    console.error('Image resize failed:', err);
                    setUploadStatus('خطا در بهینه‌سازی تصویر.', 'error');
                    submitBtn.disabled = !checkFormValidity();
                    return;
                }
            }

            // 4. Start the upload process
            try {
                const result = await uploadFileWithProgress(fileToUpload, allInputs.username.value.trim());
                setUploadStatus('آپلود موفق!', 'success');
                allInputs.avatarUrl.value = result.url; // Save final URL to hidden input
                profilePreview.src = result.thumb_url || result.url; // Update preview with server thumbnail
                console.log('Upload successful. Avatar URL set:', result.url);
            } catch (error) {
                setUploadStatus(`خطا در آپلود: ${error.message}`, 'error');
                console.error('Upload failed:', error);
            } finally {
                submitBtn.disabled = !checkFormValidity(); // Re-evaluate form validity
            }
        }

        /**
         * Resizes an image using a canvas.
         * @param {File} file The image file to resize.
         * @param {number} maxWidth The maximum width/height.
         * @param {number} quality The JPEG quality (0 to 1).
         * @returns {Promise<Blob>} A promise that resolves with the resized image as a Blob.
         */
        function resizeImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;

                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxWidth) {
                                width = Math.round((width * maxWidth) / height);
                                height = maxWidth;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            if (blob) {
                                console.log(`Resized image from ${file.size} to ${blob.size} bytes.`);
                                resolve(blob);
                            } else {
                                reject(new Error('Canvas toBlob conversion failed.'));
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }


        /**
         * Fetches a client token from the proxy if not already in localStorage.
         * @returns {Promise<string>} A promise that resolves with the token.
         */
        async function getClientToken() {
            let token = localStorage.getItem('client_token');
            if (token) {
                console.log('Using cached token from localStorage.');
                return token;
            }

            console.log('No cached token. Fetching a new one...');
            try {
                const response = await fetch(TOKEN_URL, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }
                const data = await response.json();
                if (!data.token) {
                    throw new Error('Token not found in server response.');
                }
                localStorage.setItem('client_token', data.token);
                console.log('New token fetched and stored.');
                return data.token;
            } catch (error) {
                console.error('Failed to get client token:', error);
                throw new Error('خطا در دریافت توکن احراز هویت.');
            }
        }

        /**
         * Uploads a file using XMLHttpRequest to show progress and handles fallback.
         * @param {Blob|File} file The file/blob to upload.
         * @param {string} username The user's username.
         * @returns {Promise<object>} A promise that resolves with the JSON response from the server.
         */
        async function uploadFileWithProgress(file, username) {
            const token = await getClientToken();
            
            const performUpload = (url, isFallback = false) => {
                return new Promise((resolve, reject) => {
                    console.log(`[${isFallback ? 'Fallback' : 'Primary'}] Attempting to upload to:`, url);
                    
                    const xhr = new XMLHttpRequest();
                    const formData = new FormData();
                    formData.append('file', file, file.name || 'profile.jpg');
                    
                    xhr.open('POST', url, true);
                    
                    // Set Headers
                    xhr.setRequestHeader('Authorization', `Bearer ${token}`);
                    xhr.setRequestHeader('X-User-Username', username);
                    console.log('DEBUG: Upload Headers Sent:', {
                        'Authorization': `Bearer ${token.substring(0, 15)}...`, // Log truncated token for security
                        'X-User-Username': username
                    });

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percentage = (event.loaded / event.total) * 100;
                            updateUploadProgress(percentage);
                        }
                    };

                    xhr.onload = () => {
                        console.log(`[${isFallback ? 'Fallback' : 'Primary'}] Response Status:`, xhr.status);
                        console.log(`[${isFallback ? 'Fallback' : 'Primary'}] Response Text:`, xhr.responseText);
                        try {
                            const responseJson = JSON.parse(xhr.responseText);
                            if (xhr.status >= 200 && xhr.status < 300 && responseJson.success) {
                                resolve(responseJson);
                            } else {
                                reject(new Error(responseJson.message || `خطای سرور (${xhr.status})`));
                            }
                        } catch (e) {
                            reject(new Error('پاسخ دریافتی از سرور نامعتبر است.'));
                        }
                    };

                    xhr.onerror = () => {
                        // This handles network errors (e.g., CORS, DNS, offline)
                        reject(new Error('خطای شبکه یا CORS.'));
                    };
                    
                    xhr.ontimeout = () => {
                        reject(new Error('درخواست آپلود زمان‌بر شد.'));
                    };

                    xhr.send(formData);
                });
            };

            try {
                return await performUpload(PRIMARY_UPLOAD_URL);
            } catch (error) {
                console.warn(`Primary upload failed: "${error.message}". Trying fallback...`);
                // Only try fallback on network-related errors.
                if (error.message.includes('شبکه') || error.message.includes('CORS')) {
                    return await performUpload(FALLBACK_UPLOAD_URL, true);
                }
                // If it's a server error (e.g., 4xx, 5xx), don't fallback.
                throw error;
            }
        }
        
        /**
         * Main form submission logic.
         */
        async function submitForm() {
            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            formStatus.style.display = 'none';

            try {
                const token = await getClientToken(); // Get token for registration as well
                
                const userData = {
                    displayName: allInputs.displayName.value.trim(),
                    username: allInputs.username.value.trim().toLowerCase(),
                    mobile: allInputs.mobile.value.trim(),
                    age: parseInt(allInputs.age.value),
                    gender: allInputs.gender.value,
                    password: allInputs.password.value,
                    bio: allInputs.bio.value.trim(),
                    interests: allInputs.interests.value.trim().split('،').map(i => i.trim()),
                    avatarUrl: allInputs.avatarUrl.value, // Get URL from hidden input
                    createdAt: new Date().toISOString(),
                    isOnline: false,
                    lastSeen: new Date().toISOString()
                };

                // NOTE: Changed from PUT to POST as requested.
                const registerResponse = await fetch(`${PROXY_BASE_URL}/firebase_proxy.php?path=users/${userData.username}`, {
                    method: 'POST', // Changed from PUT
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${token}`,
                        'X-User-Username': userData.username // Consistent header
                    },
                    body: JSON.stringify(userData)
                });
                
                const responseData = await registerResponse.json().catch(() => ({}));
                if (!registerResponse.ok) {
                    throw new Error(responseData.error || 'خطا در ثبت اطلاعات در سرور.');
                }
                
                localStorage.setItem('currentUser', JSON.stringify({
                    username: userData.username,
                    displayName: userData.displayName
                }));
                
                formStatus.textContent = 'ثبت‌نام موفق بود! در حال انتقال به صفحه اصلی...';
                formStatus.className = 'success';
                formStatus.style.display = 'block';
                
                setTimeout(() => { window.location.href = 'safe_asli.html'; }, 2000);

            } catch (error) {
                formStatus.textContent = error.message;
                formStatus.style.display = 'block';
                formStatus.className = 'error';
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        }

    </script>
</body>
</html>
