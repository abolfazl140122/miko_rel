<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ - Ù‡Ù…ÛŒØ§Ø±</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
    :root {
      --primary-color: #007BFF;
      --primary-hover: #0056b3;
      --success-color: #28a745;
      --error-color: #dc3545;
      --text-light: #f8f9fa;
      --border-color: rgba(255, 255, 255, 0.4);
      --input-bg: rgba(255, 255, 255, 0.2);
    }
    body {
      font-family: 'Vazirmatn', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #74EBD5 0%, #9FACE6 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .form-container {
      width: 100%;
      max-width: 420px;
      background-color: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 40px;
      border-radius: 20px;
      border: 1px solid var(--border-color);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    .form-header { text-align: center; margin-bottom: 30px; }
    .form-header h1 {
      margin: 0;
      font-size: 2.2em;
      color: var(--text-light);
      font-weight: 700;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    .form-header p {
      margin: 5px 0 0;
      color: var(--text-light);
      font-size: 1.1em;
    }
    .input-group {
      position: relative;
      margin-bottom: 25px;
    }
    .input-group input {
      width: 100%;
      padding: 14px 45px 14px 15px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--input-bg);
      color: var(--text-light);
      font-size: 1em;
      transition: all 0.3s ease;
    }
    .input-group input:focus {
      outline: none;
      border-color: white;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.3);
    }
    .input-group .input-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,0.7);
    }
    #submit-btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      background-color: var(--primary-color);
      color: white;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    #submit-btn:hover { background-color: var(--primary-hover); }
    #submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #form-status {
      text-align: center;
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 500;
      display: none;
    }
    #form-status.success { background-color: rgba(40,167,69,0.8); color: #fff; }
    #form-status.error { background-color: rgba(220,53,69,0.8); color: #fff; }
    .form-footer {
      margin-top: 25px;
      text-align: center;
      color: var(--text-light);
    }
    .form-footer a {
      color: var(--text-light);
      font-weight: bold;
      text-decoration: none;
    }
  </style>
</head>
<body>

  <div class="form-container">
    <div class="form-header">
      <h1>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</h1>
      <p>Ø®ÙˆØ´Ø­Ø§Ù„ÛŒÙ… Ú©Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ù…Ø§ Ø±Ø§ Ù…ÛŒâ€ŒØ¨ÛŒÙ†ÛŒÙ…!</p>
    </div>

    <form id="login-form">
      <div class="input-group">
        <input type="text" id="identifier" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ù…ÙˆØ¨Ø§ÛŒÙ„" required />
        <span class="input-icon">ðŸ‘¤</span>
      </div>

      <div class="input-group">
        <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required />
        <span class="input-icon">ðŸ”’</span>
      </div>

      <button type="submit" id="submit-btn" disabled>
        <span id="btn-text">ÙˆØ±ÙˆØ¯</span>
        <div class="spinner" id="btn-spinner"></div>
      </button>

      <div id="form-status"></div>
    </form>

    <div class="form-footer">
      Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="register.html">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</a>
    </div>
  </div>

  <script>
    const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
    const SHARED_SECRET = 'miko1234';

    const form = document.getElementById('login-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnSpinner = document.getElementById('btn-spinner');
    const formStatus = document.getElementById('form-status');
    const identifierInput = document.getElementById('identifier');
    const passwordInput = document.getElementById('password');

    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡ ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ù¾Ø± Ù‡Ø³ØªÙ†Ø¯
    [identifierInput, passwordInput].forEach(el => el.addEventListener('input', () => {
      submitBtn.disabled = !(identifierInput.value.trim() && passwordInput.value);
    }));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      await handleLogin();
    });

    async function handleLogin() {
      submitBtn.disabled = true;
      btnSpinner.style.display = 'block';
      btnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...';
      formStatus.style.display = 'none';

      const usernameOrMobile = identifierInput.value.trim();
      const password = passwordInput.value.trim();

      try {
        // Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ø² Ø³Ø±ÙˆØ± PHP
        const tokenRes = await fetch(`${PROXY_URL}?auth=token`, {
          headers: { 'X-Proxy-Secret': SHARED_SECRET }
        });
        if (!tokenRes.ok) throw new Error('Ø¹Ø¯Ù… Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ø² Ø³Ø±ÙˆØ±.');
        const tokenData = await tokenRes.json();
        const token = tokenData.token;

        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Firebase
        const headers = {
          'Authorization': `Bearer ${token}`,
          'X-User-Username': usernameOrMobile
        };

        let userData = null;
        const isMobile = /^09\d{9}$/.test(usernameOrMobile);

        if (isMobile) {
          const queryParams = new URLSearchParams({ orderBy: '"mobile"', equalTo: `"${usernameOrMobile}"` });
          const response = await fetch(`${PROXY_URL}?path=users&${queryParams.toString()}`, { headers });
          if (!response.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±.');
          const result = await response.json();
          if (result && Object.keys(result).length > 0) userData = Object.values(result)[0];
        } else {
          const response = await fetch(`${PROXY_URL}?path=users/${usernameOrMobile}`, { headers });
          if (response.status === 200) userData = await response.json();
        }

        if (!userData || userData.password !== password) {
          throw new Error('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
        }

        // âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ - Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
        formStatus.textContent = `Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${userData.displayName}!`;
        formStatus.className = 'success';
        formStatus.style.display = 'block';

        setTimeout(() => { window.location.href = 'safe_asli.html'; }, 1500);

      } catch (err) {
        formStatus.textContent = err.message;
        formStatus.className = 'error';
        formStatus.style.display = 'block';
        submitBtn.disabled = false;
        btnSpinner.style.display = 'none';
        btnText.textContent = 'ÙˆØ±ÙˆØ¯';
      }
    }
  </script>

</body>
</html>
