<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ú©Ø§Ù†Ø§Ù„ Ù‡Ù…ÛŒØ§Ø±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- SECTION: Ù…ØªØºÛŒØ±Ù‡Ø§ Ùˆ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ --- */
        :root {
            --background-primary: #101418;
            --background-secondary: #181c20;
            --background-tertiary: #22282e;
            --primary-accent: #00AFFF;
            --primary-accent-glow: rgba(0, 175, 255, 0.3);
            --text-primary: #EAECEF;
            --text-secondary: #8A939E;
            --border-color: #30363d;
            --message-out-bg: linear-gradient(135deg, #007BFF, #00AFFF);
            --message-in-bg: #2C3238;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --blur-effect: saturate(150%) blur(10px);
        }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            background: #0D1117;
            color: var(--text-primary);
            user-select: none; -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            width: 100%; max-width: 450px; height: 100vh;
            background-color: var(--background-primary);
            display: flex; flex-direction: column; 
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            border-radius: 0;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 480px) {
            .app-container {
                max-height: 95vh;
                border-radius: 20px;
                border: 1px solid var(--border-color);
            }
        }

        /* --- SECTION: Ù‡Ø¯Ø± ØµÙØ­Ù‡ --- */
        .app-header {
            padding: 12px 15px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background-color: rgba(24, 28, 32, 0.8);
            backdrop-filter: var(--blur-effect); -webkit-backdrop-filter: var(--blur-effect);
            flex-shrink: 0; z-index: 10;
        }
        .channel-info { display: flex; align-items: center; gap: 12px; overflow: hidden; }
        .channel-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary-accent); display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.2em; color: white; flex-shrink: 0; }
        .channel-details { display: flex; flex-direction: column; overflow: hidden; }
        .channel-details h1 { font-size: 1.1em; margin: 0; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;}
        .channel-meta { font-size: 0.8em; color: var(--text-secondary); }
        .header-actions { display: flex; align-items: center; gap: 5px; }
        .header-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 50%; transition: background-color 0.2s, color 0.2s; }
        .header-btn:hover { background-color: var(--background-tertiary); color: var(--text-primary); }

        /* --- SECTION: Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ù…Ø­ØªÙˆØ§ --- */
        main { flex-grow: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .search-bar { display: none; padding: 10px 15px; background: var(--background-secondary); }
        .search-bar.active { display: block; }
        .search-bar input { width: 100%; padding: 10px 15px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--background-tertiary); color: var(--text-primary); }
        
        /* --- SECTION: ÙÛŒØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ --- */
        .message-feed { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message-wrapper { display: flex; flex-direction: column; margin-bottom: 5px; transition: opacity 0.3s, transform 0.3s; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .message-bubble { 
            max-width: 85%; padding: 10px 15px; border-radius: 18px; font-size: 0.95em; 
            word-wrap: break-word; line-height: 1.6; position: relative;
        }
        .message-bubble.out { background: var(--message-out-bg); color: white; border-bottom-right-radius: 5px; align-self: flex-end; }
        .message-bubble.in { background-color: var(--message-in-bg); border-bottom-left-radius: 5px; align-self: flex-start; }
        
        .message-bubble img, .message-bubble video { max-width: 100%; border-radius: 10px; margin-top: 8px; }
        .audio-player { display: flex; align-items: center; gap: 10px; margin-top: 8px; }

        .message-reactions { position: absolute; bottom: -12px; left: 10px; display: flex; gap: 4px; }
        .message-bubble.out .message-reactions { right: 10px; left: auto; }
        .reaction-pill { 
            font-size: 0.7em; padding: 2px 6px; background: var(--background-tertiary); 
            border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); cursor: pointer;
            transition: transform 0.2s;
        }
        .reaction-pill:hover { transform: scale(1.1); }
        .reaction-pill.user-reacted { background: var(--primary-accent); color: white; }

        .message-time { font-size: 0.7em; color: var(--text-secondary); margin: 4px 8px 10px 8px; align-self: flex-end; }
        .message-bubble.in + .message-time { align-self: flex-start; }

        .typing-indicator { display: none; align-items: center; gap: 5px; padding: 5px 15px; color: var(--text-secondary); font-style: italic; font-size: 0.9em; }
        .typing-indicator.active { display: flex; }
        .typing-dot { width: 5px; height: 5px; background: var(--text-secondary); border-radius: 50%; animation: typing-bounce 1.2s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* --- SECTION: Ù†ÙˆØ§Ø± ÙˆØ±ÙˆØ¯ÛŒ Ù¾ÛŒØ§Ù… --- */
        .message-input-area { 
            display: flex; align-items: center; padding: 10px 15px; 
            border-top: 1px solid var(--border-color); background-color: var(--background-secondary); flex-shrink: 0;
        }
        .message-input-wrapper { display: flex; align-items: center; background: var(--background-tertiary); border-radius: 25px; flex-grow: 1; padding: 0 5px; }
        .message-input-wrapper input[type="text"] { 
            flex-grow: 1; background: transparent; border: none; padding: 12px 15px; 
            color: var(--text-primary); font-family: 'Vazirmatn', sans-serif; font-size: 1em; 
        }
        .message-input-wrapper input:focus { outline: none; }
        .input-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 10px; transition: color 0.2s; }
        .input-btn:hover { color: var(--primary-accent); }
        .send-btn { 
            background: var(--primary-accent); color: white; border: none; border-radius: 50%; 
            width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; margin-left: 8px; flex-shrink: 0; transition: transform 0.2s, box-shadow 0.2s;
        }
        .send-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--primary-accent-glow); }
        .send-btn:disabled { background-color: var(--text-secondary); cursor: not-allowed; }

        /* --- SECTION: ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ùˆ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ --- */
        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; color: var(--text-secondary); padding: 20px; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--background-tertiary); border-top-color: var(--primary-accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .offline-indicator {
            display: none; position: absolute; top: 0; left: 0; right: 0;
            background-color: var(--danger-color); color: white; text-align: center;
            padding: 5px; font-size: 0.8em; z-index: 100;
        }
        .offline-indicator.active { display: block; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            backdrop-filter: var(--blur-effect); -webkit-backdrop-filter: var(--blur-effect);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--background-secondary); padding: 25px; border-radius: 15px;
            width: 90%; max-width: 380px; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transform: scale(0.9); transition: transform 0.3s; border: 1px solid var(--border-color);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-title { margin-top: 0; font-size: 1.5em; }
        .input-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .input-group label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; }
        .input-group input, .input-group textarea {
            background-color: var(--background-tertiary); border: 1px solid var(--border-color); border-radius: 10px;
            padding: 12px 15px; color: var(--text-primary); font-family: 'Vazirmatn', sans-serif; font-size: 1em;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex-grow: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; font-size: 1em; transition: opacity 0.2s; }
        .modal-btn:hover { opacity: 0.9; }
        .save-btn { background-color: var(--primary-accent); color: white; }
        .cancel-btn { background-color: var(--background-tertiary); color: var(--text-primary); }
        
        #attachment-preview-img { max-width: 100%; max-height: 200px; border-radius: 10px; margin-bottom: 15px; }

    </style>
</head>
<body>

<div class="app-container">
    <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
    <header class="app-header">
        <div class="channel-info">
            <div class="channel-avatar" id="channel-avatar">H</div>
            <div class="channel-details">
                <h1 id="page-title">Ù‡Ù…ÛŒØ§Ø±</h1>
                <div class="channel-meta">
                    <span id="member-count">0 Ø¹Ø¶Ùˆ</span> - <span id="online-status">Ø¢ÙÙ„Ø§ÛŒÙ†</span>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="header-btn" id="search-btn" title="Ø¬Ø³ØªØ¬Ùˆ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            <button class="header-btn" id="edit-channel-btn" title="ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù†Ø§Ù„">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h3"></path><path d="M18.37 3.63a2.12 2.12 0 1 1 3 3L12.5 15.5l-4 1 1-4Z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <main id="main-content">
        <!-- Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
    </main>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù†Ø§Ù„ -->
<div class="modal-overlay" id="edit-modal">
    <div class="modal-content">
        <h2 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ù†Ø§Ù„</h2>
        <div class="input-group">
            <label for="edit-channel-name">Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„</label>
            <input type="text" id="edit-channel-name">
        </div>
        <div class="input-group">
            <label for="edit-channel-desc">ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù†Ø§Ù„</label>
            <textarea id="edit-channel-desc" rows="3"></textarea>
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel-btn" id="cancel-edit-btn">Ø§Ù†ØµØ±Ø§Ù</button>
            <button class="modal-btn save-btn" id="save-edit-btn">Ø°Ø®ÛŒØ±Ù‡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ -->
<div class="modal-overlay" id="attachment-preview-modal">
    <div class="modal-content">
        <h2 class="modal-title">Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„</h2>
        <img id="attachment-preview-img" src="" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´">
        <div class="input-group">
            <label for="attachment-caption">Ú©Ù¾Ø´Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <input type="text" id="attachment-caption" placeholder="ÛŒÚ© ØªÙˆØ¶ÛŒØ­ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel-btn" id="cancel-attachment-btn">Ø§Ù†ØµØ±Ø§Ù</button>
            <button class="modal-btn save-btn" id="send-attachment-btn">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>
</div>

<!-- ÙØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒ Ù…Ø®ÙÛŒ -->
<input type="file" id="file-input" accept="image/*,video/*" style="display:none;">

<script>
// --- SECTION: Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ---
const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
const SHARED_SECRET = 'miko1234';

// --- SECTION: Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ DOM ---
const mainContent = document.getElementById('main-content');
const pageTitle = document.getElementById('page-title');
// ... (Ø³Ø§ÛŒØ± Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¯Ø± ØªÙˆØ§Ø¨Ø¹ Ù…Ø±Ø¨ÙˆØ·Ù‡ ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯)

// --- SECTION: ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ù†Ø§Ù…Ù‡ (State) ---
let state = {
    currentUser: null,
    clientToken: null,
    currentChannelData: null,
    isChannelCreator: false,
    messages: [],
    pollingIntervalId: null,
    originalTitle: document.title,
    unreadMessages: 0,
    isTabActive: true,
    selectedFile: null
};

// --- SECTION: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    renderLoadingSpinner();
    
    // Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† ØªØ¨
    document.addEventListener('visibilitychange', () => {
        state.isTabActive = document.visibilityState === 'visible';
        if (state.isTabActive) {
            state.unreadMessages = 0;
            document.title = state.originalTitle;
        }
    });

    // Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
    window.addEventListener('online', () => handleConnectionChange(true));
    window.addEventListener('offline', () => handleConnectionChange(false));
    handleConnectionChange(navigator.onLine);

    const storedUser = localStorage.getItem('currentUser');
    if (!storedUser) {
        return renderErrorMessage('Ø®Ø·Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª. Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
    }
    state.currentUser = JSON.parse(storedUser);

    try {
        await refreshClientToken();
    } catch (error) {
        return renderErrorMessage(error.message);
    }

    const channelIdFromUrl = new URLSearchParams(window.location.search).get('id');
    if (channelIdFromUrl) {
        await loadChannelData(channelIdFromUrl);
    } else {
        renderCreationForm(); // Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ÙØ±Ø¶ Ø¨Ø± Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø§ ID ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
    }
}

// --- SECTION: ØªÙˆØ§Ø¨Ø¹ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù¾Ø±Ø§Ú©Ø³ÛŒ ---
async function refreshClientToken() {
    const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
    if (!response.ok) throw new Error('Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ù…Ù†ÛŒØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
    const data = await response.json();
    state.clientToken = data.token;
}

async function proxyRequest(path, method = 'GET', data = null) {
    if (!state.clientToken || !state.currentUser) throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    const options = { method, headers: { 'Authorization': `Bearer ${state.clientToken}`, 'X-User-Username': state.currentUser.username } };
    if (data) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(data);
    }
    const response = await fetch(`${PROXY_URL}?path=${path}`, options);
    if (!response.ok) {
        if (response.status === 404) return null;
        const errorData = await response.json().catch(() => ({ error: 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡' }));
        throw new Error(errorData.error || `Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± (Ú©Ø¯: ${response.status})`);
    }
    if (response.status === 204 || response.headers.get("content-length") === "0") return null;
    return response.json();
}

// --- SECTION: Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ ---
async function loadChannelData(channelId) {
    try {
        const channelData = await proxyRequest(`channels/${channelId}?limitToLast=50`); // Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§ ÛµÛ° Ù¾ÛŒØ§Ù… Ø¢Ø®Ø±
        if (channelData) {
            state.currentChannelData = channelData;
            state.isChannelCreator = channelData.creator_username === state.currentUser.username;
            state.messages = channelData.channel_messages ? Object.entries(channelData.channel_messages).map(([key, value]) => ({...value, id: key})) : [];
            
            renderChannelView();
            startRealtimeUpdates();
        } else {
            renderErrorMessage('Ú©Ø§Ù†Ø§Ù„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.', true);
        }
    } catch (error) {
        renderErrorMessage(error.message);
    }
}

// --- SECTION: ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† (UI Rendering) ---
function renderLoadingSpinner() {
    mainContent.innerHTML = `<div class="status-container"><div class="spinner"></div><p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p></div>`;
}

function renderErrorMessage(message) {
    mainContent.innerHTML = `<div class="status-container"><p>${message}</p></div>`;
    document.querySelector('.app-header').style.display = 'none'; // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ø¯Ø± Ø¯Ø± Ø²Ù…Ø§Ù† Ø®Ø·Ø§
}

function renderCreationForm() {
    // Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ØªÙ…Ø±Ú©Ø² Ø¨Ø± ØµÙØ­Ù‡ Ú†Øª Ø§Ø³Øª. Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø¨ÙˆØ¯Ù† Ø¢ÙˆØ±Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.
    pageTitle.textContent = 'Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯';
    mainContent.innerHTML = `<div class="status-container"><p>Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©Ø§Ù†Ø§Ù„ØŒ Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.</p></div>`;
}

function renderChannelView() {
    // Ø±Ù†Ø¯Ø± Ù‡Ø¯Ø±
    document.getElementById('page-title').textContent = state.currentChannelData.channel_name;
    document.getElementById('channel-avatar').textContent = state.currentChannelData.channel_name.charAt(0).toUpperCase();
    document.getElementById('member-count').textContent = `${state.currentChannelData.members_count || 1} Ø¹Ø¶Ùˆ`;
    document.getElementById('online-status').textContent = state.currentChannelData.is_online ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†';
    document.getElementById('edit-channel-btn').style.display = state.isChannelCreator ? 'block' : 'none';

    // Ø±Ù†Ø¯Ø± Ø¨Ø¯Ù†Ù‡ Ø§ØµÙ„ÛŒ Ú†Øª
    mainContent.innerHTML = `
        <div class="search-bar" id="search-bar">
            <input type="text" id="search-input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...">
        </div>
        <div class="message-feed" id="message-feed"></div>
        <div class="typing-indicator" id="typing-indicator">
            <span>Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾</span>
            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
        </div>
        <div id="offline-indicator" class="offline-indicator">Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯...</div>
        ${state.isChannelCreator ? `
        <div class="message-input-area">
            <div class="message-input-wrapper">
                <button class="input-btn" id="attach-file-btn" title="Ø§ÙØ²ÙˆØ¯Ù† ÙØ§ÛŒÙ„">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </button>
                <input type="text" id="message-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                <button class="input-btn" title="Ø§ÛŒÙ…ÙˆØ¬ÛŒ">ğŸ˜Š</button>
            </div>
            <button class="send-btn" id="send-message-btn" title="Ø§Ø±Ø³Ø§Ù„">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>` : ''}
    `;
    renderMessages(state.messages);
    setupEventListeners();
}

function renderMessages(messages) {
    const messageFeed = document.getElementById('message-feed');
    if (!messageFeed) return;

    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù†
    messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    let html = '';
    messages.forEach(msg => {
        if (!msg || typeof msg !== 'object') return;
        const messageClass = msg.sender_username === state.currentUser.username ? 'out' : 'in';
        const time = new Date(msg.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        
        let contentHtml = '';
        if(msg.type === 'image' && msg.file_url) {
            contentHtml = `<img src="${msg.file_url}" alt="${msg.caption || ''}" loading="lazy">`;
            if (msg.caption) contentHtml += `<p>${msg.caption}</p>`;
        } else {
            contentHtml = (msg.message_text || '').replace(/\n/g, '<br>');
        }

        let reactionsHtml = '<div class="message-reactions">';
        const availableReactions = ['â¤ï¸', 'ğŸ‘', 'ğŸ˜‚'];
        availableReactions.forEach(emoji => {
            const count = msg.reactions?.[emoji]?.count || 0;
            if (count > 0) {
                 const userReacted = msg.reactions[emoji].users?.includes(state.currentUser.username) ? 'user-reacted' : '';
                 reactionsHtml += `<div class="reaction-pill ${userReacted}" onclick="handleReactionClick('${msg.id}', '${emoji}')">${emoji} ${count}</div>`;
            }
        });
        reactionsHtml += '</div>';

        html += `
            <div class="message-wrapper" data-message-id="${msg.id}">
                <div class="message-bubble ${messageClass}">
                    ${contentHtml}
                    ${reactionsHtml}
                </div>
                <div class="message-time">${time}</div>
            </div>`;
    });
    messageFeed.innerHTML = html;
}

// --- SECTION: Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ (Event Handlers) ---
function setupEventListeners() {
    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡Ø¯Ø±
    document.getElementById('search-btn').addEventListener('click', toggleSearchBar);
    if(state.isChannelCreator) {
        document.getElementById('edit-channel-btn').addEventListener('click', openEditModal);
    }
    
    // Ø¬Ø³ØªØ¬Ùˆ
    document.getElementById('search-input').addEventListener('input', handleSearch);

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
    if (state.isChannelCreator) {
        const messageInput = document.getElementById('message-input');
        document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleSendMessage(); });
        messageInput.addEventListener('input', debounce(handleTyping, 500));
        document.getElementById('attach-file-btn').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', handleFileSelect);
    }

    // Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§
    document.getElementById('cancel-edit-btn').addEventListener('click', closeEditModal);
    document.getElementById('save-edit-btn').addEventListener('click', handleSaveChanges);
    document.getElementById('cancel-attachment-btn').addEventListener('click', closeAttachmentModal);
    document.getElementById('send-attachment-btn').addEventListener('click', handleSendAttachment);
}

function toggleSearchBar() {
    document.getElementById('search-bar').classList.toggle('active');
}

function handleSearch(event) {
    const query = event.target.value.toLowerCase();
    const messages = document.querySelectorAll('.message-wrapper');
    messages.forEach(msg => {
        const text = msg.querySelector('.message-bubble').textContent.toLowerCase();
        msg.style.display = text.includes(query) ? 'flex' : 'none';
    });
}

async function handleSendMessage() {
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text) return;
    
    const tempId = `temp_${Date.now()}`;
    const messageData = {
        sender_username: state.currentUser.username,
        message_text: text,
        timestamp: new Date().toISOString()
    };
    
    input.value = '';
    // Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ´Ø¨ÛŒÙ†Ø§Ù†Ù‡ Ù¾ÛŒØ§Ù… Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒÚ©Ù†ÛŒÙ…
    state.messages.push({...messageData, id: tempId});
    renderMessages(state.messages);

    try {
        const path = `channels/${state.currentChannelData.channel_id}/channel_messages`;
        await proxyRequest(path, 'POST', messageData);
        await proxyRequest(`channels/${state.currentChannelData.channel_id}/is_typing`, 'POST', false); // ØªÙˆÙ‚Ù ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯
    } catch (error) {
        alert('Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: ' + error.message);
        // Ù¾ÛŒØ§Ù… Ù…ÙˆÙ‚Øª Ø±Ø§ Ø­Ø°Ù Ù…ÛŒÚ©Ù†ÛŒÙ…
        state.messages = state.messages.filter(m => m.id !== tempId);
        renderMessages(state.messages);
    }
}

async function handleTyping() {
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø·Ù„Ø§Ø¹ Ø¯Ù‡Ø¯ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾ Ø§Ø³Øª
    await proxyRequest(`channels/${state.currentChannelData.channel_id}/is_typing`, 'POST', true);
    // Ùˆ ÛŒÚ© ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ ØªÙˆÙ‚Ù ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯ Ø¨Ø¹Ø¯ Ø§Ø² Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø¹Ø¯Ù… ÙØ¹Ø§Ù„ÛŒØª
    setTimeout(async () => {
         await proxyRequest(`channels/${state.currentChannelData.channel_id}/is_typing`, 'POST', false);
    }, 3000);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    state.selectedFile = file;

    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('attachment-preview-img').src = e.target.result;
        document.getElementById('attachment-preview-modal').classList.add('active');
    };
    reader.readAsDataURL(file);
}

async function handleSendAttachment() {
    if (!state.selectedFile) return;
    // **Ù†Ú©ØªÙ‡:** Ù…Ù†Ø·Ù‚ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ù¾Ø±Ø§Ú©Ø³ÛŒ Ø´Ù…Ø§ Ø¨Ø³ØªÚ¯ÛŒ Ø¯Ø§Ø±Ø¯.
    // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ØŒ Ù…Ø§ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø´Ù…Ø§ ÛŒÚ© endpoint Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø¯Ø§Ø±ÛŒØ¯ Ùˆ URL Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯.
    alert('Ù‚Ø§Ø¨Ù„ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø§Ø³Øª. Ø§ÛŒÙ† ÛŒÚ© Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³Øª.');
    
    const caption = document.getElementById('attachment-caption').value.trim();
    const messageData = {
        sender_username: state.currentUser.username,
        type: 'image',
        file_url: 'https://via.placeholder.com/300', // URL ÙØ±Ø¶ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù¾Ù„ÙˆØ¯
        caption: caption,
        timestamp: new Date().toISOString()
    };

    try {
        const path = `channels/${state.currentChannelData.channel_id}/channel_messages`;
        await proxyRequest(path, 'POST', messageData);
        closeAttachmentModal();
    } catch (error) {
        alert('Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: ' + error.message);
    }
}

async function handleReactionClick(messageId, emoji) {
    // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ù…Ù†Ø·Ù‚ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª
    const path = `channels/${state.currentChannelData.channel_id}/channel_messages/${messageId}/reactions/${emoji}`;
    // Ø¯Ø± Ø­Ø§Ù„Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ ÛŒÚ© transaction Ø¯Ø± Ø³Ø±ÙˆØ± Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
    alert(`Ø±ÛŒâ€ŒØ§Ú©Ø´Ù† ${emoji} Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… ${messageId} Ú©Ù„ÛŒÚ© Ø´Ø¯. Ù…Ù†Ø·Ù‚ Ú©Ø§Ù…Ù„ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ Ø³Ø±ÙˆØ± Ø§Ø³Øª.`);
}

function openEditModal() {
    document.getElementById('edit-channel-name').value = state.currentChannelData.channel_name;
    document.getElementById('edit-channel-desc').value = state.currentChannelData.description || '';
    document.getElementById('edit-modal').classList.add('active');
}

function closeEditModal() { document.getElementById('edit-modal').classList.remove('active'); }
function closeAttachmentModal() { document.getElementById('attachment-preview-modal').classList.remove('active'); state.selectedFile = null; }

async function handleSaveChanges() {
    const newName = document.getElementById('edit-channel-name').value.trim();
    const newDesc = document.getElementById('edit-channel-desc').value.trim();

    const dataToUpdate = { channel_name: newName, description: newDesc };

    try {
        // Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ú†Ù†Ø¯ ÙÛŒÙ„Ø¯ Ø§Ø² PATCH (Ú©Ù‡ Ù¾Ø±Ø§Ú©Ø³ÛŒ Ø¨Ù‡ Ø¢Ù† ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        await proxyRequest(`channels/${state.currentChannelData.channel_id}`, 'PATCH', dataToUpdate);
        state.currentChannelData.channel_name = newName;
        state.currentChannelData.description = newDesc;
        document.getElementById('page-title').textContent = newName;
        closeEditModal();
    } catch (error) {
        alert(`Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´: ${error.message}`);
    }
}

function handleConnectionChange(isOnline) {
    const indicator = document.getElementById('offline-indicator');
    if (indicator) indicator.classList.toggle('active', !isOnline);
}


// --- SECTION: Ø¢Ù¾Ø¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Real-time Ùˆ ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ---
function startRealtimeUpdates(interval = 3000) {
    if (state.pollingIntervalId) clearInterval(state.pollingIntervalId);

    state.pollingIntervalId = setInterval(async () => {
        if (state.currentChannelData && state.isTabActive && navigator.onLine) {
            try {
                // Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ Ø¢Ø¨Ø¬Ú©Øª Ú©Ø§Ù†Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¢Ù¾Ø¯ÛŒØª Ù†Ø§Ù…ØŒ Ø§Ø¹Ø¶Ø§ØŒ ÙˆØ¶Ø¹ÛŒØª ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯ Ùˆ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
                const updatedChannelData = await proxyRequest(`channels/${state.currentChannelData.channel_id}?limitToLast=50`);
                if (updatedChannelData) {
                    const newMessages = updatedChannelData.channel_messages ? Object.entries(updatedChannelData.channel_messages).map(([key, value]) => ({...value, id: key})) : [];
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
                    if (newMessages.length > state.messages.length) {
                        state.unreadMessages++;
                        document.title = `(${state.unreadMessages}) ${state.originalTitle}`;
                    }
                    
                    state.messages = newMessages;
                    state.currentChannelData = updatedChannelData; // Ø¢Ù¾Ø¯ÛŒØª Ú©Ù„ Ø¯Ø§Ø¯Ù‡ Ú©Ø§Ù†Ø§Ù„
                    
                    renderMessages(state.messages);
                    
                    // Ø¢Ù¾Ø¯ÛŒØª Ù‡Ø¯Ø± Ùˆ Ù†Ø´Ø§Ù†Ú¯Ø± ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯
                    document.getElementById('page-title').textContent = updatedChannelData.channel_name;
                    document.getElementById('member-count').textContent = `${updatedChannelData.members_count || 1} Ø¹Ø¶Ùˆ`;
                    document.getElementById('typing-indicator').classList.toggle('active', updatedChannelData.is_typing === true);
                }
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±:", error);
            }
        }
    }, interval);
}

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}
</script>

</body>
</html>
