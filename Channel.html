<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>کانال همیار</title>
    <style>
        /* --- استایل‌های پایه و متغیرها --- */
        :root {
            --background-color: #0D1117;
            --primary-color: #1E90FF;
            --secondary-color: #161B22;
            --secondary-hover: #2C2F33;
            --border-color: #30363d;
            --text-primary: #E4E6EB;
            --text-secondary: #8b949e;
            --message-out-bg: #1E90FF;
            --message-in-bg: #2C2F33;
            --danger-color: #ff4d4d;
        }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            user-select: none; -webkit-user-select: none;
        }
        .app-container {
            width: 100%; max-width: 420px; height: 100%; margin: 0 auto;
            background-color: var(--background-color);
            display: flex; flex-direction: column; box-shadow: 0 0 25px rgba(0,0,0,0.2);
        }

        /* --- هدر صفحه --- */
        .app-header {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background-color: var(--secondary-color); flex-shrink: 0;
        }
        .app-header h1 { font-size: 1.3em; margin: 0; flex-grow: 1; text-align: center; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-btn { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; }
        .header-btn#edit-channel-btn { display: none; } /* دکمه ویرایش در ابتدا مخفی است */

        /* --- بخش اصلی محتوا --- */
        main { flex-grow: 1; position: relative; overflow-y: auto; }

        /* --- فرم ساخت کانال --- */
        .creation-form-container { padding: 30px 25px; display: flex; flex-direction: column; gap: 20px; }
        .form-title { font-size: 1.8em; font-weight: 700; color: var(--primary-color); text-align: center; margin-bottom: 15px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; }
        .input-group input, .input-group textarea {
            background-color: var(--secondary-color); border: 1px solid var(--border-color); border-radius: 10px;
            padding: 12px 15px; color: var(--text-primary); font-family: 'Vazirmatn', sans-serif; font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.2); }
        .input-group textarea { resize: vertical; min-height: 100px; }
        .create-btn {
            background-color: var(--primary-color); color: white; border: none; border-radius: 12px; padding: 14px;
            font-size: 1.1em; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; margin-top: 20px; transition: background-color 0.3s, transform 0.2s;
        }
        .create-btn:hover { background-color: #1a7bde; transform: translateY(-2px); }
        .create-btn:disabled { background-color: var(--secondary-hover); cursor: not-allowed; }
        
        /* --- صفحه چت کانال --- */
        .channel-chat-container { display: flex; flex-direction: column; height: 100%; }
        .message-feed { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message-bubble { max-width: 80%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; font-size: 0.95em; word-wrap: break-word; line-height: 1.5; }
        .message-bubble.out { background-color: var(--message-out-bg); color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
        .message-bubble.in { background-color: var(--message-in-bg); border-bottom-left-radius: 4px; align-self: flex-start; }
        .message-sender { font-size: 0.8em; font-weight: 500; color: var(--primary-color); margin-bottom: 4px; }
        .channel-info-bar { padding: 10px 15px; text-align: center; color: var(--text-secondary); font-size: 0.9em; background-color: var(--secondary-color); flex-shrink: 0;}

        /* --- بخش ورودی پیام --- */
        .message-input-area { display: flex; align-items: center; padding: 10px 15px; border-top: 1px solid var(--border-color); background-color: var(--secondary-color); flex-shrink: 0; }
        .message-input-area input { flex-grow: 1; background-color: var(--secondary-hover); border: none; border-radius: 20px; padding: 10px 18px; color: var(--text-primary); font-family: 'Vazirmatn', sans-serif; font-size: 1em; }
        .message-input-area input:focus { outline: none; }
        .send-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 0 15px; display: flex; align-items: center; justify-content: center; }
        
        /* --- وضعیت‌ها و لودینگ --- */
        .status-container { display: flex; justify-content: center; align-items: center; height: 100%; flex-direction: column; color: var(--text-secondary); padding: 20px; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--secondary-hover); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- مودال ویرایش کانال --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--secondary-color); padding: 25px; border-radius: 15px;
            width: 90%; max-width: 350px; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-title { margin-top: 0; font-size: 1.5em; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex-grow: 1; padding: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
        .save-btn { background-color: var(--primary-color); color: white; }
        .cancel-btn { background-color: var(--secondary-hover); color: var(--text-primary); }
    </style>
</head>
<body>

<div class="app-container">
    <!-- هدر صفحه -->
    <header class="app-header">
        <button class="header-btn" onclick="window.history.back()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        </button>
        <h1 id="page-title">همیار</h1>
        <button class="header-btn" id="edit-channel-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </button>
    </header>

    <!-- محتوای اصلی -->
    <main id="main-content">
        <!-- در ابتدا لودینگ نمایش داده می‌شود -->
    </main>
</div>

<!-- مودال ویرایش نام کانال -->
<div class="modal-overlay" id="edit-modal">
    <div class="modal-content">
        <h2 class="modal-title">ویرایش نام کانال</h2>
        <div class="input-group">
            <label for="edit-channel-name">نام جدید کانال</label>
            <input type="text" id="edit-channel-name" placeholder="نام جدید را وارد کنید">
        </div>
        <div class="modal-actions">
            <button class="modal-btn cancel-btn" id="cancel-edit-btn">انصراف</button>
            <button class="modal-btn save-btn" id="save-edit-btn">ذخیره</button>
        </div>
    </div>
</div>

<script>
    // --- SECTION: پیکربندی و متغیرهای اصلی ---
    const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
    const SHARED_SECRET = 'miko1234';

    // --- SECTION: ارجاع به المان‌های DOM ---
    const mainContent = document.getElementById('main-content');
    const pageTitle = document.getElementById('page-title');
    const editChannelBtn = document.getElementById('edit-channel-btn');
    const editModal = document.getElementById('edit-modal');
    const editChannelNameInput = document.getElementById('edit-channel-name');
    const saveEditBtn = document.getElementById('save-edit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    
    // --- SECTION: وضعیت برنامه ---
    let currentUser = null;
    let clientToken = null;
    let currentChannelData = null;
    let isChannelCreator = false;
    let pollingIntervalId = null;

    // --- SECTION: راه‌اندازی اولیه ---
    document.addEventListener('DOMContentLoaded', async () => {
        renderLoadingSpinner();
        
        const storedUser = localStorage.getItem('currentUser');
        if (!storedUser) {
            renderErrorMessage('خطای احراز هویت. لطفاً ابتدا وارد شوید.');
            return;
        }
        currentUser = JSON.parse(storedUser);

        try {
            await refreshClientToken();
        } catch (error) {
            renderErrorMessage(error.message);
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const channelIdFromUrl = urlParams.get('id');

        if (channelIdFromUrl) {
            await loadChannelData(channelIdFromUrl);
        } else {
            await findUserChannelAndLoad();
        }

        editChannelBtn.addEventListener('click', () => editModal.classList.add('active'));
        cancelEditBtn.addEventListener('click', () => editModal.classList.remove('active'));
        saveEditBtn.addEventListener('click', handleSaveChanges);
    });
    
    // --- SECTION: توابع ارتباط با سرور پراکسی ---
    async function refreshClientToken() {
        const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
        if (!response.ok) throw new Error('امکان دریافت توکن امنیتی وجود ندارد.');
        const data = await response.json();
        clientToken = data.token;
    }

    async function proxyRequest(path, method = 'GET', data = null) {
        if (!clientToken || !currentUser) throw new Error('کاربر احراز هویت نشده است.');
        
        const options = {
            method: method,
            headers: {
                'Authorization': `Bearer ${clientToken}`,
                'X-User-Username': currentUser.username
            }
        };

        if (data) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(data);
        }

        const response = await fetch(`${PROXY_URL}?path=${path}`, options);
        
        if (!response.ok) {
            if (response.status === 404) return null;
            const errorData = await response.json().catch(() => ({ error: 'خطای ناشناخته' }));
            throw new Error(errorData.error || `خطا در ارتباط با سرور (کد: ${response.status})`);
        }
        
        // برای متد DELETE یا پاسخ‌های بدون محتوا، جیسان وجود ندارد
        if (response.status === 204 || response.headers.get("content-length") === "0") {
            return null;
        }
        
        return response.json();
    }


    // --- SECTION: منطق اصلی بارگذاری و نمایش ---
    async function findUserChannelAndLoad() {
        try {
            const allChannels = await proxyRequest('channels');
            let userChannel = null;
            if (allChannels) {
                userChannel = Object.values(allChannels).find(ch => ch && ch.creator_username === currentUser.username);
            }

            if (userChannel) {
                window.history.replaceState({}, '', `?id=${userChannel.channel_id}`);
                await loadChannelData(userChannel.channel_id);
            } else {
                renderCreationForm();
            }
        } catch (error) {
            renderErrorMessage(error.message);
        }
    }

    async function loadChannelData(channelId) {
        try {
            const channelData = await proxyRequest(`channels/${channelId}`);
            if (channelData) {
                currentChannelData = channelData;
                isChannelCreator = channelData.creator_username === currentUser.username;
                renderChannelView();
                // channel_messages ممکن است وجود نداشته باشد
                const messages = channelData.channel_messages || null;
                renderMessages(messages);
                startRealtimeUpdates();
            } else {
                renderErrorMessage('کانال مورد نظر یافت نشد.', true);
            }
        } catch (error) {
            renderErrorMessage(error.message);
        }
    }

    // --- SECTION: توابع رندر کردن (نمایش) بخش‌های مختلف UI ---
    function renderLoadingSpinner() {
        mainContent.innerHTML = `<div class="status-container"><div class="spinner"></div><p>در حال بارگذاری...</p></div>`;
    }

    function renderErrorMessage(message, showCreateButton = false) {
        const buttonHtml = showCreateButton ? `<br><button class="create-btn" onclick="location.href='channel.html'">ساخت کانال جدید</button>` : '';
        mainContent.innerHTML = `<div class="status-container"><p>${message}</p>${buttonHtml}</div>`;
    }

    function renderCreationForm() {
        pageTitle.textContent = 'ایجاد کانال جدید';
        editChannelBtn.style.display = 'none';
        mainContent.innerHTML = `
            <div id="creation-form-view">
                <div class="creation-form-container">
                    <h2 class="form-title">مشخصات کانال</h2>
                    <div class="input-group"><label for="channel-name">نام کانال</label><input type="text" id="channel-name" placeholder="مثال: گروه برنامه‌نویسان"></div>
                    <div class="input-group"><label for="channel-id">شناسه کانال (ID)</label><input type="text" id="channel-id" placeholder="فقط حروف انگلیسی و خط تیره (-)"></div>
                    <div class="input-group"><label for="channel-desc">توضیحات</label><textarea id="channel-desc" placeholder="درباره کانال خود توضیح دهید..."></textarea></div>
                    <button class="create-btn" id="create-channel-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        <span>ایجاد کانال</span>
                    </button>
                </div>
            </div>`;
        document.getElementById('create-channel-btn').addEventListener('click', handleCreateChannel);
    }

    function renderChannelView() {
        pageTitle.textContent = currentChannelData.channel_name;
        editChannelBtn.style.display = isChannelCreator ? 'block' : 'none';
        mainContent.innerHTML = `
            <div class="channel-chat-container">
                <div class="message-feed" id="message-feed"></div>
                <div class="channel-info-bar">${currentChannelData.description || 'توضیحات کانال'}</div>
                ${isChannelCreator ? `
                <div class="message-input-area">
                    <input type="text" id="message-input" placeholder="پیام خود را بنویسید...">
                    <button class="send-btn" id="send-message-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>` : ''}
            </div>`;
        if (isChannelCreator) {
            document.getElementById('send-message-btn').addEventListener('click', handleSendMessage);
            document.getElementById('message-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSendMessage(); });
        }
    }

    function renderMessages(messagesData) {
        const messageFeed = document.getElementById('message-feed');
        if (!messageFeed) return;

        if (!messagesData || Object.keys(messagesData).length === 0) {
            messageFeed.innerHTML = '<div class="status-container" style="height: auto; padding: 50px 0;"><p>هنوز پیامی در این کانال نیست.</p></div>';
            return;
        }

        const messages = Object.values(messagesData).sort((a, b) => {
            const timeA = a && a.timestamp ? new Date(a.timestamp).getTime() : 0;
            const timeB = b && b.timestamp ? new Date(b.timestamp).getTime() : 0;
            return timeB - timeA;
        });
        
        let html = '';
        messages.forEach(msg => {
            if (!msg || typeof msg !== 'object') return;

            const sender = msg.sender_username || 'کاربر';
            const text = msg.message_text || '(پیام نامعتبر)';

            const messageClass = sender === currentUser.username ? 'out' : 'in';
            const senderNameHtml = sender !== currentUser.username ? `<div class="message-sender">${sender}</div>` : '';
            
            html += `<div class="message-bubble ${messageClass}">${senderNameHtml}${text.replace(/\n/g, '<br>')}</div>`;
        });
        messageFeed.innerHTML = html;
    }

    // --- SECTION: مدیریت رویدادها (Event Handlers) ---
    async function handleCreateChannel(event) {
        const createBtn = event.currentTarget;
        const name = document.getElementById('channel-name').value.trim();
        const id = document.getElementById('channel-id').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
        const desc = document.getElementById('channel-desc').value.trim();

        if (!name || !id) {
            alert('نام کانال و شناسه الزامی هستند.');
            return;
        }

        createBtn.disabled = true;
        createBtn.innerHTML = `<span>در حال ایجاد...</span>`;

        const newChannelData = {
            channel_name: name, channel_id: id, description: desc,
            creator_username: currentUser.username, created_at: new Date().toISOString()
        };

        try {
            // برای ایجاد از متد PUT استفاده می‌کنیم چون شناسه را خودمان تعیین کرده‌ایم
            await proxyRequest(`channels/${id}`, 'POST', newChannelData); // پراکسی این POST را به PUT تبدیل می‌کند
            currentChannelData = newChannelData;
            isChannelCreator = true;
            window.history.pushState({}, name, `?id=${id}`);
            renderChannelView();
            renderMessages(null);
            startRealtimeUpdates();
        } catch (error) {
            alert(`خطا در ساخت کانال: ${error.message}`);
            createBtn.disabled = false;
            createBtn.innerHTML = `<span>ایجاد کانال</span>`;
        }
    }

    // [ تابع اصلاح شده اصلی ]
    async function handleSendMessage() {
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-message-btn');
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        messageInput.disabled = true;
        sendBtn.disabled = true;
        
        const messageData = {
            sender_username: currentUser.username,
            message_text: messageText,
            timestamp: new Date().toISOString()
        };

        try {
            // **تغییر اصلی:** به جای ارسال به یک شناسه موقت، به کلکسیون پیام‌ها POST می‌کنیم
            // فایربیس خودش شناسه منحصر به فرد را ایجاد می‌کند.
            const path = `channels/${currentChannelData.channel_id}/channel_messages`;
            await proxyRequest(path, 'POST', messageData);
            
            messageInput.value = ''; // پاک کردن ورودی پس از ارسال موفق
            
            // برای نمایش فوری پیام، لیست پیام‌ها را مجددا دریافت می‌کنیم
            const updatedMessages = await proxyRequest(path);
            renderMessages(updatedMessages);

        } catch (error) {
            alert('ارسال پیام با خطا مواجه شد: ' + error.message);
        } finally {
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }
    }

    async function handleSaveChanges() {
        const newName = editChannelNameInput.value.trim();
        if (!newName || newName === currentChannelData.channel_name) {
            editModal.classList.remove('active');
            return;
        }

        saveEditBtn.disabled = true;
        saveEditBtn.textContent = 'در حال ذخیره...';

        try {
            // برای ویرایش یک فیلد خاص، از PUT استفاده می‌کنیم
            await proxyRequest(`channels/${currentChannelData.channel_id}/channel_name`, 'POST', newName); // پراکسی POST را به PUT تبدیل می‌کند
            currentChannelData.channel_name = newName;
            pageTitle.textContent = newName;
            editModal.classList.remove('active');
        } catch (error)
        {
            alert(`خطا در ویرایش نام کانال: ${error.message}`);
        } finally {
            saveEditBtn.disabled = false;
            saveEditBtn.textContent = 'ذخیره';
        }
    }
    
    // --- SECTION: آپدیت‌های Real-time (با Polling) ---
    function startRealtimeUpdates(interval = 4000) { // کاهش فاصله زمانی برای واکنش سریع‌تر
        if (pollingIntervalId) clearInterval(pollingIntervalId);

        pollingIntervalId = setInterval(async () => {
            if (currentChannelData && document.visibilityState === 'visible') {
                try {
                    const messages = await proxyRequest(`channels/${currentChannelData.channel_id}/channel_messages`);
                    renderMessages(messages);
                } catch (error) {
                    console.error("خطا در به‌روزرسانی خودکار:", error);
                    // می‌توان در اینجا polling را متوقف کرد اگر خطای دائمی رخ دهد
                    // clearInterval(pollingIntervalId);
                }
            }
        }, interval);
    }
</script>

</body>
</html>
