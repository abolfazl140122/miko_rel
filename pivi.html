<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت شخصی - همیار</title>
    <!-- استفاده کامل از استایل‌های صفحه اصلی برای یکپارچگی ظاهری -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --danger-color: #e74c3c; --light-gray-color: #f8f9fa; --border-color: #dee2e6; --sent-bg: #e1f5fe; --received-bg: #f1f3f5; }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; margin: 0; background-color: var(--light-gray-color); color: #333; -webkit-user-select: none; user-select: none; overflow: hidden; }

        .app-container { width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background-color: white; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        /* Header اختصاصی برای چت */
        .chat-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .chat-header .back-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #555; }
        .chat-header .partner-info { display: flex; align-items: center; cursor: pointer; }
        .chat-header .partner-info img { width: 40px; height: 40px; border-radius: 50%; margin-left: 10px; }
        .chat-header .partner-info h2 { font-size: 1.2em; margin: 0; }
        .chat-header .options-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #555; }

        /* Main Content Area */
        main { flex-grow: 1; position: relative; overflow-y: auto; display: flex; flex-direction: column-reverse; padding: 10px; }
        #messages-area { display: flex; flex-direction: column; gap: 8px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 18px; word-wrap: break-word; position: relative; }
        .message.sent { background-color: var(--sent-bg); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message.received { background-color: var(--received-bg); align-self: flex-end; border-bottom-right-radius: 4px; }
        .message .timestamp { font-size: 0.7em; color: #888; margin-top: 5px; text-align: left; }
        .message.deleted .text { font-style: italic; color: #999; }
        .message .edited-indicator { font-size: 0.7em; color: #888; margin-right: 5px; }

        /* Message Form */
        #message-form { display: flex; padding: 10px; border-top: 1px solid var(--border-color); background: white; }
        #message-form input { flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 20px; font-family: 'Vazirmatn'; }
        #message-form button { background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-right: 10px; font-size: 1.5em; cursor: pointer; flex-shrink: 0; }
        
        /* Modal and Context Menu Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 350px; }
        .modal-content h3 { margin-top: 0; }
        .modal-content button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--light-gray-color); cursor: pointer; font-family: 'Vazirmatn'; }
        .modal-content button.danger { border-color: var(--danger-color); color: var(--danger-color); }
        .modal-content #edit-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="chat-header">
            <button class="back-btn" onclick="history.back()">➡️</button>
            <div class="partner-info" id="partner-info">
                <img id="partner-avatar" src="" alt="">
                <h2 id="partner-name">...</h2>
            </div>
            <button class="options-btn" id="options-btn">⋮</button>
        </header>

        <main>
            <div id="messages-area">
                <!-- Messages will be loaded here -->
            </div>
        </main>

        <form id="message-form">
            <input type="text" id="message-input" placeholder="پیام خود را بنویسید..." autocomplete="off">
            <button type="submit">⬆️</button>
        </form>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="options-modal">
        <div class="modal-content">
            <h3>گزینه‌ها</h3>
            <button id="view-profile-btn">مشاهده پروفایل</button>
            <button id="block-user-btn" class="danger">مسدود کردن کاربر</button>
            <button data-close>بستن</button>
        </div>
    </div>

    <div class="modal-overlay" id="profile-modal">
        <div class="modal-content">
            <h3 id="profile-modal-name">...</h3>
            <p>نام کاربری: <span id="profile-modal-username"></span></p>
            <p>شماره تلفن: <span id="profile-modal-phone"></span></p>
            <button data-close>بستن</button>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h3>ویرایش پیام</h3>
            <textarea id="edit-input" rows="4"></textarea>
            <button id="save-edit-btn">ذخیره</button>
            <button data-close>انصراف</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="context-menu-modal">
        <div class="modal-content">
            <h3>عملیات پیام</h3>
            <button id="context-edit-btn">ویرایش</button>
            <button id="context-delete-btn" class="danger">حذف</button>
            <button data-close>انصراف</button>
        </div>
    </div>


    <script>
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';

        // --- DOM Elements ---
        const partnerNameEl = document.getElementById('partner-name');
        const partnerAvatarEl = document.getElementById('partner-avatar');
        const messagesArea = document.getElementById('messages-area');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        
        // Modals & Buttons
        const optionsBtn = document.getElementById('options-btn');
        const optionsModal = document.getElementById('options-modal');
        const profileModal = document.getElementById('profile-modal');
        const editModal = document.getElementById('edit-modal');
        const contextMenuModal = document.getElementById('context-menu-modal');
        const viewProfileBtn = document.getElementById('view-profile-btn');
        const partnerInfo = document.getElementById('partner-info');
        const blockUserBtn = document.getElementById('block-user-btn');

        // --- App State ---
        let currentUser = null;
        let clientToken = null;
        let chatPartner = null;
        let chatId = null;
        let messagePollingInterval = null;
        let editingMessageId = null;
        let contextMessageId = null;

        // --- AUTH & INIT ---
        (async () => {
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(storedUser);

            const urlParams = new URLSearchParams(window.location.search);
            const partnerUsername = urlParams.get('with');
            if (!partnerUsername) {
                alert('کاربر مورد نظر مشخص نشده است.');
                history.back();
                return;
            }

            await initializeApp(partnerUsername);
        })();

        async function initializeApp(partnerUsername) {
            try {
                await refreshClientToken();
                await fetchPartnerData(partnerUsername);

                if (!chatPartner) {
                     alert('کاربر یافت نشد.');
                     history.back();
                     return;
                }
                
                // Generate a consistent chat ID
                chatId = [currentUser.username, chatPartner.username].sort().join('__');
                
                setupUI();
                setupEventListeners();
                
                await loadMessages();
                if (messagePollingInterval) clearInterval(messagePollingInterval);
                messagePollingInterval = setInterval(loadMessages, 3000); // Poll for new messages
                
            } catch (error) {
                console.error("Initialization Error:", error);
                alert(`خطا در بارگذاری چت: ${error.message}`);
            }
        }
        
        function setupUI() {
            partnerNameEl.textContent = chatPartner.displayName;
            partnerAvatarEl.src = `https://i.pravatar.cc/80?u=${chatPartner.username}`;
        }

        function setupEventListeners() {
            messageForm.addEventListener('submit', handleSendMessage);
            optionsBtn.addEventListener('click', () => optionsModal.style.display = 'flex');
            partnerInfo.addEventListener('click', showProfileModal);
            viewProfileBtn.addEventListener('click', () => {
                optionsModal.style.display = 'none';
                showProfileModal();
            });
            blockUserBtn.addEventListener('click', handleBlockUser);
            
            // Modal close listeners
            document.querySelectorAll('.modal-overlay [data-close]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.closest('.modal-overlay').style.display = 'none';
                });
            });

            // Message context menu listeners
            document.getElementById('context-edit-btn').addEventListener('click', handleEditMessage);
            document.getElementById('context-delete-btn').addEventListener('click', handleDeleteMessage);
            document.getElementById('save-edit-btn').addEventListener('click', saveEditedMessage);
        }

        // --- DATA FETCHING ---
        async function refreshClientToken() {
            const response = await fetch(`${PROXY_URL}?auth=token`, { headers: { 'X-Proxy-Secret': SHARED_SECRET } });
            if (!response.ok) throw new Error('خطا در دریافت توکن امنیتی.');
            clientToken = (await response.json()).token;
        }

        async function fetchPartnerData(username) {
             const response = await fetch(`${PROXY_URL}?path=users&orderBy="username"&equalTo="${username}"`, {
                headers: { 'Authorization': `Bearer ${clientToken}` }
            });
            if (!response.ok) throw new Error('خطا در واکشی اطلاعات کاربر.');
            const data = await response.json();
            if (data && Object.keys(data).length > 0) {
                 const key = Object.keys(data)[0];
                 chatPartner = data[key];
            }
        }

        // --- CORE CHAT LOGIC ---
        async function loadMessages() {
            if (!chatId) return;
            const response = await fetch(`${PROXY_URL}?path=pivi_chats/${chatId}/messages`, { headers: { 'Authorization': `Bearer ${clientToken}` } });
            const messagesData = await response.json();
            
            messagesArea.innerHTML = '';
            if (messagesData) {
                const sortedMessages = Object.entries(messagesData).sort((a, b) => new Date(a[1].timestamp) - new Date(b[1].timestamp));
                sortedMessages.forEach(([msgId, msg]) => {
                    renderMessage(msgId, msg);
                });
            }
        }

        function renderMessage(msgId, msg) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + (msg.senderId === currentUser.username ? 'sent' : 'received');
            msgDiv.dataset.id = msgId;

            let textContent = '';
            if (msg.deleted) {
                msgDiv.classList.add('deleted');
                textContent = 'این پیام حذف شده است';
            } else {
                textContent = msg.text;
            }

            const editedIndicator = msg.edited ? '<span class="edited-indicator">(ویرایش شده)</span>' : '';

            msgDiv.innerHTML = `
                <div class="text">${textContent}</div>
                <div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' })} ${editedIndicator}</div>
            `;
            
            // Add long-press/context-click event only for sent messages
            if (msg.senderId === currentUser.username && !msg.deleted) {
                msgDiv.addEventListener('click', (e) => {
                    e.preventDefault();
                    contextMessageId = msgId;
                    contextMenuModal.style.display = 'flex';
                });
            }
            messagesArea.appendChild(msgDiv);
        }

        async function handleSendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text || !chatPartner) return;
            
            const message = {
                senderId: currentUser.username,
                text: text,
                timestamp: new Date().toISOString(),
                edited: false,
                deleted: false
            };
            messageInput.value = '';

            // Create chat members if it's the first message
            await apiRequest(`pivi_chats/${chatId}/members`, 'PUT', {
                [currentUser.username]: true,
                [chatPartner.username]: true
            });

            // Send the message (POST creates a unique ID)
            await apiRequest(`pivi_chats/${chatId}/messages`, 'POST', message);
            await loadMessages();
        }

        // --- MESSAGE ACTIONS ---
        function handleEditMessage() {
            contextMenuModal.style.display = 'none';
            editingMessageId = contextMessageId;
            const messageDiv = document.querySelector(`.message[data-id="${editingMessageId}"] .text`);
            if (messageDiv) {
                document.getElementById('edit-input').value = messageDiv.textContent;
                editModal.style.display = 'flex';
            }
        }

        async function saveEditedMessage() {
            const newText = document.getElementById('edit-input').value.trim();
            if (!newText || !editingMessageId) return;

            const updateData = {
                text: newText,
                edited: true
            };
            
            await apiRequest(`pivi_chats/${chatId}/messages/${editingMessageId}`, 'PATCH', updateData);
            
            editModal.style.display = 'none';
            editingMessageId = null;
            await loadMessages();
        }

        async function handleDeleteMessage() {
            if (!contextMessageId) return;
            const confirmation = confirm('آیا از حذف این پیام مطمئن هستید؟ این عمل غیرقابل بازگشت است.');
            if (confirmation) {
                 // Soft delete: update the message instead of removing it
                const updateData = {
                    text: 'این پیام حذف شده است',
                    deleted: true
                };
                await apiRequest(`pivi_chats/${chatId}/messages/${contextMessageId}`, 'PATCH', updateData);
                contextMenuModal.style.display = 'none';
                contextMessageId = null;
                await loadMessages();
            }
        }

        // --- USER ACTIONS ---
        function showProfileModal() {
            document.getElementById('profile-modal-name').textContent = chatPartner.displayName;
            document.getElementById('profile-modal-username').textContent = chatPartner.username;
            document.getElementById('profile-modal-phone').textContent = chatPartner.phone;
            profileModal.style.display = 'flex';
        }

        async function handleBlockUser() {
            const confirmation = confirm(`آیا میخواهید ${chatPartner.displayName} را مسدود کنید؟ شما دیگر از این کاربر پیامی دریافت نخواهید کرد.`);
            if (confirmation) {
                await apiRequest(`users/${currentUser.username}/blockedUsers/${chatPartner.username}`, 'PUT', true);
                alert(`${chatPartner.displayName} مسدود شد.`);
                optionsModal.style.display = 'none';
                // You might want to disable the message input here
                messageInput.disabled = true;
                messageInput.placeholder = "شما این کاربر را مسدود کرده‌اید.";
            }
        }

        // --- API HELPER ---
        async function apiRequest(path, method, body) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` },
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${PROXY_URL}?path=${path}`, options);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'یک خطای ناشناخته رخ داد.');
            }
            return response.json();
        }

    </script>
</body>
</html>
