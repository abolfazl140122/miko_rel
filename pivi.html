<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>چت شخصی | پیام‌رسان همیار</title>

    <style>
        /* --- وارد کردن فونت وزیرمتن --- */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');

        /* --- متغیرهای اصلی تم دارک نئومورفیک --- */
        :root {
            --background-color: #0D1117; /* پس‌زمینه اصلی تاریک‌تر */
            --primary-color: #00A3FF; /* آبی نئون/اصلی */
            --secondary-color: #161B22; /* پس‌زمینه عناصر داخلی (کانتینر) */
            --tertiary-color: #2C2F33; /* رنگ تیره‌تر برای مدال‌ها و سایه‌های داخلی */
            --message-sent-bg: #0077c2; /* گرادیان برای پیام‌های ارسالی */
            --message-received-bg: #2C2F33; /* پیام‌های دریافتی */
            --border-color: #30363d;
            --text-primary: #E4E6EB;
            --text-secondary: #8b949e;
            --online-indicator: #00ff88; /* سبز نئون */
            --typing-indicator: #AAAAAA;
            --error-color: #FF4D4D;
            
            /* سایه‌های نئومورفیک */
            --shadow-soft-dark: 5px 5px 10px rgba(0, 0, 0, 0.5), -5px -5px 10px rgba(35, 39, 47, 0.3);
            --shadow-input-inset: inset 2px 2px 5px rgba(0, 0, 0, 0.7), inset -2px -2px 5px rgba(35, 39, 47, 0.2);
            --shadow-btn-hover: 0 0 15px rgba(0, 163, 255, 0.6);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* پس‌زمینه گرادیانی برای عمق */
            background: radial-gradient(circle at top left, #1a202c 0%, var(--background-color) 70%);
        }

        /* --- کانتینر اصلی اپلیکیشن --- */
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            margin: 0 auto;
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
            position: relative;
            border-radius: 20px; 
            overflow: hidden;
        }

        /* --- ۱. هدر چت (نوار بالایی) --- */
        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            background: linear-gradient(to right, #161B22, #0D1117); /* گرادیان ملایم */
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .header-btn:hover {
            background-color: var(--tertiary-color);
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .header-btn svg {
            width: 24px;
            height: 24px;
        }

        .partner-info {
            flex-grow: 1;
            display: flex;
            align-items: center;
            margin-right: 15px;
            cursor: pointer;
        }

        .partner-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-left: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 8px rgba(0, 163, 255, 0.5);
            position: relative;
        }

        .online-status {
            width: 12px;
            height: 12px;
            background-color: var(--online-indicator);
            border: 2px solid var(--secondary-color);
            border-radius: 50%;
            position: absolute;
            bottom: 0;
            right: 0;
            box-shadow: 0 0 5px var(--online-indicator);
        }

        .partner-details h2 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 700;
        }

        .partner-details p {
            margin: 0;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        /* --- ۲. لیست پیام‌ها --- */
        #messages-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 15px;
            /* اسکرول بار سفارشی */
            scroll-behavior: smooth;
        }

        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-track {
            background: var(--secondary-color);
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 2px solid var(--secondary-color);
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 15px;
            /* انیمیشن برای پیام‌های جدید */
            opacity: 0;
            animation: fadeInMessage 0.3s ease-out forwards;
        }

        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            padding: 12px 18px;
            border-radius: 20px; /* گردتر از قبل */
            max-width: 80%;
            position: relative;
            word-wrap: break-word;
            font-size: 0.95em;
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4); /* سایه عمیق‌تر */
        }

        .message-sent {
            justify-content: flex-start; /* در RTL، پیام‌های ارسالی سمت چپ می‌آیند */
        }
        .message-sent .message-content {
            background: linear-gradient(145deg, var(--primary-color), var(--message-sent-bg));
            color: white;
            border-bottom-left-radius: 4px; /* لبه پایینی نزدیک به سمت خودی، تیزتر */
            box-shadow: var(--shadow-soft-dark);
        }
        
        .message-received {
            justify-content: flex-end; /* در RTL، پیام‌های دریافتی سمت راست می‌آیند */
        }
        .message-received .message-content {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            border-bottom-right-radius: 4px; /* لبه پایینی نزدیک به سمت خودی، تیزتر */
            box-shadow: var(--shadow-soft-dark);
        }

        .message-timestamp {
            position: absolute;
            bottom: 4px;
            left: 10px;
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.6);
            direction: ltr;
        }
        .message-received .message-timestamp {
            color: var(--text-secondary);
        }
        
        .message-status {
            margin-right: 5px;
            margin-top: 10px;
        }
        .message-status svg {
            width: 14px;
            height: 14px;
            color: var(--text-secondary); 
        }
        .message-status.read svg {
            color: #00ff88; /* رنگ نئون برای خوانده شده */
            filter: drop-shadow(0 0 3px rgba(0, 255, 136, 0.5));
        }

        /* --- ۳. نوار ورودی پیام --- */
        .input-area {
            flex-shrink: 0;
            padding: 10px 15px;
            background-color: var(--secondary-color);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            position: relative;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.4);
        }

        #message-input {
            flex-grow: 1;
            background-color: var(--tertiary-color);
            color: var(--text-primary);
            border: none;
            padding: 12px 15px;
            margin-left: 10px;
            border-radius: 25px; /* گوشه‌های کاملاً گرد */
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1em;
            outline: none;
            resize: none;
            min-height: 48px;
            max-height: 150px; 
            overflow-y: auto;
            box-shadow: var(--shadow-input-inset); /* سایه داخلی برای عمق */
            transition: all 0.2s ease;
        }
        
        #message-input:focus {
            background-color: #25282d;
            box-shadow: var(--shadow-input-inset), 0 0 0 2px var(--primary-color);
        }

        #send-btn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), #004d7e);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 163, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.7), var(--shadow-btn-hover);
        }
        #send-btn:active {
            transform: scale(0.95);
        }

        #send-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* --- نمایش وضعیت تایپ --- */
        #typing-indicator {
            position: absolute;
            top: -30px;
            right: 15px;
            background-color: var(--message-received-bg);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            color: var(--typing-indicator);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
            opacity: 0;
            display: flex;
            align-items: center;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: var(--typing-indicator);
            border-radius: 50%;
            margin-right: 4px;
            animation: pulseDot 1s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulseDot {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.5); opacity: 1; }
        }

        /* --- ۴. استایل مدال‌های سفارشی (Custom Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeInModal 0.3s ease-out;
        }
        
        .modal-content {
            background: var(--tertiary-color); 
            color: var(--text-primary);
            padding: 30px; 
            border-radius: 15px; 
            text-align: center;
            max-width: 320px; 
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8), 0 0 15px rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            transform: scale(0.9);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 
            0% { transform: scale(0.3); opacity: 0; } 
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }

        .modal-content p {
            margin-bottom: 20px; 
            font-size: 1.1em;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-color);
            color: var(--text-primary);
            font-family: inherit;
            outline: none;
            box-shadow: var(--shadow-input-inset);
        }

        .modal-buttons {
            display: flex; 
            justify-content: space-around;
        }

        .modal-btn {
            background: var(--primary-color); 
            color: white; 
            border: none;
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-family: inherit;
            transition: all 0.2s;
            font-weight: 500;
            box-shadow: 0 3px 10px rgba(0, 163, 255, 0.3);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 163, 255, 0.5);
        }

        .cancel-btn {
            background: var(--secondary-hover); 
            color: var(--text-primary);
            box-shadow: none;
        }

        .cancel-btn:hover {
            background-color: #3f454f;
            transform: translateY(-2px);
        }
        
        .delete-btn {
            background: var(--error-color);
            box-shadow: 0 3px 10px rgba(255, 77, 77, 0.3);
        }
        .delete-btn:hover {
            box-shadow: 0 5px 15px rgba(255, 77, 77, 0.5);
        }
        
        /* --- ۵. استایل صفحه لودینگ/خطا --- */
        .status-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 50px; 
            height: 50px;
            border: 5px solid var(--tertiary-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite; 
            box-shadow: 0 0 10px rgba(0, 163, 255, 0.5);
        }
        .status-container p {
            margin-top: 20px;
            font-size: 1.1em;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="app-container">

        <!-- ۱. هدر چت -->
        <header class="chat-header">
            <!-- دکمه بازگشت -->
            <button class="header-btn" id="back-btn" title="بازگشت به لیست چت‌ها">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>

            <!-- اطلاعات کاربر طرف مقابل -->
            <div class="partner-info" id="partner-info-link">
                <div class="partner-avatar">
                    <img id="partner-avatar-img" src="" alt="Avatar" onerror="this.onerror=null; this.src='https://placehold.co/100x100/161B22/E4E6EB?text=U'">
                    <!-- دایره وضعیت آنلاین (اختیاری) -->
                    <div id="online-status" class="online-status" style="display: none;"></div>
                </div>
                <div class="partner-details">
                    <h2 id="partner-display-name"></h2>
                    <p id="partner-username-info">آفلاین</p>
                </div>
            </div>

            <!-- دکمه‌های اکشن (مثلاً تماس یا منو) -->
            <div>
                 <button class="header-btn" id="call-btn" title="شروع تماس صوتی">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 3.08 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                </button>
                <button class="header-btn" id="menu-btn" title="گزینه‌ها">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
                </button>
            </div>
        </header>

        <!-- ۲. کانتینر پیام‌ها -->
        <div id="messages-container">
            <!-- پیام‌ها به صورت پویا اینجا اضافه خواهند شد -->
            <div class="status-container" id="initial-loading-status">
                <div class="spinner"></div>
                <p>در حال بارگذاری گفتگو...</p>
            </div>
        </div>
        
        <!-- وضعیت تایپ کردن -->
        <div id="typing-indicator">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span id="typing-user-name"></span> در حال تایپ...
        </div>

        <!-- ۳. نوار ورودی پیام -->
        <div class="input-area">
            <textarea id="message-input" placeholder="پیام خود را بنویسید..." rows="1"></textarea>
            <button id="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
    </div>

    <!-- ۴. مدال سفارشی برای هشدار، تایید و پرامپت -->
    <div id="custom-dialog-overlay" class="modal-overlay">
        <div class="modal-content">
            <p id="dialog-message"></p>
            <input type="text" id="dialog-input" class="modal-input" style="display: none;" placeholder="پاسخ...">
            <div class="modal-buttons">
                <button id="dialog-cancel-btn" class="modal-btn cancel-btn">انصراف</button>
                <button id="dialog-confirm-btn" class="modal-btn">تأیید</button>
            </div>
        </div>
    </div>

    <script>
        // --- بخش ۱: پیکربندی و متغیرهای سراسری ---
        const PROXY_URL = 'https://miko.freehost.io/firebase_proxy.php';
        const SHARED_SECRET = 'miko1234';
        const VERIFIED_TICK_URL = 'https://up.20script.ir/file/edfa-tickpng-parspng-com-4.png';
        const MESSAGE_POLLING_INTERVAL = 3000; 

        // عناصر DOM
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const partnerDisplayNameEl = document.getElementById('partner-display-name');
        const partnerUsernameInfoEl = document.getElementById('partner-username-info');
        const partnerAvatarImg = document.getElementById('partner-avatar-img');
        const onlineStatusEl = document.getElementById('online-status');
        const backBtn = document.getElementById('back-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const typingUserNameEl = document.getElementById('typing-user-name');
        const partnerInfoLink = document.getElementById('partner-info-link');
        
        // وضعیت اپلیکیشن
        let currentUser = null;
        let partnerUsername = null;
        let clientToken = null;
        let conversationId = null;
        let messages = [];
        let pollingIntervalId = null; 
        let lastMessageTimestamp = 0; // برای واکشی پیام‌های جدید
        let partnerData = {}; // اطلاعات کاربر مقابل

        // --- بخش ۲: توابع کمکی عمومی ---
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function scrollToBottom(container, smooth = false) {
            if (smooth) {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            } else {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        }
        
        // --- بخش ۳: رویدادهای ورودی پیام (Auto-Resize & Send) ---
        function handleInput() {
            messageInput.style.height = 'auto'; // Reset height
            messageInput.style.height = messageInput.scrollHeight + 'px'; // Set new height
            // نمایش/عدم نمایش دکمه ارسال
            sendBtn.disabled = messageInput.value.trim() === '';
        }

        async function handleSend() {
            const text = messageInput.value.trim();
            if (!text || !conversationId) return;

            // ساخت شی پیام
            const newMessage = {
                sender: currentUser.username,
                text: text,
                timestamp: Date.now(),
                status: 'sent' // وضعیت اولیه
            };

            messages.push(newMessage);
            appendMessage(newMessage); // نمایش فوری پیام
            messageInput.value = ''; // خالی کردن ورودی
            handleInput(); // بازنشانی ارتفاع ورودی
            scrollToBottom(messagesContainer, true);

            try {
                // ارسال به سرور
                await apiRequest(`pivi_chats/${conversationId}/messages`, 'POST', newMessage);
                // نیازی به به‌روزرسانی وضعیت نیست، پیام‌های جدید در پولینگ بعدی وضعیت read/delivered را خواهند گرفت

            } catch (error) {
                console.error("خطا در ارسال پیام:", error);
                await showCustomAlert({ title: 'خطا', message: 'پیام ارسال نشد! لطفاً دوباره تلاش کنید.' });
                // اگر ارسال ناموفق بود، وضعیت پیام را به failed تغییر دهید (این بخش پیاده‌سازی نشده اما ایده آن است)
            }
        }

        // --- بخش ۴: نمایش وضعیت‌ها ---
        function showLoading() {
            messagesContainer.innerHTML = `
                <div class="status-container" id="loading-status">
                    <div class="spinner"></div>
                    <p>در حال بارگذاری گفتگو...</p>
                </div>`;
        }

        function showError(message) {
            messagesContainer.innerHTML = `<div class="status-container"><p style="color: var(--error-color);">${message}</p></div>`;
        }
        
        function updatePartnerStatus(isOnline, isTyping) {
            if (!partnerData || !partnerData.username) return;

            const name = partnerData.displayName || partnerData.username;
            
            if (isTyping) {
                typingUserNameEl.textContent = name;
                typingIndicator.style.opacity = 1;
                typingIndicator.style.visibility = 'visible';
                partnerUsernameInfoEl.textContent = 'در حال تایپ...';
                onlineStatusEl.style.display = 'block'; // فرض می‌کنیم اگر تایپ می‌کند آنلاین است
            } else {
                typingIndicator.style.opacity = 0;
                typingIndicator.style.visibility = 'hidden';
                partnerUsernameInfoEl.textContent = isOnline ? 'آنلاین' : 'آخرین بازدید: اخیراً';
                onlineStatusEl.style.display = isOnline ? 'block' : 'none';
            }
        }


        // --- بخش ۵: رندر پیام‌ها ---
        function getMessageStatusIcon(status) {
            let svg = '';
            let className = '';

            switch(status) {
                case 'sent':
                    // تک تیک خاکستری (ارسال شده به سرور)
                    svg = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`;
                    className = '';
                    break;
                case 'delivered':
                    // دو تیک خاکستری (تحویل داده شده به گیرنده)
                    svg = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline><polyline points="15 6 9 12 18 3"></polyline></svg>`;
                    className = '';
                    break;
                case 'read':
                    // دو تیک آبی (خوانده شده توسط گیرنده)
                    svg = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline><polyline points="15 6 9 12 18 3"></polyline></svg>`;
                    className = 'read';
                    break;
                default:
                    return '';
            }
            return `<div class="message-status ${className}">${svg}</div>`;
        }

        function createMessageHtml(message) {
            const isSent = message.sender === currentUser.username;
            const statusHtml = isSent ? getMessageStatusIcon(message.status) : '';
            const timestampHtml = `<span class="message-timestamp">${formatTimestamp(message.timestamp)}</span>`;

            return `
                <div class="message-wrapper message-${isSent ? 'sent' : 'received'}">
                    <div class="message-content">
                        ${message.text}
                        ${timestampHtml}
                    </div>
                    ${statusHtml}
                </div>
            `;
        }

        function appendMessage(message) {
            const messageHtml = createMessageHtml(message);
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
        }

        function renderMessages() {
            messagesContainer.innerHTML = '';
            messages.forEach(appendMessage);
            scrollToBottom(messagesContainer);
        }

        // --- بخش ۶: تابع اصلی راه‌اندازی (Initialization) ---
        async function init() {
            showLoading();
            
            // ۱. احراز هویت کاربر و دریافت پارامترها
            const storedUser = localStorage.getItem('currentUser');
            if (!storedUser) {
                showError('خطای احراز هویت. در حال هدایت به صفحه ورود...');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }
            currentUser = JSON.parse(storedUser);
            partnerUsername = getQueryParam('uid');

            if (!partnerUsername) {
                showError('کاربر مقصد مشخص نشده است. بازگشت به صفحه اصلی...');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            try {
                // ۲. دریافت توکن
                await refreshClientToken();

                // ۳. دریافت اطلاعات کاربر مقابل
                partnerData = await apiRequest(`users/${partnerUsername}`, 'GET');
                if (!partnerData) throw new Error('کاربر مقابل یافت نشد.');
                
                // ۴. به‌روزرسانی هدر چت
                updateChatHeader(partnerData);
                
                // ۵. دریافت یا ایجاد مکالمه
                await fetchOrCreateConversation();

                // ۶. دریافت پیام‌ها
                await fetchMessages();
                
                renderMessages();

                // ۷. شروع پولینگ
                startRealtimePolling();

            } catch (error) {
                console.error("خطای راه‌اندازی:", error);
                showError(`خطا در بارگذاری چت: ${error.message}`);
            }
        }
        
        function updateChatHeader(data) {
            const displayName = data.displayName || data.username;
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=00A3FF&color=fff&size=100`;

            partnerDisplayNameEl.textContent = displayName;
            partnerAvatarImg.src = avatarUrl;
            partnerUsernameInfoEl.textContent = data.isOnline ? 'آنلاین' : 'آخرین بازدید: اخیراً';
            onlineStatusEl.style.display = data.isOnline ? 'block' : 'none';
        }

        // --- بخش ۷: مدیریت توکن و احراز هویت ---
        async function refreshClientToken() {
            const response = await fetch(`${PROXY_URL}?auth=token`, {
                headers: { 'X-Proxy-Secret': SHARED_SECRET }
            });
            if (!response.ok) throw new Error('امکان دریافت توکن امنیتی وجود ندارد.');
            const data = await response.json();
            clientToken = data.token;
        }

        // --- بخش ۸: مدیریت مکالمه (Conversation) ---
        async function fetchOrCreateConversation() {
            const chatPath = `pivi_chats/by_members?members=${currentUser.username},${partnerUsername}`;
            let chat = await apiRequest(chatPath, 'GET');
            
            if (chat && chat.id) {
                conversationId = chat.id;
            } else {
                // اگر مکالمه‌ای پیدا نشد، یک مکالمه جدید ایجاد کنید (در صورت پشتیبانی پروکسی)
                const newChat = {
                    members: { 
                        [currentUser.username]: true, 
                        [partnerUsername]: true 
                    },
                    lastMessage: null,
                    timestamp: Date.now()
                };
                const createdChat = await apiRequest('pivi_chats', 'POST', newChat);
                conversationId = createdChat.id;
                console.log('مکالمه جدید ایجاد شد:', conversationId);
            }
        }

        // --- بخش ۹: مدیریت پیام‌ها ---
        async function fetchMessages() {
            if (!conversationId) return;

            // واکشی تمام پیام‌های موجود
            const messagesPath = `pivi_chats/${conversationId}/messages`;
            const fetchedMessages = await apiRequest(messagesPath, 'GET');
            
            messages = Object.values(fetchedMessages || {}).sort((a, b) => a.timestamp - b.timestamp);
            if (messages.length > 0) {
                lastMessageTimestamp = messages[messages.length - 1].timestamp;
            }
        }

        // --- بخش ۱۰: پولینگ (Real-time Polling) ---
        async function checkForNewMessages() {
            if (!conversationId) return;

            try {
                // واکشی پیام‌های جدیدتر از آخرین پیام
                const path = `pivi_chats/${conversationId}/messages?since=${lastMessageTimestamp}`;
                const newMessages = await apiRequest(path, 'GET');

                const newMessagesArray = Object.values(newMessages || {})
                    .filter(msg => msg.timestamp > lastMessageTimestamp)
                    .sort((a, b) => a.timestamp - b.timestamp);

                if (newMessagesArray.length > 0) {
                    newMessagesArray.forEach(msg => {
                        messages.push(msg);
                        appendMessage(msg);
                    });
                    lastMessageTimestamp = messages[messages.length - 1].timestamp;
                    scrollToBottom(messagesContainer, true);
                    // به‌روزرسانی وضعیت پیام‌های کاربر مقابل به 'read'
                    // (این منطق باید توسط بک‌اند کنترل شود، اما برای دمو: )
                    
                }
                
                // به‌روزرسانی وضعیت آنلاین و تایپ
                const partnerStatus = await apiRequest(`users/${partnerUsername}`, 'GET');
                if (partnerStatus) {
                    partnerData = partnerStatus;
                    updatePartnerStatus(partnerStatus.isOnline, partnerStatus.isTyping);
                }

            } catch (error) {
                console.error("خطا در پولینگ پیام:", error.message);
                // معمولاً پولینگ را متوقف نمی‌کنیم مگر خطای جدی احراز هویت باشد
            }
        }

        function startRealtimePolling() {
            if (pollingIntervalId) clearInterval(pollingIntervalId);
            pollingIntervalId = setInterval(checkForNewMessages, MESSAGE_POLLING_INTERVAL);
        }
        
        // --- بخش ۱۱: مدال‌های سفارشی (جایگزین alert/confirm/prompt) ---
        const dialogOverlay = document.getElementById('custom-dialog-overlay');
        const dialogMessage = document.getElementById('dialog-message');
        const dialogInput = document.getElementById('dialog-input');
        const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
        const dialogCancelBtn = document.getElementById('dialog-cancel-btn');
        let dialogResolver = null;

        function showModal(el) {
            el.style.display = 'flex';
            // برای اطمینان از اعمال انیمیشن popIn
            setTimeout(() => el.querySelector('.modal-content').style.transform = 'scale(1)', 10);
        }

        function hideModal(el) {
            el.style.display = 'none';
        }

        function showCustomDialog({ title = 'توجه', message, prompt = false, alert = false, confirmText = 'تأیید', cancelText = 'انصراف' }) {
            return new Promise(resolve => {
                dialogResolver = resolve;
                dialogMessage.textContent = message;

                // حالت Prompt
                if (prompt) {
                    dialogInput.style.display = 'block';
                    dialogInput.value = '';
                    dialogConfirmBtn.textContent = confirmText;
                    dialogCancelBtn.style.display = 'block';
                    dialogCancelBtn.textContent = cancelText;
                } 
                // حالت Confirm
                else if (!alert) {
                    dialogInput.style.display = 'none';
                    dialogConfirmBtn.textContent = confirmText;
                    dialogCancelBtn.style.display = 'block';
                    dialogCancelBtn.textContent = cancelText;
                }
                // حالت Alert
                else {
                    dialogInput.style.display = 'none';
                    dialogConfirmBtn.textContent = confirmText;
                    dialogCancelBtn.style.display = 'none';
                }
                
                // استایل‌دهی دکمه حذف برای عملیات‌های خطرناک
                if (title.toLowerCase().includes('حذف') || title.toLowerCase().includes('خروج')) {
                    dialogConfirmBtn.classList.add('delete-btn');
                    dialogConfirmBtn.classList.remove('modal-btn');
                } else {
                     dialogConfirmBtn.classList.remove('delete-btn');
                     dialogConfirmBtn.classList.add('modal-btn');
                }

                showModal(dialogOverlay);
            });
        }

        dialogConfirmBtn.onclick = () => {
            if (dialogResolver) {
                // اگر حالت پرامپت بود، مقدار ورودی را برگردان
                const result = dialogInput.style.display === 'block' ? dialogInput.value : true;
                dialogResolver(result);
                dialogResolver = null;
            }
            hideModal(dialogOverlay);
        };

        dialogCancelBtn.onclick = () => {
            if (dialogResolver) {
                // اگر حالت پرامپت بود، null برگردان (کنترلر معمول پرامپت)
                dialogResolver(dialogInput.style.display === 'block' ? null : false);
                dialogResolver = null;
            }
            hideModal(dialogOverlay);
        };

        function showCustomConfirm(options) { return showCustomDialog({ ...options, prompt: false }); }
        function showCustomPrompt(options) { return showCustomDialog({ ...options, prompt: true }); }
        function showCustomAlert(options) { return showCustomDialog({ ...options, alert: true, confirmText: 'بسیار خب' }); }

        // --- بخش ۱۲: تابع کمکی برای ارسال درخواست‌های API ---
        async function apiRequest(path, method, body, keepalive = false) {
            const options = {
                method,
                headers: { 
                    'Content-Type': 'application/json', 'Authorization': `Bearer ${clientToken}` || '',
                    'X-User-Username': currentUser ? currentUser.username : 'anonymous'
                },
                keepalive
            };
            if (body !== undefined) options.body = JSON.stringify(body);
            
             if (method === 'DELETE') {
                options.body = JSON.stringify(null);
            }
            
            const response = await fetch(`${PROXY_URL}?path=${path}`, options);
            const responseText = await response.text();
            
            let responseData = {};
            try {
                responseData = JSON.parse(responseText);
            } catch (e) {
                 // اگر پاسخ JSON نبود (مثلاً خطای سرور)
                if (!response.ok) throw new Error(responseText || `یک خطای ${response.status} رخ داد.`);
                return {};
            }
            
            if (!response.ok) throw new Error(responseData.error || `یک خطای ${response.status} رخ داد.`);
            return responseData;
        }

        // --- بخش ۱۳: رویدادها ---
        backBtn.addEventListener('click', () => {
             // هنگام بازگشت، پولینگ متوقف شود
            if (pollingIntervalId) clearInterval(pollingIntervalId);
            window.location.href = 'index.html';
        });

        sendBtn.addEventListener('click', handleSend);
        messageInput.addEventListener('input', handleInput);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        // تنظیم اولیه ارتفاع ورودی و غیرفعال کردن دکمه ارسال
        handleInput(); 

        // شروع راه‌اندازی اپلیکیشن
        init();
    </script>
</body>
</html>
